<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransitStats</title>
    <style>
        :root {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8f9fa;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-color: #e5e5e5;
            --border-light: #f0f0f0;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-orange: #f59e0b;
            --accent-green: #10b981;
            --success-bg: #d1fae5;
            --success-text: #065f46;
            --warning-bg: #fef3c7;
            --warning-text: #92400e;
            --danger-bg: #fee2e2;
            --danger-text: #991b1b;
            --info-bg: #dbeafe;
            --info-text: #1e40af;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
            --card-shadow-lg: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
        }

        [data-theme="dark"] {
            --bg-primary: #111111;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border-color: #3f3f46;
            --border-light: #27272a;
            --accent-primary: #818cf8;
            --accent-secondary: #a78bfa;
            --accent-blue: #60a5fa;
            --accent-purple: #a78bfa;
            --accent-orange: #fbbf24;
            --accent-green: #34d399;
            --success-bg: #064e3b;
            --success-text: #6ee7b7;
            --warning-bg: #78350f;
            --warning-text: #fcd34d;
            --danger-bg: #7f1d1d;
            --danger-text: #fca5a5;
            --info-bg: #1e3a5f;
            --info-text: #93c5fd;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.2);
            --card-shadow-lg: 0 4px 6px rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-bottom: 70px;
        }
        .content-wrapper {
            flex: 1;
        }

        /* Simplified Header */
        .header {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title {
            font-size: 1.25em;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }
        .header-title .logo-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .user-info {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .header-btn {
            display: none;
        }
        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-toggle:hover {
            background: var(--border-light);
        }

        /* Bottom Tab Bar Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
            z-index: 1000;
        }
        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.7em;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 64px;
        }
        .nav-tab svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }
        .nav-tab.active {
            color: var(--accent-primary);
        }
        .nav-tab.active svg {
            stroke-width: 2;
        }

        .container {
            max-width: 100%;
            padding: 16px;
        }

        /* Card Styles */
        .card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--card-shadow);
        }
        .section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--card-shadow);
        }

        /* Welcome Section */
        .welcome-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .welcome-text {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 2px;
        }
        .welcome-name {
            font-size: 1.75em;
            font-weight: 700;
            color: var(--text-primary);
        }
        .streak-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--danger-bg);
            color: var(--danger-text);
            padding: 8px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        .streak-badge.active {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
        }

        /* Start Trip Card */
        .start-trip-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--card-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .start-trip-card:hover {
            box-shadow: var(--card-shadow-lg);
            transform: translateY(-1px);
        }
        .start-trip-info h3 {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .start-trip-info p {
            color: var(--text-muted);
            font-size: 0.9em;
        }
        .start-trip-btn {
            width: 48px;
            height: 48px;
            background: var(--accent-primary);
            border: none;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .start-trip-btn:hover {
            background: var(--accent-secondary);
            transform: scale(1.05);
        }
        .start-trip-btn svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        /* Quick Actions Grid */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        .quick-action-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--card-shadow);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .quick-action-card:hover {
            box-shadow: var(--card-shadow-lg);
            transform: translateY(-1px);
        }
        .quick-action-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .quick-action-icon.history {
            background: #fef3c7;
            color: #d97706;
        }
        .quick-action-icon.templates {
            background: #d1fae5;
            color: #059669;
        }
        .quick-action-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95em;
            margin-bottom: 2px;
        }
        .quick-action-subtitle {
            color: var(--text-muted);
            font-size: 0.8em;
        }

        /* Recent Trips Section */
        .section-header {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        /* Maps specific styles */
        #mapContainer {
            height: 400px;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-tertiary);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .map-controls {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .map-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 4px;
            align-self: center;
        }

        .toggle-btn {
            background: transparent;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .toggle-btn.active {
            background: var(--accent-primary);
            color: white;
        }

        .map-legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        /* Locked Heatmap State */
        .heatmap-locked {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }
        .heatmap-locked-icon {
            width: 80px;
            height: 80px;
            background: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        .heatmap-locked-icon svg {
            width: 40px;
            height: 40px;
            stroke: var(--text-muted);
            stroke-width: 1.5;
            fill: none;
        }
        .heatmap-locked h3 {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        .heatmap-locked p {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 24px;
            max-width: 280px;
        }
        .heatmap-progress-bar {
            width: 100%;
            max-width: 280px;
            height: 6px;
            background: var(--border-light);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .heatmap-progress-fill {
            height: 100%;
            background: var(--accent-primary);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .heatmap-progress-text {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.95em;
            margin-bottom: 8px;
        }
        .heatmap-progress-hint {
            color: var(--text-muted);
            font-size: 0.85em;
        }

        /* Progress bar for heatmap unlock */
        .heatmap-progress {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            text-align: center;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            height: 6px;
            margin: 12px 0 8px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: white;
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Hidden footer - replaced by bottom nav */
        .status-footer {
            display: none;
        }

        /* Active trip banner */
        .active-trip-banner {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            padding: 14px 18px;
            border-radius: 12px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 16px;
        }
        .active-trip-banner:hover {
            opacity: 0.95;
            transform: translateY(-1px);
        }

        .banner-container {
            display: none;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.85em;
        }
        .status-indicator.excellent { background: var(--success-bg); color: var(--success-text); }
        .status-indicator.good { background: var(--warning-bg); color: var(--warning-text); }
        .status-indicator.poor { background: var(--danger-bg); color: var(--danger-text); }
        .status-indicator.loading { background: var(--info-bg); color: var(--info-text); }
        .status-indicator.connected {
            background: var(--success-bg);
            color: var(--success-text);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .status-indicator.disconnected { background: var(--danger-bg); color: var(--danger-text); }

        .auth-section {
            text-align: center;
            padding: 60px 20px;
            max-width: 400px;
            margin: 0 auto;
        }
        .auth-section h2 {
            margin-bottom: 12px;
            color: var(--text-primary);
            font-size: 1.75em;
            font-weight: 700;
        }
        .auth-section p {
            margin-bottom: 24px;
            color: var(--text-secondary);
            font-size: 0.95em;
        }
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-primary);
        }
        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 1em;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .preview-box {
            margin-top: 8px;
            padding: 12px;
            border-radius: 10px;
            font-size: 0.85em;
            border: 1px solid transparent;
        }
        .preview-box.new { background: var(--success-bg); border-color: var(--accent-green); color: var(--success-text); }
        .preview-box.existing { background: var(--warning-bg); border-color: var(--accent-orange); color: var(--warning-text); }

        .btn {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 8px 0;
        }
        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }
        .btn-primary:hover {
            background: var(--accent-secondary);
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-outline {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        .btn-outline:hover {
            background: var(--bg-tertiary);
        }
        .btn-sm { padding: 10px 16px; font-size: 0.9em; width: auto; }

        .trip-status {
            background: var(--success-bg);
            border: 2px solid var(--accent-green);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            text-align: center;
        }
        .trip-item {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-primary);
            position: relative;
            transition: transform 0.2s ease;
            touch-action: pan-y;
        }
        .trip-item.swiping {
            transform: translateX(-80px);
        }
        .trip-item .delete-overlay {
            position: absolute;
            right: -80px;
            top: 0;
            bottom: 0;
            width: 80px;
            background: #ef4444;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
            border-radius: 0 12px 12px 0;
        }
        .empty-state {
            text-align: center;
            color: var(--text-muted);
            padding: 32px 20px;
            font-size: 0.95em;
        }
        .auth-status {
            background: var(--info-bg);
            border: 1px solid var(--accent-blue);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 0.9em;
            color: var(--info-text);
        }
        .loading { text-align: center; padding: 24px; color: var(--text-secondary); }

        .emoji-btn {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 14px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .emoji-btn:hover { background: var(--border-light); transform: scale(1.05); }
        .emoji-btn.selected { background: var(--accent-primary); border-color: var(--accent-primary); transform: scale(1.05); }

        /* Stats Grid - Colored Numbers */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }
        .stat-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            text-align: left;
            box-shadow: var(--card-shadow);
        }
        .stat-label {
            font-size: 0.75em;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .stat-number {
            font-size: 2.25em;
            font-weight: 700;
            line-height: 1;
        }
        .stat-number.blue { color: var(--accent-blue); }
        .stat-number.purple { color: var(--accent-purple); }
        .stat-number.orange { color: var(--accent-orange); }
        .stat-number.green { color: var(--accent-green); }

        /* Community Rank Card */
        .community-rank-card {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            border-radius: 16px;
            padding: 20px;
            color: white;
            margin: 16px 0;
        }
        .community-rank-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .community-rank-header svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }
        .community-rank-header h3 {
            font-size: 1.05em;
            font-weight: 700;
        }
        .rank-text {
            font-size: 0.9em;
            margin-bottom: 12px;
            opacity: 0.95;
        }
        .rank-bar {
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        .rank-bar-fill {
            height: 100%;
            background: #22c55e;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .rank-percentage {
            position: absolute;
            right: 20px;
            top: 56px;
            font-weight: 700;
            font-size: 1.1em;
        }
        .community-stats {
            display: flex;
            justify-content: space-between;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        .community-stat {
            text-align: left;
        }
        .community-stat:last-child {
            text-align: right;
        }
        .community-stat-label {
            font-size: 0.75em;
            opacity: 0.8;
            margin-bottom: 2px;
        }
        .community-stat-value {
            font-size: 1.1em;
            font-weight: 700;
        }

        /* Top Routes Section */
        .top-routes-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }
        .top-routes-card h3 {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .streak-status {
            display: none;
        }
        .streak-status.hot-streak {
            display: none;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .template-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .template-card:hover {
            background: var(--border-light);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }
        .template-card .template-icon {
            position: absolute;
            top: 14px;
            right: 14px;
            font-size: 1.1em;
        }
        .template-card .route-name {
            font-size: 1em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .template-card .stop-name {
            color: var(--text-secondary);
            font-size: 0.85em;
        }
        .templates-section {
            margin-bottom: 16px;
        }
        .templates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .templates-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1em;
            font-weight: 600;
        }
        .manage-templates-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .manage-templates-btn:hover {
            background: var(--bg-tertiary);
        }
        .save-template-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 16px 0;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }
        .save-template-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }
        .save-template-checkbox label {
            cursor: pointer;
            font-size: 0.9em;
            color: var(--text-primary);
        }

        /* Profile Page - Settings Style */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }
        .profile-avatar {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            position: relative;
        }
        .profile-avatar .edit-badge {
            position: absolute;
            bottom: -4px;
            right: -4px;
            width: 24px;
            height: 24px;
            background: var(--accent-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-secondary);
        }
        .profile-avatar .edit-badge svg {
            width: 12px;
            height: 12px;
            stroke: white;
            stroke-width: 2;
            fill: none;
        }
        .profile-info h2 {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }
        .profile-info p {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        /* Settings List */
        .settings-section {
            margin-bottom: 24px;
        }
        .settings-section h3 {
            font-size: 1em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            padding-left: 4px;
        }
        .settings-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .settings-item:last-child {
            border-bottom: none;
        }
        .settings-item:hover {
            background: var(--bg-tertiary);
        }
        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .settings-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
        }
        .settings-item-label {
            font-size: 0.95em;
            color: var(--text-primary);
        }
        .settings-item.danger .settings-item-label {
            color: #ef4444;
        }
        .settings-item.success .settings-item-label {
            color: var(--accent-green);
        }

        /* Toggle Switch */
        .toggle-switch {
            width: 50px;
            height: 28px;
            background: var(--border-color);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .toggle-switch.active {
            background: var(--accent-primary);
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::after {
            transform: translateX(22px);
        }

        /* Stats Toggle */
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .stats-header h2 {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-primary);
        }
        .stats-toggle-group {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 4px;
        }
        .stats-toggle-btn {
            padding: 8px 14px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .stats-toggle-btn.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: var(--card-shadow);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }
        .modal-content h3 {
            font-size: 1.25em;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
</head>
<body>
    <div class="main-content">
        <div class="header">
            <div class="header-row">
                <h1 class="header-title" onclick="goHome()">
                    <span class="logo-icon">üöå</span>
                    TransitStats
                </h1>
                <div id="userInfo" class="user-info" style="display: none;">
                    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggleBtn">üåô</button>
                    <button id="profileBtn" class="header-btn">üë§</button>
                    <button id="statsBtn" class="header-btn">üìä</button>
                    <button id="mapsBtn" class="header-btn">üó∫Ô∏è</button>
                </div>
            </div>
        </div>

        <!-- Bottom Tab Bar Navigation -->
        <nav class="bottom-nav" id="bottomNav" style="display: none;">
            <button class="nav-tab active" id="navHome" onclick="goHome(); setActiveTab('navHome')">
                <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span>Home</span>
            </button>
            <button class="nav-tab" id="navStats" onclick="showStats(); setActiveTab('navStats')">
                <svg viewBox="0 0 24 24"><rect x="3" y="12" width="4" height="9"/><rect x="10" y="8" width="4" height="13"/><rect x="17" y="4" width="4" height="17"/></svg>
                <span>Stats</span>
            </button>
            <button class="nav-tab" id="navMap" onclick="showMaps(); setActiveTab('navMap')">
                <svg viewBox="0 0 24 24"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
                <span>Map</span>
            </button>
            <button class="nav-tab" id="navProfile" onclick="showProfile(); setActiveTab('navProfile')">
                <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span>Profile</span>
            </button>
        </nav>

        <div class="content-wrapper">
            <div class="container">
                <div id="authSection" class="section auth-section">
                    <h2>Welcome to TransitStats</h2>
                    <p style="font-size: 0.85em; color: var(--text-muted);">Invite-only. Contact hey@ryanisnota.pro for access.</p>
                    <p>Sign in to sync your trips across all devices</p>
                    
                    <div id="emailStep">
                        <div class="form-group">
                            <input type="email" id="emailInput" placeholder="Enter your email address">
                        </div>
                        <button id="continueBtn" class="btn btn-primary" disabled>Continue</button>
                    </div>
                    
                    <div id="authMethodStep" style="display: none;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 1.1em; color: var(--text-primary); margin-bottom: 5px;" id="emailDisplay"></div>
                            <button style="background: none; border: none; color: var(--accent-primary); font-size: 0.9em; cursor: pointer; text-decoration: underline;" onclick="goBackToEmail()">Change email</button>
                        </div>
                        
                        <div class="form-group" id="passwordGroup" style="display: none;">
                            <input type="password" id="passwordInput" placeholder="Enter your password">
                            <div style="text-align: center; margin-top: 10px;">
                                <button style="background: none; border: none; color: var(--accent-primary); font-size: 0.9em; cursor: pointer; text-decoration: underline;" onclick="sendPasswordReset()">Forgot Password?</button>
                            </div>
                        </div>
                        
                        <div id="authButtons" style="display: flex; gap: 10px;">
                            <button id="magicLinkBtn" class="btn btn-primary" style="flex: 1;">‚ú® Magic Link</button>
                            <button id="passwordBtn" class="btn btn-outline" style="flex: 1;">üîë Password</button>
                        </div>
                        
                        <button id="signInBtn" class="btn btn-primary" style="display: none; margin-top: 10px;">Sign In</button>
                    </div>
                    
                    <div id="authStatus" class="auth-status" style="display: none;"></div>
                </div>

                <div id="appContent" style="display: none;">
                    <!-- Active Trip Banner (shown when trip in progress) -->
                    <div id="activeTripBanner" class="active-trip-banner" style="display: none;" onclick="goToActiveTrip()">
                        üöå Currently riding ‚Ä¢ Tap to view
                    </div>

                    <!-- Welcome Section (Home Screen) -->
                    <div id="homeWelcomeSection">
                        <div class="welcome-section">
                            <div>
                                <div class="welcome-text">Welcome back,</div>
                                <div class="welcome-name" id="welcomeUserName">Traveler</div>
                            </div>
                            <div class="streak-badge" id="homeStreakBadge">
                                <span>üî•</span>
                                <span id="homeStreakCount">0 Days</span>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden original streak status -->
                    <div id="bannersContainer" class="banner-container full-width" style="display: none;">
                        <div id="streakStatus" class="streak-status">‚ö° Take your first trip to start tracking!</div>
                    </div>

                    <!-- Recent Trips Section -->
                    <div id="recentTripsSection" class="section" style="display: none;">
                        <h3 class="section-header">Recent Trips</h3>
                        <div id="recentTripsList">
                            <div class="empty-state">No trips yet. Start one!</div>
                        </div>
                    </div>

                <div id="profileSection" style="display: none;">
                    <!-- Profile Header -->
                    <div class="profile-header">
                        <div class="profile-avatar" id="profileAvatarContainer">
                            <span id="profileAvatar">üöå</span>
                            <div class="edit-badge" onclick="toggleEmojiSelector()">
                                <svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                            </div>
                        </div>
                        <div class="profile-info">
                            <h2 id="profileDisplayName">Traveler</h2>
                            <p id="profileMemberSince">Member since 2025</p>
                        </div>
                    </div>

                    <!-- Hidden name input for editing -->
                    <input type="text" id="nameInput" placeholder="Your name" style="display: none;">
                    <button id="shuffleEmojiBtn" style="display: none;">üé≤</button>

                    <!-- Emoji Selector (hidden by default) -->
                    <div id="emojiSelector" class="section" style="display: none; margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 12px; font-weight: 600; font-size: 0.9em;">Choose your transit emoji:</label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px;">
                            <button class="emoji-btn" onclick="selectEmoji('üöå')">üöå</button>
                            <button class="emoji-btn" onclick="selectEmoji('üöá')">üöá</button>
                            <button class="emoji-btn" onclick="selectEmoji('üöä')">üöä</button>
                            <button class="emoji-btn" onclick="selectEmoji('üöã')">üöã</button>
                            <button class="emoji-btn" onclick="selectEmoji('üöû')">üöû</button>
                            <button class="emoji-btn" onclick="selectEmoji('üöù')">üöù</button>
                            <button class="emoji-btn" onclick="selectEmoji('üöÑ')">üöÑ</button>
                            <button class="emoji-btn" onclick="selectEmoji('‚úàÔ∏è')">‚úàÔ∏è</button>
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <input type="text" id="nameInputVisible" placeholder="Your name (e.g., Ryan)" style="text-align: left;">
                        </div>
                        <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
                    </div>

                    <!-- Settings Section -->
                    <div class="settings-section">
                        <h3>Settings</h3>
                        <div class="settings-card">
                            <div class="settings-item" onclick="toggleNotifications()">
                                <div class="settings-item-left">
                                    <div class="settings-icon">üîî</div>
                                    <span class="settings-item-label">Notifications</span>
                                </div>
                                <div class="toggle-switch active" id="notificationsToggle"></div>
                            </div>
                            <div class="settings-item" onclick="toggleTheme()">
                                <div class="settings-item-left">
                                    <div class="settings-icon">üåô</div>
                                    <span class="settings-item-label">Dark Mode</span>
                                </div>
                                <div class="toggle-switch" id="darkModeToggle"></div>
                            </div>
                            <div class="settings-item success" onclick="generateDemoData()">
                                <div class="settings-item-left">
                                    <div class="settings-icon">üé≤</div>
                                    <span class="settings-item-label">Generate Demo Data (Unlock Heatmap)</span>
                                </div>
                            </div>
                            <div class="settings-item danger" onclick="clearAllData()">
                                <div class="settings-item-left">
                                    <div class="settings-icon">üóëÔ∏è</div>
                                    <span class="settings-item-label">Clear All Data</span>
                                </div>
                            </div>
                            <div class="settings-item" onclick="signOut()">
                                <div class="settings-item-left">
                                    <div class="settings-icon">‚Ü™Ô∏è</div>
                                    <span class="settings-item-label">Sign Out</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden Stats for Profile (preserved for functionality) -->
                    <div style="display: none;">
                        <div id="profileCurrentStreak">0</div>
                        <div id="profileBestStreak">0</div>
                        <div id="profileFounderRoutes">0</div>
                        <div id="profileFounderStops">0</div>
                    </div>

                    <!-- Trip Templates Management -->
                    <div class="settings-section" id="templatesManagement">
                        <h3>Trip Templates</h3>
                        <div class="settings-card" style="padding: 16px;">
                            <div id="profileTemplatesList">
                                <div class="empty-state">No templates saved yet</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Trips -->
                    <div class="settings-section">
                        <h3>Recent Trips</h3>
                        <div class="settings-card" style="padding: 16px;">
                            <div id="profileTripsList">
                                <div class="empty-state">No trips yet</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="statsSection" style="display: none;">
                    <!-- Stats Header -->
                    <div class="stats-header">
                        <h2>Your Impact</h2>
                        <div class="stats-toggle-group">
                            <button id="statsToggle30" class="stats-toggle-btn active">30 Days</button>
                            <button id="statsToggleAll" class="stats-toggle-btn">All Time</button>
                        </div>
                    </div>

                    <!-- Stats Grid with Colored Numbers -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">TOTAL TRIPS</div>
                            <div class="stat-number blue" id="statsTotalTrips">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">HOURS</div>
                            <div class="stat-number purple" id="statsTotalTime">0.0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">ROUTES</div>
                            <div class="stat-number orange" id="statsUniqueRoutes">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">STOPS</div>
                            <div class="stat-number green" id="statsUniqueStops">0</div>
                        </div>
                    </div>

                    <!-- Community Rank Card -->
                    <div class="community-rank-card" style="position: relative;">
                        <div class="community-rank-header">
                            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                            <h3>Community Rank</h3>
                        </div>
                        <div class="rank-text">You are in the top</div>
                        <div class="rank-bar">
                            <div class="rank-bar-fill" id="rankBarFill" style="width: 0%;"></div>
                        </div>
                        <span class="rank-percentage" id="rankPercentage">0%</span>
                        <div class="community-stats">
                            <div class="community-stat">
                                <div class="community-stat-label">Community Avg</div>
                                <div class="community-stat-value" id="communityAvg">24.5 trips/mo</div>
                            </div>
                            <div class="community-stat">
                                <div class="community-stat-label">Total Users</div>
                                <div class="community-stat-value" id="totalUsers">1,248</div>
                            </div>
                        </div>
                        <div id="communityStats" style="display: none;"></div>
                    </div>

                    <!-- Top Routes -->
                    <div class="top-routes-card">
                        <h3>Top Routes</h3>
                        <div id="topRoutes">
                            <div class="empty-state">Not enough data</div>
                        </div>
                    </div>

                    <!-- Hidden: Top Stops (preserved for functionality) -->
                    <div style="display: none;">
                        <div id="topStops"></div>
                    </div>

                    <!-- Export Button (hidden, preserved for functionality) -->
                    <button id="exportCsvBtn" onclick="exportTripsToCSV()" style="display: none;">Export</button>
                </div>

                <!-- Maps Section -->
                <div id="mapsSection" style="display: none;">
                    <!-- Locked Heatmap State -->
                    <div id="heatmapLockedState" class="section">
                        <div class="heatmap-locked">
                            <div class="heatmap-locked-icon">
                                <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                            </div>
                            <h3>Heatmap Locked</h3>
                            <p>Record 50 trips with GPS data to unlock detailed ridership heatmaps.</p>
                            <div class="heatmap-progress-bar">
                                <div class="heatmap-progress-fill" id="heatmapProgressFill" style="width: 0%;"></div>
                            </div>
                            <div class="heatmap-progress-text" id="heatmapProgressText">0/50 Trips</div>
                            <div class="heatmap-progress-hint">Keep tracking to unlock!</div>
                        </div>
                    </div>

                    <!-- Unlocked Heatmap Content (hidden until unlocked) -->
                    <div id="heatmapUnlockedState" style="display: none;">
                        <!-- Hidden progress bar for backward compatibility -->
                        <div id="heatmapProgress" class="heatmap-progress" style="display: none;">
                            <div id="progressText">üó∫Ô∏è Start taking trips to unlock your heatmap!</div>
                            <div class="progress-bar">
                                <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
                            </div>
                            <div id="progressCount" style="font-size: 0.9em; opacity: 0.9;">0 / 50 trips with GPS</div>
                        </div>

                        <div class="map-controls">
                            <div class="map-toggle">
                                <button class="toggle-btn active" id="boardingToggle" onclick="setMapMode('boarding')">Boarding</button>
                                <button class="toggle-btn" id="alightingToggle" onclick="setMapMode('alighting')">Alighting</button>
                                <button class="toggle-btn" id="markersToggle" onclick="setMapMode('markers')">All Trips</button>
                            </div>

                            <div class="map-legend" id="mapLegend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #1e3a8a;"></div>
                                    <span>Home Base (50%+)</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #3b82f6;"></div>
                                    <span>Regular (25-49%)</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #60a5fa;"></div>
                                    <span>Occasional (10-24%)</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #93c5fd;"></div>
                                    <span>Rare (5-9%)</span>
                                </div>
                            </div>
                        </div>

                        <div id="mapContainer">
                            <div style="text-align: center;">
                                <div style="font-size: 2em; margin-bottom: 10px;">üó∫Ô∏è</div>
                                <div>Loading map...</div>
                            </div>
                        </div>

                        <div id="mapStats" style="display: none; background: var(--bg-tertiary); border-radius: 12px; padding: 16px; margin-top: 16px;">
                            <h4 style="margin-bottom: 10px; color: var(--text-primary); font-weight: 600;">Map Statistics</h4>
                            <div id="mapStatsContent"></div>
                        </div>
                    </div>
                </div>

                <div id="startSection">
                    <!-- Start New Trip Card -->
                    <div class="start-trip-card" onclick="focusTripForm()">
                        <div class="start-trip-info">
                            <h3>Start New Trip</h3>
                            <p>Record a new journey</p>
                        </div>
                        <button class="start-trip-btn" type="button">
                            <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        </button>
                    </div>

                    <!-- Quick Actions Grid -->
                    <div class="quick-actions-grid">
                        <div class="quick-action-card" id="repeatLastCard" onclick="repeatLastTrip()" style="display: none;">
                            <div class="quick-action-icon history">‚è±Ô∏è</div>
                            <div class="quick-action-title">Repeat Last</div>
                            <div class="quick-action-subtitle" id="repeatLastSubtitle">No history</div>
                        </div>
                        <div class="quick-action-card" onclick="showTemplatesModal()">
                            <div class="quick-action-icon templates">üîñ</div>
                            <div class="quick-action-title">Templates</div>
                            <div class="quick-action-subtitle" id="templatesCount">0 saved</div>
                        </div>
                    </div>

                    <!-- Trip Form (initially collapsed, shown on card click) -->
                    <div id="tripFormSection" class="section" style="display: none;">
                        <div class="form-group">
                            <label>Boarding Stop</label>
                            <input type="text" id="stopInput" placeholder="e.g., 6638 or Union Station">
                            <div id="stopPreview" class="preview-box" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label>Route/Line</label>
                            <input type="text" id="routeInput" placeholder="e.g., 65, Line 1, 504 King">
                            <div id="routePreview" class="preview-box" style="display: none;"></div>
                        </div>
                        <button id="startBtn" class="btn btn-primary" disabled>Board Vehicle</button>
                    </div>

                    <!-- Hidden: Original templates section for backward compatibility -->
                    <div id="templatesSection" class="templates-section" style="display: none;">
                        <div class="templates-header">
                            <h3>Quick Start</h3>
                            <button class="manage-templates-btn" onclick="showProfile(); scrollToTemplates();">Manage</button>
                        </div>
                        <div id="templatesList"></div>
                    </div>

                    <!-- Hidden: Repeat Last Trip Button for backward compatibility -->
                    <div id="repeatLastTripSection" style="display: none;">
                        <button id="repeatLastTripBtn" class="btn" style="display: none;">Repeat Last Trip</button>
                    </div>
                </div>

                <div id="activeSection" class="section" style="display: none;">
                    <div class="trip-status">
                        <h2>üöå Currently Riding</h2>
                        <div id="currentTrip"></div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button id="endBtn" class="btn btn-danger" style="flex: 1;">üõë End Trip</button>
                        <button id="cancelTrip" class="btn btn-outline" style="background: #ffc107; color: #856404; border-color: #ffc107; flex: 1;">‚ö†Ô∏è Cancel Trip</button>
                    </div>
                </div>
            </div>
            </div>

            <div id="endModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-secondary); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; border: 1px solid var(--border-color);">
                    <h3>End Trip</h3>
                    <div class="form-group">
                        <label>Exit Stop</label>
                        <input type="text" id="exitInput" placeholder="e.g., 1234 or King Station">
                    </div>
                    <div class="save-template-checkbox">
                        <input type="checkbox" id="saveAsTemplate">
                        <label for="saveAsTemplate">‚≠ê Save route + start stop as template</label>
                    </div>
                    <button id="saveBtn" class="btn btn-primary">Save Trip</button>
                    <button id="cancelBtn" class="btn" style="background: var(--border-color);">Cancel</button>
                </div>
            </div>
                </div>
        </div>

        <!-- Status Footer -->
        <div class="status-footer">
            <div id="locationStatus" class="status-indicator loading">
                üìç Getting location...
            </div>
            <div id="connectionStatus" class="status-indicator connected" onclick="toggleLogout()">
                Logged In
            </div>
        </div>

    <script>
        console.log('üöÄ TransitStats Loading...');
        
        const firebaseConfig = {
            apiKey: "AIzaSyBgY37b_aUorxdEW6DnocFoo8ekbTTFpao",
            authDomain: "transitstats-21ba4.firebaseapp.com",
            projectId: "transitstats-21ba4",
            storageBucket: "transitstats-21ba4.firebasestorage.app",
            messagingSenderId: "756203797723",
            appId: "1:756203797723:web:2e5aab94a6de20cf06a0fe"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        console.log('‚úÖ Firebase initialized successfully!');

        let currentUser = null;
        let activeTrip = null;
        let currentStatsView = '30days';
        let logoutModeActive = false;
        let statsInitialized = false;
        let map = null;
        let mapMode = 'boarding';
        let mapInitialized = false;

        // DOM Elements
        const authSection = document.getElementById('authSection');
        const appContent = document.getElementById('appContent');
        const profileSection = document.getElementById('profileSection');
        const statsSection = document.getElementById('statsSection');
        const mapsSection = document.getElementById('mapsSection');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const continueBtn = document.getElementById('continueBtn');
        const magicLinkBtn = document.getElementById('magicLinkBtn');
        const passwordBtn = document.getElementById('passwordBtn');
        const signInBtn = document.getElementById('signInBtn');
        const authStatus = document.getElementById('authStatus');
        const userInfo = document.getElementById('userInfo');
        const profileBtn = document.getElementById('profileBtn');
        const statsBtn = document.getElementById('statsBtn');
        const mapsBtn = document.getElementById('mapsBtn');
        const stopInput = document.getElementById('stopInput');
        const routeInput = document.getElementById('routeInput');
        const startBtn = document.getElementById('startBtn');
        const startSection = document.getElementById('startSection');
        const activeSection = document.getElementById('activeSection');
        const currentTripDiv = document.getElementById('currentTrip');
        const endBtn = document.getElementById('endBtn');
        const endModal = document.getElementById('endModal');
        const exitInput = document.getElementById('exitInput');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const tripsList = document.getElementById('tripsList');
        const tripCount = document.getElementById('tripCount');
        const streakStatus = document.getElementById('streakStatus');
        const locationStatus = document.getElementById('locationStatus');
        const connectionStatus = document.getElementById('connectionStatus');
        const activeTripBanner = document.getElementById('activeTripBanner');
        const bannersContainer = document.getElementById('bannersContainer');
        const repeatLastTripBtn = document.getElementById('repeatLastTripBtn');
        const repeatLastTripSection = document.getElementById('repeatLastTripSection');

        // Theme Management
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const currentTheme = body.getAttribute('data-theme');

            if (currentTheme === 'dark') {
                body.removeAttribute('data-theme');
                themeToggle.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
                if (darkModeToggle) darkModeToggle.classList.remove('active');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeToggle.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
                if (darkModeToggle) darkModeToggle.classList.add('active');
            }
        }

        // Load saved theme on page load
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                if (themeToggle) themeToggle.textContent = '‚òÄÔ∏è';
            } else {
                if (themeToggle) themeToggle.textContent = 'üåô';
            }
        }

        // Authentication State Management
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                // Check if user is in the allowedUsers whitelist
                const allowedUsersRef = db.collection('allowedUsers');
                const querySnapshot = await allowedUsersRef.where('email', '==', user.email).get();

                if (querySnapshot.empty) {
                    await auth.signOut();
                    alert('Access denied. This app is invite-only.');
                    return;
                }

                console.log('‚úÖ User authenticated:', user.email);
                updateConnectionStatus(true);
                showApp();
            } else {
                console.log('‚ùå No user authenticated');
                updateConnectionStatus(false);
                showAuth();
            }
        });

        function showAuth() {
            authSection.style.display = 'block';
            appContent.style.display = 'none';
            userInfo.style.display = 'none';
            updateConnectionStatus(false);
        }

        function showApp() {
            authSection.style.display = 'none';
            appContent.style.display = 'block';
            userInfo.style.display = 'block';
            // Show bottom navigation
            const bottomNav = document.getElementById('bottomNav');
            if (bottomNav) bottomNav.style.display = 'flex';
            updateConnectionStatus(true);
            loadUserProfile();
            initializeApp();
            // Initialize active tab
            setActiveTab('navHome');
        }

        // Profile Management
        function loadUserProfile() {
            db.collection('profiles').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const profile = doc.data();
                        const emoji = profile.emoji || 'üöå';
                        document.getElementById('profileAvatar').textContent = emoji;
                        document.getElementById('nameInput').value = profile.name || '';

                        // Update welcome name and profile display name
                        updateWelcomeName(profile.name);

                        if (profile.emoji) {
                            document.getElementById('emojiSelector').style.display = 'none';
                            document.getElementById('shuffleEmojiBtn').style.display = 'block';
                        }

                        // Update dark mode toggle state
                        const darkModeToggle = document.getElementById('darkModeToggle');
                        if (darkModeToggle) {
                            const isDark = document.body.getAttribute('data-theme') === 'dark';
                            if (isDark) {
                                darkModeToggle.classList.add('active');
                            } else {
                                darkModeToggle.classList.remove('active');
                            }
                        }
                    }
                })
                .catch((error) => {
                    console.log('Profile load error (using defaults):', error.message);
                });
        }

        function showProfile() {
            hideAllSections();
            profileSection.style.display = 'block';
            startSection.style.display = 'none';
            // Hide welcome section when on other pages
            const welcomeSection = document.getElementById('homeWelcomeSection');
            if (welcomeSection) welcomeSection.style.display = 'none';
            updateTripIndicator();
            updateProfileStats();
            loadProfileTrips();
            setActiveTab('navProfile');
        }

        function showStats() {
            hideAllSections();
            // Hide welcome section when on other pages
            const welcomeSection = document.getElementById('homeWelcomeSection');
            if (welcomeSection) welcomeSection.style.display = 'none';
            statsSection.style.display = 'block';
            startSection.style.display = 'none';
            updateTripIndicator();
            
            if (!statsInitialized) {
                initializeStatsToggle();
                statsInitialized = true;
            }

            updateStatsSection();
            loadCommunityData();
            setActiveTab('navStats');
        }

        function showMaps() {
            hideAllSections();
            mapsSection.style.display = 'block';
            startSection.style.display = 'none';
            // Hide welcome section when on other pages
            const welcomeSection = document.getElementById('homeWelcomeSection');
            if (welcomeSection) welcomeSection.style.display = 'none';
            updateTripIndicator();

            if (!mapInitialized) {
                initializeMap();
            } else {
                loadMapData();
            }
            setActiveTab('navMap');
        }

        function hideAllSections() {
            profileSection.style.display = 'none';
            statsSection.style.display = 'none';
            mapsSection.style.display = 'none';
        }

        function goHome() {
            hideAllSections();
            if (activeTrip) {
                showActiveSection();
            } else {
                showStartSection();
            }
            setActiveTab('navHome');
            // Show welcome section when going home
            const welcomeSection = document.getElementById('homeWelcomeSection');
            if (welcomeSection) welcomeSection.style.display = 'block';
        }

        // Bottom Nav Tab Management
        function setActiveTab(tabId) {
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            const activeTab = document.getElementById(tabId);
            if (activeTab) activeTab.classList.add('active');
        }

        // Focus Trip Form (show form when Start New Trip card is clicked)
        function focusTripForm() {
            const tripFormSection = document.getElementById('tripFormSection');
            if (tripFormSection) {
                tripFormSection.style.display = 'block';
                const stopInput = document.getElementById('stopInput');
                if (stopInput) stopInput.focus();
            }
        }

        // Show Templates Modal
        function showTemplatesModal() {
            showProfile();
            setActiveTab('navProfile');
            setTimeout(() => scrollToTemplates(), 100);
        }

        // Toggle Emoji Selector
        function toggleEmojiSelector() {
            const emojiSelector = document.getElementById('emojiSelector');
            if (emojiSelector) {
                emojiSelector.style.display = emojiSelector.style.display === 'none' ? 'block' : 'none';
                // Sync name input
                const nameInput = document.getElementById('nameInput');
                const nameInputVisible = document.getElementById('nameInputVisible');
                if (nameInputVisible && nameInput) {
                    nameInputVisible.value = nameInput.value;
                }
            }
        }

        // Toggle Notifications
        function toggleNotifications() {
            const toggle = document.getElementById('notificationsToggle');
            if (toggle) {
                toggle.classList.toggle('active');
            }
        }

        // Sign Out Function
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                auth.signOut();
            }
        }

        // Generate Demo Data
        function generateDemoData() {
            if (!currentUser) return;
            if (!confirm('This will create 50 demo trips to unlock the heatmap. Continue?')) return;

            const routes = ['504 King', '501 Queen', 'Line 1', 'Line 2', '65', '29', '52'];
            const stops = ['Union Station', 'King Station', 'Queen Station', 'Dundas Station', 'Bloor Station', 'St Clair Station'];

            const batch = db.batch();
            const now = new Date();

            for (let i = 0; i < 50; i++) {
                const tripRef = db.collection('trips').doc();
                const startDate = new Date(now.getTime() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                const endDate = new Date(startDate.getTime() + (15 + Math.random() * 45) * 60 * 1000);

                batch.set(tripRef, {
                    userId: currentUser.uid,
                    route: routes[Math.floor(Math.random() * routes.length)],
                    startStop: stops[Math.floor(Math.random() * stops.length)],
                    endStop: stops[Math.floor(Math.random() * stops.length)],
                    startTime: firebase.firestore.Timestamp.fromDate(startDate),
                    endTime: firebase.firestore.Timestamp.fromDate(endDate),
                    startLat: 43.65 + (Math.random() - 0.5) * 0.1,
                    startLng: -79.38 + (Math.random() - 0.5) * 0.1,
                    endLat: 43.65 + (Math.random() - 0.5) * 0.1,
                    endLng: -79.38 + (Math.random() - 0.5) * 0.1
                });
            }

            batch.commit().then(() => {
                alert('Demo data generated! Refresh to see the heatmap.');
                location.reload();
            }).catch(err => {
                console.error('Error generating demo data:', err);
                alert('Error generating demo data. Please try again.');
            });
        }

        // Clear All Data
        function clearAllData() {
            if (!currentUser) return;
            if (!confirm('This will delete ALL your trips. This cannot be undone. Continue?')) return;
            if (!confirm('Are you absolutely sure? All trips will be permanently deleted.')) return;

            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .get()
                .then(snapshot => {
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    return batch.commit();
                })
                .then(() => {
                    alert('All data cleared.');
                    location.reload();
                })
                .catch(err => {
                    console.error('Error clearing data:', err);
                    alert('Error clearing data. Please try again.');
                });
        }

        // Update Welcome Name
        function updateWelcomeName(name) {
            const welcomeName = document.getElementById('welcomeUserName');
            const profileDisplayName = document.getElementById('profileDisplayName');
            if (welcomeName) welcomeName.textContent = name || 'Traveler';
            if (profileDisplayName) profileDisplayName.textContent = name || 'Traveler';
        }

        // Update Home Streak Badge
        function updateHomeStreakBadge(streakDays) {
            const badge = document.getElementById('homeStreakBadge');
            const countSpan = document.getElementById('homeStreakCount');
            if (badge && countSpan) {
                countSpan.textContent = `${streakDays} Day${streakDays !== 1 ? 's' : ''}`;
                if (streakDays > 0) {
                    badge.classList.add('active');
                } else {
                    badge.classList.remove('active');
                }
            }
        }

        // Update Heatmap Progress (for locked state)
        function updateHeatmapLockProgress(tripCount) {
            const progressFill = document.getElementById('heatmapProgressFill');
            const progressText = document.getElementById('heatmapProgressText');
            const lockedState = document.getElementById('heatmapLockedState');
            const unlockedState = document.getElementById('heatmapUnlockedState');

            const percentage = Math.min((tripCount / 50) * 100, 100);

            if (progressFill) progressFill.style.width = `${percentage}%`;
            if (progressText) progressText.textContent = `${tripCount}/50 Trips`;

            if (tripCount >= 50) {
                if (lockedState) lockedState.style.display = 'none';
                if (unlockedState) unlockedState.style.display = 'block';
            } else {
                if (lockedState) lockedState.style.display = 'block';
                if (unlockedState) unlockedState.style.display = 'none';
            }
        }

        // Maps functionality - Clean Datawrapper Style
        function initializeMap() {
            if (!currentUser) return;
            
            loadMapData();
            mapInitialized = true;
        }

        function loadMapData() {
            if (!currentUser) return;

            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((snapshot) => {
                    const trips = [];
                    snapshot.forEach((doc) => {
                        const trip = doc.data();
                        if (trip.boardingLocation || trip.exitLocation) {
                            trips.push(trip);
                        }
                    });

                    const totalTrips = trips.length;
                    const progressBar = document.getElementById('heatmapProgress');
                    const progressFill = document.getElementById('progressFill');
                    const progressCount = document.getElementById('progressCount');
                    const progressText = document.getElementById('progressText');

                    if (totalTrips === 0) {
                        progressBar.style.display = 'block';
                        progressFill.style.width = '0%';
                        progressCount.textContent = '0 / 50 trips with GPS';
                        progressText.textContent = 'üó∫Ô∏è Start taking trips with GPS to unlock your heatmap!';
                        
                        document.getElementById('mapContainer').innerHTML = `
                            <div style="text-align: center;">
                                <div style="font-size: 2em; margin-bottom: 10px;">üó∫Ô∏è</div>
                                <div>Take your first trip to get started!</div>
                            </div>
                        `;
                        return;
                    }

                    const progress = Math.min((totalTrips / 50) * 100, 100);
                    progressFill.style.width = `${progress}%`;
                    progressCount.textContent = `${totalTrips} / 50 trips with GPS`;
                    
                    if (totalTrips < 50) {
                        progressBar.style.display = 'block';
                        if (totalTrips < 10) {
                            progressText.textContent = 'üó∫Ô∏è Keep taking trips to unlock your heatmap!';
                        } else if (totalTrips < 25) {
                            progressText.textContent = 'üó∫Ô∏è Great progress! More trips = better heatmap!';
                        } else {
                            progressText.textContent = 'üó∫Ô∏è Almost there! Heatmap unlocking soon!';
                        }
                        
                        if (mapMode === 'markers') {
                            createMap(trips);
                            updateMapStats(trips);
                        } else {
                            document.getElementById('mapContainer').innerHTML = `
                                <div style="text-align: center;">
                                    <div style="font-size: 2em; margin-bottom: 10px;">üó∫Ô∏è</div>
                                    <div style="margin-top: 15px;">
                                        <button class="btn" style="background: var(--accent-primary); color: white; padding: 10px 20px; font-size: 0.9em;" onclick="setMapMode('markers');">
                                            View individual trips (${totalTrips} available)
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    } else {
                        progressBar.style.display = 'none';
                        createMap(trips);
                        updateMapStats(trips);
                    }
                })
                .catch((error) => {
                    console.error('Error loading map data:', error);
                    document.getElementById('mapContainer').innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 10px;">‚ùå</div>
                            <div>Error loading map data</div>
                        </div>
                    `;
                    document.getElementById('heatmapProgress').style.display = 'none';
                });
        }

        function createMap(trips) {
            document.getElementById('mapContainer').innerHTML = '';
            
            const locations = [];
            trips.forEach(trip => {
                if (trip.boardingLocation) {
                    locations.push([trip.boardingLocation.lat, trip.boardingLocation.lon]);
                }
                if (trip.exitLocation) {
                    locations.push([trip.exitLocation.lat, trip.exitLocation.lon]);
                }
            });

            if (locations.length === 0) return;

            const lats = locations.map(loc => loc[0]);
            const lons = locations.map(loc => loc[1]);
            const minLat = Math.min(...lats);
            const maxLat = Math.max(...lats);
            const minLon = Math.min(...lons);
            const maxLon = Math.max(...lons);
            
            const avgLat = (minLat + maxLat) / 2;
            const avgLon = (minLon + maxLon) / 2;

            map = L.map('mapContainer').setView([avgLat, avgLon], 12);

            // Use clean CartoDB Light tiles for minimal Datawrapper style
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CartoDB',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            if (mapMode === 'boarding' || mapMode === 'alighting') {
                createHeatmap(trips, mapMode);
            } else {
                createMarkers(trips);
            }
            
            if (locations.length > 1) {
                const bounds = L.latLngBounds(locations);
                map.fitBounds(bounds, { padding: [20, 20] });
            } else if (locations.length === 1) {
                map.setView(locations[0], 15);
            }
        }

        function createHeatmap(trips, mode) {
            const stopCounts = {};
            
            trips.forEach(trip => {
                if (mode === 'boarding' && trip.boardingLocation && trip.startStop) {
                    const key = trip.startStop;
                    if (!stopCounts[key]) {
                        stopCounts[key] = {
                            name: trip.startStop,
                            lat: trip.boardingLocation.lat,
                            lon: trip.boardingLocation.lon,
                            count: 0
                        };
                    }
                    stopCounts[key].count++;
                } else if (mode === 'alighting' && trip.exitLocation && trip.endStop) {
                    const key = trip.endStop;
                    if (!stopCounts[key]) {
                        stopCounts[key] = {
                            name: trip.endStop,
                            lat: trip.exitLocation.lat,
                            lon: trip.exitLocation.lon,
                            count: 0
                        };
                    }
                    stopCounts[key].count++;
                }
            });

            const significantStops = Object.values(stopCounts)
                .filter(stop => stop.count >= 5)
                .sort((a, b) => b.count - a.count);

            if (significantStops.length === 0) {
                if (map) {
                    map.eachLayer((layer) => {
                        if (!layer._url) {
                            map.removeLayer(layer);
                        }
                    });
                }
                
                const modeText = mode === 'boarding' ? 'boarding locations' : 'alighting locations';
                document.getElementById('mapContainer').innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üó∫Ô∏è</div>
                        <div>No repeated ${modeText} found</div>
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-top: 10px;">Use the same stop 5+ times to see it on the heatmap</div>
                    </div>
                `;
                return;
            }

            const maxUsage = significantStops[0].count;

            // Clean data visualization colors - subtle blues
            significantStops.forEach((stop, index) => {
                const percentage = (stop.count / maxUsage) * 100;
                let color, description;
                
                if (percentage >= 50) {
                    color = '#1e3a8a'; // Dark blue - Home base
                    description = 'Home Base';
                } else if (percentage >= 25) {
                    color = '#3b82f6'; // Medium blue - Regular  
                    description = 'Regular';
                } else if (percentage >= 10) {
                    color = '#60a5fa'; // Light blue - Occasional
                    description = 'Occasional';
                } else {
                    color = '#93c5fd'; // Very light blue - Rare
                    description = 'Rare';
                }

                const radius = 12 + (percentage / 100) * 18;

                const circle = L.circle([stop.lat, stop.lon], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.7,
                    weight: 2,
                    radius: radius * 20
                }).addTo(map);

                const modeText = mode === 'boarding' ? 'boardings' : 'alightings';
                circle.bindPopup(`
                    <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 4px;">
                        <strong style="font-size: 14px;">${stop.name}</strong><br>
                        <span style="color: #666; font-size: 12px;">${description} (${Math.round(percentage)}% of max)</span><br>
                        <span style="color: #666; font-size: 12px;">${stop.count} ${modeText} ‚Ä¢ Rank #${index + 1}</span>
                    </div>
                `);
            });
        }

        function createMarkers(trips) {
            trips.forEach((trip, index) => {
                if (trip.boardingLocation) {
                    const boardingMarker = L.marker([trip.boardingLocation.lat, trip.boardingLocation.lon])
                        .addTo(map);
                    
                    boardingMarker.bindPopup(`
                        <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 4px;">
                            <strong style="font-size: 14px;">üöå Boarding</strong><br>
                            <span style="color: #666; font-size: 12px;">Stop: ${trip.startStop}</span><br>
                            <span style="color: #666; font-size: 12px;">Route: ${trip.route}</span><br>
                            <span style="color: #666; font-size: 12px;">Time: ${trip.startTime?.toDate ? trip.startTime.toDate().toLocaleString() : 'Unknown'}</span>
                        </div>
                    `);
                }

                if (trip.exitLocation) {
                    const alightingMarker = L.marker([trip.exitLocation.lat, trip.exitLocation.lon])
                        .addTo(map);
                    
                    alightingMarker.bindPopup(`
                        <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 4px;">
                            <strong style="font-size: 14px;">üöè Alighting</strong><br>
                            <span style="color: #666; font-size: 12px;">Stop: ${trip.endStop}</span><br>
                            <span style="color: #666; font-size: 12px;">Route: ${trip.route}</span><br>
                            <span style="color: #666; font-size: 12px;">Duration: ${trip.duration || 0} minutes</span>
                        </div>
                    `);
                }
            });
        }

        function setMapMode(mode) {
            mapMode = mode;
            
            document.getElementById('boardingToggle').className = mode === 'boarding' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('alightingToggle').className = mode === 'alighting' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('markersToggle').className = mode === 'markers' ? 'toggle-btn active' : 'toggle-btn';
            
            document.getElementById('mapLegend').style.display = (mode === 'boarding' || mode === 'alighting') ? 'flex' : 'none';
            
            if (mapInitialized) {
                loadMapData();
            }
        }

        function updateMapStats(trips) {
            const locatedTrips = trips.filter(t => t.boardingLocation || t.exitLocation);
            const bothLocations = trips.filter(t => t.boardingLocation && t.exitLocation);
            
            const statsHtml = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--accent-primary);">${locatedTrips.length}</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">Trips with GPS</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--accent-primary);">${bothLocations.length}</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">Complete journeys</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--accent-primary);">${Math.round((locatedTrips.length / trips.length) * 100)}%</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">GPS coverage</div>
                    </div>
                </div>
            `;
            
            document.getElementById('mapStatsContent').innerHTML = statsHtml;
            document.getElementById('mapStats').style.display = 'block';
        }

        function updateTripIndicator() {
            const streakVisible = streakStatus.style.display === 'block';
            
            if (activeTrip) {
                activeTripBanner.innerHTML = `üöå Currently riding ${activeTrip.route} ‚Ä¢ Tap to view`;
                activeTripBanner.style.display = 'block';
                
                if (streakVisible) {
                    bannersContainer.className = 'banner-container';
                    const currentText = streakStatus.textContent;
                    if (currentText && currentText.includes('Keep it going!')) {
                        streakStatus.textContent = currentText.replace(' Keep it going!', '').replace(' You\'re a transit champion!', '');
                    }
                } else {
                    bannersContainer.className = 'banner-container full-width';
                }
            } else {
                activeTripBanner.style.display = 'none';
                bannersContainer.className = 'banner-container full-width';
                
                if (streakVisible) {
                    loadTrips();
                }
            }
        }

        function toggleLogout() {
            if (!logoutModeActive) {
                connectionStatus.textContent = 'Log Out';
                connectionStatus.classList.add('logout-mode');
                logoutModeActive = true;
                
                setTimeout(() => {
                    if (logoutModeActive) {
                        connectionStatus.textContent = 'Logged In';
                        connectionStatus.classList.remove('logout-mode');
                        logoutModeActive = false;
                    }
                }, 3000);
            } else {
                signOut();
            }
        }

        function selectEmoji(emoji) {
            document.querySelectorAll('.emoji-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('profileAvatar').textContent = emoji;
        }

        function shuffleEmoji() {
            const emojis = ['üöå', 'üöá', 'üöä', 'üöã', 'üöû', 'üöù', 'üöÑ', '‚úàÔ∏è'];
            const currentEmoji = document.getElementById('profileAvatar').textContent;
            let newEmoji;
            do {
                newEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            } while (newEmoji === currentEmoji);
            
            document.getElementById('profileAvatar').textContent = newEmoji;
        }

        function saveProfile() {
            // Check both name inputs (hidden and visible)
            const nameInputVisible = document.getElementById('nameInputVisible');
            const nameInput = document.getElementById('nameInput');
            let name = '';

            if (nameInputVisible && nameInputVisible.value.trim()) {
                name = nameInputVisible.value.trim();
                // Sync to hidden input
                if (nameInput) nameInput.value = name;
            } else if (nameInput) {
                name = nameInput.value.trim();
            }

            const emoji = document.getElementById('profileAvatar').textContent;

            if (!name) {
                alert('Please enter your name');
                return;
            }

            const profileData = {
                name: name,
                emoji: emoji,
                userId: currentUser.uid,
                updatedAt: firebase.firestore.Timestamp.now()
            };

            db.collection('profiles').doc(currentUser.uid).set(profileData)
                .then(() => {
                    // Update welcome name and profile display name
                    updateWelcomeName(name);
                    // Hide emoji selector after save
                    const emojiSelector = document.getElementById('emojiSelector');
                    if (emojiSelector) emojiSelector.style.display = 'none';
                    alert('Profile saved!');
                    goHome();
                })
                .catch((error) => {
                    console.error('Error saving profile:', error);
                    alert('Error saving profile. Please try again.');
                });
        }

        function signOut() {
            auth.signOut();
        }

        // Stats Management
        function initializeStatsToggle() {
            const toggle30 = document.getElementById('statsToggle30');
            const toggleAll = document.getElementById('statsToggleAll');

            toggle30.addEventListener('click', () => {
                if (currentStatsView !== '30days') {
                    currentStatsView = '30days';
                    toggle30.classList.add('active');
                    toggleAll.classList.remove('active');
                    updateStatsSection();
                    loadCommunityData();
                }
            });

            toggleAll.addEventListener('click', () => {
                if (currentStatsView !== 'alltime') {
                    currentStatsView = 'alltime';
                    toggleAll.classList.add('active');
                    toggle30.classList.remove('active');
                    updateStatsSection();
                    loadCommunityData();
                }
            });
        }

        function exportTripsToCSV() {
            if (!currentUser) {
                alert('Please sign in to export your trips.');
                return;
            }

            const exportBtn = document.getElementById('exportCsvBtn');
            const originalContent = exportBtn.innerHTML;
            exportBtn.innerHTML = '<span style="font-size: 1em;">‚è≥</span> Exporting...';
            exportBtn.disabled = true;

            let query = db.collection('trips').where('userId', '==', currentUser.uid);

            if (currentStatsView === '30days') {
                const dateFilter = new Date();
                dateFilter.setDate(dateFilter.getDate() - 30);
                query = query.where('startTime', '>=', firebase.firestore.Timestamp.fromDate(dateFilter));
            }

            query.orderBy('startTime', 'desc').get()
                .then((snapshot) => {
                    const trips = [];
                    snapshot.forEach((doc) => {
                        trips.push(doc.data());
                    });

                    if (trips.length === 0) {
                        alert('No trips to export.');
                        exportBtn.innerHTML = originalContent;
                        exportBtn.disabled = false;
                        return;
                    }

                    // CSV header
                    const headers = ['Date', 'Route', 'Start Stop', 'End Stop', 'Duration (min)', 'Start Time', 'End Time'];

                    // Convert trips to CSV rows
                    const rows = trips.map(trip => {
                        const startDate = trip.startTime?.toDate ? trip.startTime.toDate() : new Date(trip.startTime);
                        const endDate = trip.endTime?.toDate ? trip.endTime.toDate() : (trip.endTime ? new Date(trip.endTime) : null);

                        const dateStr = startDate.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
                        const startTimeStr = startDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                        const endTimeStr = endDate ? endDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : '';

                        return [
                            dateStr,
                            escapeCsvField(trip.route || ''),
                            escapeCsvField(trip.startStop || ''),
                            escapeCsvField(trip.endStop || ''),
                            trip.duration || '',
                            startTimeStr,
                            endTimeStr
                        ];
                    });

                    // Build CSV content
                    const csvContent = [
                        headers.join(','),
                        ...rows.map(row => row.join(','))
                    ].join('\n');

                    // Create and download file
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const today = new Date().toISOString().split('T')[0];
                    const filename = `transit-trips-${today}.csv`;

                    // Use standard download pattern that works on mobile Safari
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    exportBtn.innerHTML = originalContent;
                    exportBtn.disabled = false;
                })
                .catch((error) => {
                    console.error('Error exporting trips:', error);
                    alert('Error exporting trips. Please try again.');
                    exportBtn.innerHTML = originalContent;
                    exportBtn.disabled = false;
                });
        }

        function escapeCsvField(field) {
            if (field === null || field === undefined) return '';
            const str = String(field);
            // Escape fields containing commas, quotes, or newlines
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        function updateStatsSection() {
            if (!currentUser) return;

            const now = new Date();
            let query = db.collection('trips').where('userId', '==', currentUser.uid);
            
            if (currentStatsView === '30days') {
                const dateFilter = new Date();
                dateFilter.setDate(dateFilter.getDate() - 30);
                console.log('Filtering trips after:', dateFilter);
                query = query.where('startTime', '>=', firebase.firestore.Timestamp.fromDate(dateFilter));
            }

            query.get()
                .then((snapshot) => {
                    console.log(`Found ${snapshot.size} trips for ${currentStatsView}`);
                    
                    const trips = [];
                    snapshot.forEach((doc) => {
                        const trip = doc.data();
                        trips.push(trip);
                        
                        if (trips.length <= 3) {
                            const tripDate = trip.startTime?.toDate ? trip.startTime.toDate() : new Date(trip.startTime);
                            console.log(`Trip on ${tripDate.toLocaleDateString()}: ${trip.route}`);
                        }
                    });

                    const totalTrips = trips.length;
                    const uniqueRoutes = new Set(trips.map(t => t.route)).size;
                    const totalMinutes = trips.reduce((sum, t) => sum + (t.duration || 0), 0);
                    const totalHours = Math.round(totalMinutes / 60 * 10) / 10;
                    
                    const stops = new Set();
                    trips.forEach(t => {
                        if (t.startStop) stops.add(t.startStop);
                        if (t.endStop) stops.add(t.endStop);
                    });
                    const uniqueStops = stops.size;

                    document.getElementById('statsTotalTrips').textContent = totalTrips;
                    document.getElementById('statsUniqueRoutes').textContent = uniqueRoutes;
                    document.getElementById('statsTotalTime').textContent = totalHours;
                    document.getElementById('statsUniqueStops').textContent = uniqueStops;

                    generateTopRoutes(trips);
                    generateTopStops(trips);
                })
                .catch((error) => {
                    console.error('Error updating stats:', error);
                    db.collection('trips').where('userId', '==', currentUser.uid).get().then((snapshot) => {
                        const trips = [];
                        snapshot.forEach((doc) => {
                            const trip = doc.data();
                            if (currentStatsView === '30days') {
                                const tripDate = trip.startTime?.toDate ? trip.startTime.toDate() : new Date(trip.startTime);
                                const thirtyDaysAgo = new Date();
                                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                                if (tripDate >= thirtyDaysAgo) {
                                    trips.push(trip);
                                }
                            } else {
                                trips.push(trip);
                            }
                        });
                        
                        const totalTrips = trips.length;
                        const uniqueRoutes = new Set(trips.map(t => t.route)).size;
                        const totalMinutes = trips.reduce((sum, t) => sum + (t.duration || 0), 0);
                        const totalHours = Math.round(totalMinutes / 60 * 10) / 10;
                        
                        const stops = new Set();
                        trips.forEach(t => {
                            if (t.startStop) stops.add(t.startStop);
                            if (t.endStop) stops.add(t.endStop);
                        });
                        const uniqueStops = stops.size;

                        document.getElementById('statsTotalTrips').textContent = totalTrips;
                        document.getElementById('statsUniqueRoutes').textContent = uniqueRoutes;
                        document.getElementById('statsTotalTime').textContent = totalHours;
                        document.getElementById('statsUniqueStops').textContent = uniqueStops;

                        generateTopRoutes(trips);
                        generateTopStops(trips);
                    });
                });
        }

        function updateProfileStats() {
            if (!currentUser) return;

            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((snapshot) => {
                    const trips = [];
                    snapshot.forEach((doc) => {
                        trips.push(doc.data());
                    });

                    const streakData = calculateStreaks(trips);
                    document.getElementById('profileCurrentStreak').textContent = streakData.current;
                    document.getElementById('profileBestStreak').textContent = streakData.best;

                    calculateFounderStats(trips);
                });
        }

        // FIXED: Profile trips loading with proper debugging
        function loadProfileTrips() {
            if (!currentUser) return;
            
            console.log('üîç Loading profile trips for user:', currentUser.uid);

            // Simplified query without orderBy to avoid index issues
            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((snapshot) => {
                    console.log('üìä Total trips found:', snapshot.size);
                    
                    if (snapshot.size === 0) {
                        console.log('‚ùå No trips found for user');
                        displayProfileTrips([]);
                        return;
                    }
                    
                    // Convert to array and sort in JavaScript
                    const trips = [];
                    snapshot.forEach((doc) => {
                        const trip = doc.data();
                        let startTime;
                        if (trip.startTime?.toDate) {
                            startTime = trip.startTime.toDate();
                        } else if (trip.startTime) {
                            startTime = new Date(trip.startTime);
                        } else {
                            startTime = new Date();
                        }
                        
                        trips.push({ 
                            id: doc.id, 
                            ...trip,
                            sortableStartTime: startTime
                        });
                    });
                    
                    // Sort by startTime descending (newest first)
                    trips.sort((a, b) => b.sortableStartTime - a.sortableStartTime);
                    
                    // Take only first 20
                    const recentTrips = trips.slice(0, 20);
                    
                    console.log('‚úÖ Displaying', recentTrips.length, 'recent trips');
                    displayProfileTrips(recentTrips);
                })
                .catch((error) => {
                    console.error('‚ùå Error loading profile trips:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    displayProfileTrips([]);
                });
        }

        function displayProfileTrips(trips) {
            const profileTripsList = document.getElementById('profileTripsList');
            
            if (trips.length === 0) {
                profileTripsList.innerHTML = '<div class="empty-state">No trips yet. Start your first trip!</div>';
                return;
            }

            const tripsHtml = trips.map(trip => {
                let startTime;
                if (trip.startTime?.toDate) {
                    startTime = trip.startTime.toDate();
                } else if (trip.startTime) {
                    startTime = new Date(trip.startTime);
                } else {
                    startTime = new Date();
                }
                
                return `
                    <div class="trip-item" data-trip-id="${trip.id}">
                        <div class="delete-overlay">Delete</div>
                        <div><strong>${trip.route || 'Unknown Route'}</strong></div>
                        <div>${trip.startStop || 'Unknown'} ‚Üí ${trip.endStop || 'Unknown'}</div>
                        <div>${trip.duration || 0} min ‚Ä¢ ${startTime.toLocaleDateString()}</div>
                    </div>
                `;
            }).join('');

            profileTripsList.innerHTML = tripsHtml;
            
            profileTripsList.querySelectorAll('.trip-item').forEach(item => {
                const tripId = item.getAttribute('data-trip-id');
                addSwipeToDelete(item, false, tripId);
            });
        }

        function calculateFounderStats(trips) {
            document.getElementById('profileFounderRoutes').textContent = '0';
            document.getElementById('profileFounderStops').textContent = '0';
        }

        function generateTopRoutes(trips) {
            const routeCounts = {};
            trips.forEach(trip => {
                const route = trip.route || 'Unknown';
                routeCounts[route] = (routeCounts[route] || 0) + 1;
            });

            const sortedRoutes = Object.entries(routeCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const topRoutesHtml = sortedRoutes.length > 0 ? 
                sortedRoutes.map(([route, count], index) => 
                    `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid var(--border-light);">
                        <span>${index + 1}. ${route}</span>
                        <span style="color: var(--accent-primary); font-weight: 600;">${count} trips</span>
                    </div>`
                ).join('') : 
                '<div style="color: var(--text-muted); font-style: italic;">No trips yet</div>';

            document.getElementById('topRoutes').innerHTML = topRoutesHtml;
        }

        function generateTopStops(trips) {
            const stopCounts = {};
            trips.forEach(trip => {
                const startStop = trip.startStop || 'Unknown';
                const endStop = trip.endStop || 'Unknown';
                stopCounts[startStop] = (stopCounts[startStop] || 0) + 1;
                stopCounts[endStop] = (stopCounts[endStop] || 0) + 1;
            });

            const sortedStops = Object.entries(stopCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const topStopsHtml = sortedStops.length > 0 ? 
                sortedStops.map(([stop, count], index) => 
                    `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid var(--border-light);">
                        <span>${index + 1}. ${stop}</span>
                        <span style="color: var(--accent-primary); font-weight: 600;">${count} uses</span>
                    </div>`
                ).join('') : 
                '<div style="color: var(--text-muted); font-style: italic;">No trips yet</div>';

            document.getElementById('topStops').innerHTML = topStopsHtml;
        }

        function loadCommunityData() {
            const dateFilter = new Date();
            if (currentStatsView === '30days') {
                dateFilter.setDate(dateFilter.getDate() - 30);
            } else {
                dateFilter.setFullYear(dateFilter.getFullYear() - 10);
            }

            db.collection('trips')
                .where('startTime', '>=', firebase.firestore.Timestamp.fromDate(dateFilter))
                .get()
                .then((snapshot) => {
                    const allTrips = [];
                    const userTrips = [];
                    
                    snapshot.forEach((doc) => {
                        const trip = doc.data();
                        allTrips.push(trip);
                        if (trip.userId === currentUser.uid) {
                            userTrips.push(trip);
                        }
                    });

                    const totalUsers = new Set(allTrips.map(t => t.userId)).size;
                    const userRank = calculateUserRank(userTrips.length, allTrips);
                    const avgTripsPerUser = totalUsers > 0 ? Math.round(allTrips.length / totalUsers * 10) / 10 : 0;
                    
                    const timeLabel = currentStatsView === '30days' ? '30 days' : 'all time';

                    const communityHtml = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="font-size: 1.8em; font-weight: bold; color: var(--accent-primary);">${userTrips.length}</div>
                                <div style="font-size: 0.9em; color: var(--text-secondary);">Your trips (${timeLabel})</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="font-size: 1.8em; font-weight: bold; color: var(--accent-primary);">#${userRank}</div>
                                <div style="font-size: 0.9em; color: var(--text-secondary);">Your rank</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="font-size: 1.8em; font-weight: bold; color: var(--accent-primary);">${totalUsers}</div>
                                <div style="font-size: 0.9em; color: var(--text-secondary);">Total users</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="font-size: 1.8em; font-weight: bold; color: var(--accent-primary);">${avgTripsPerUser}</div>
                                <div style="font-size: 0.9em; color: var(--text-secondary);">Avg trips/user</div>
                            </div>
                        </div>
                    `;

                    document.getElementById('communityStats').innerHTML = communityHtml;
                })
                .catch((error) => {
                    console.error('Error loading community data:', error);
                    document.getElementById('communityStats').innerHTML = '<div style="color: var(--text-muted); font-style: italic;">Unable to load community data</div>';
                });
        }

        function calculateUserRank(userTripCount, allTrips) {
            const userCounts = {};
            allTrips.forEach(trip => {
                userCounts[trip.userId] = (userCounts[trip.userId] || 0) + 1;
            });

            const sortedCounts = Object.values(userCounts).sort((a, b) => b - a);
            const rank = sortedCounts.findIndex(count => count <= userTripCount) + 1;
            return rank || sortedCounts.length + 1;
        }

        function calculateStreaks(trips) {
            if (trips.length === 0) return { current: 0, best: 0 };

            const sortedTrips = trips.sort((a, b) => {
                const dateA = a.startTime?.toDate ? a.startTime.toDate() : new Date(a.startTime);
                const dateB = b.startTime?.toDate ? b.startTime.toDate() : new Date(b.startTime);
                return dateB - dateA;
            });

            const tripDays = new Set();
            sortedTrips.forEach(trip => {
                const date = trip.startTime?.toDate ? trip.startTime.toDate() : new Date(trip.startTime);
                const dayString = date.toDateString();
                tripDays.add(dayString);
            });

            const uniqueDays = Array.from(tripDays).sort((a, b) => new Date(b) - new Date(a));

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayString = today.toDateString();
            
            if (uniqueDays.length === 1 && uniqueDays[0] === todayString) {
                return { current: 0, best: 0 };
            }

            let currentStreak = 0;
            let bestStreak = 0;
            let tempStreak = 0;

            for (let i = 0; i < uniqueDays.length; i++) {
                const currentDay = new Date(uniqueDays[i]);
                currentDay.setHours(0, 0, 0, 0);

                if (i === 0) {
                    const diffDays = Math.floor((today - currentDay) / (1000 * 60 * 60 * 24));
                    if (diffDays <= 1) {
                        currentStreak = 1;
                        tempStreak = 1;
                    }
                } else {
                    const prevDay = new Date(uniqueDays[i - 1]);
                    prevDay.setHours(0, 0, 0, 0);
                    const diffDays = Math.floor((prevDay - currentDay) / (1000 * 60 * 60 * 24));

                    if (diffDays === 1) {
                        tempStreak++;
                        if (i === 0 || currentStreak > 0) {
                            currentStreak = tempStreak;
                        }
                    } else {
                        bestStreak = Math.max(bestStreak, tempStreak);
                        tempStreak = 1;
                        if (currentStreak > 0 && i > 0) {
                            currentStreak = 0;
                        }
                    }
                }
            }

            bestStreak = Math.max(bestStreak, tempStreak, currentStreak);
            return { current: currentStreak, best: bestStreak };
        }

        // Template Management
        function loadTemplates() {
            if (!currentUser) return;

            db.collection('templates')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get()
                .then((snapshot) => {
                    const templates = [];
                    snapshot.forEach((doc) => {
                        templates.push({ id: doc.id, ...doc.data() });
                    });
                    
                    displayTemplates(templates);
                    displayProfileTemplates(templates);
                })
                .catch((error) => {
                    console.error('Error loading templates:', error);
                    displayTemplates([]);
                    displayProfileTemplates([]);
                });
        }

        function displayTemplates(templates) {
            const templatesSection = document.getElementById('templatesSection');
            const templatesList = document.getElementById('templatesList');
            
            if (templates.length === 0) {
                templatesSection.style.display = 'none';
                return;
            }
            
            templatesSection.style.display = 'block';
            
            const templatesHtml = templates.slice(0, 3).map(template => `
                <div class="template-card" onclick="startFromTemplate('${template.route}', '${template.startStop}')">
                    <span class="template-icon">‚≠ê</span>
                    <div class="route-name">${template.route}</div>
                    <div class="stop-name">From ${template.startStop}</div>
                </div>
            `).join('');
            
            templatesList.innerHTML = templatesHtml;
        }

        function displayProfileTemplates(templates) {
            const profileTemplatesList = document.getElementById('profileTemplatesList');
            
            if (templates.length === 0) {
                profileTemplatesList.innerHTML = '<div class="empty-state">No saved templates yet</div>';
                return;
            }
            
            const templatesHtml = templates.map(template => `
                <div class="trip-item" data-template-id="${template.id}">
                    <div class="delete-overlay">Delete</div>
                    <div><strong>${template.route}</strong></div>
                    <div>From ${template.startStop}</div>
                    <div style="font-size: 0.9em; color: var(--text-secondary);">‚≠ê Quick start template</div>
                </div>
            `).join('');
            
            profileTemplatesList.innerHTML = templatesHtml;
            
            profileTemplatesList.querySelectorAll('.trip-item').forEach(item => {
                const templateId = item.getAttribute('data-template-id');
                addSwipeToDelete(item, true, templateId);
            });
        }

        function startFromTemplate(route, startStop) {
            stopInput.value = startStop;
            routeInput.value = route;
            updateStartButton();
            
            stopInput.style.background = '#e8f5e8';
            routeInput.style.background = '#e8f5e8';
            
            setTimeout(() => {
                stopInput.style.background = '';
                routeInput.style.background = '';
            }, 500);
            
            startBtn.focus();
        }

        function deleteTemplate(templateId) {
            if (confirm('Delete this template?')) {
                db.collection('templates').doc(templateId).delete()
                    .then(() => {
                        loadTemplates();
                    })
                    .catch((error) => {
                        console.error('Error deleting template:', error);
                        alert('Error deleting template');
                    });
            }
        }

        function scrollToTemplates() {
            setTimeout(() => {
                const templatesSection = document.getElementById('templatesManagement');
                if (templatesSection) {
                    templatesSection.scrollIntoView({ behavior: 'smooth' });
                }
            }, 100);
        }

        function goToActiveTrip() {
            hideAllSections();
            showActiveSection();
        }
        
        function deleteTrip(tripId) {
            if (confirm('Are you sure you want to delete this trip?')) {
                db.collection('trips').doc(tripId).delete()
                    .then(() => {
                        alert('Trip deleted');
                        loadTrips();
                        loadProfileTrips();
                        updateProfileStats();
                    })
                    .catch((error) => {
                        console.error('Error deleting trip:', error);
                        alert('Error deleting trip');
                    });
            }
        }

        // Authentication Event Handlers
        continueBtn.addEventListener('click', () => {
            const email = emailInput.value.trim();
            if (!email) {
                alert('Please enter your email');
                return;
            }
            
            document.getElementById('emailDisplay').textContent = email;
            document.getElementById('emailStep').style.display = 'none';
            document.getElementById('authMethodStep').style.display = 'block';
        });

        emailInput.addEventListener('input', () => {
            const email = emailInput.value.trim();
            continueBtn.disabled = !email || !email.includes('@');
        });

        emailInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !continueBtn.disabled) {
                continueBtn.click();
            }
        });

        function goBackToEmail() {
            document.getElementById('emailStep').style.display = 'block';
            document.getElementById('authMethodStep').style.display = 'none';
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('authButtons').style.display = 'flex';
            document.getElementById('signInBtn').style.display = 'none';
            emailInput.value = '';
            passwordInput.value = '';
        }

        // Password authentication handler
        passwordBtn.addEventListener('click', () => {
            document.getElementById('authMethodStep').style.display = 'none';
            document.getElementById('passwordGroup').style.display = 'block';
            passwordInput.focus();
        });

        // Sign in with password
        signInBtn.addEventListener('click', () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            if (!password) {
                alert('Please enter your password');
                return;
            }

            signInBtn.disabled = true;
            signInBtn.textContent = 'Signing in...';

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    console.log('‚úÖ Signed in successfully');
                })
                .catch((error) => {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        // Try to create account instead
                        auth.createUserWithEmailAndPassword(email, password)
                            .then(() => {
                                console.log('‚úÖ Account created successfully');
                            })
                            .catch((createError) => {
                                alert('Error: ' + createError.message);
                                signInBtn.disabled = false;
                                signInBtn.textContent = 'Sign In';
                            });
                    } else {
                        alert('Error: ' + error.message);
                        signInBtn.disabled = false;
                        signInBtn.textContent = 'Sign In';
                    }
                });
        });

        // Magic link handler
        magicLinkBtn.addEventListener('click', () => {
            const email = emailInput.value.trim();

            const actionCodeSettings = {
                url: window.location.href,
                handleCodeInApp: true
            };

            auth.sendSignInLinkToEmail(email, actionCodeSettings)
                .then(() => {
                    window.localStorage.setItem('emailForSignIn', email);
                    alert('Magic link sent! Check your email.');
                    goBackToEmail();
                })
                .catch((error) => {
                    alert('Error sending magic link: ' + error.message);
                });
        });

        // Check for magic link on page load
        if (auth.isSignInWithEmailLink(window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn');
            if (!email) {
                email = window.prompt('Please provide your email for confirmation');
            }

            auth.signInWithEmailLink(email, window.location.href)
                .then(() => {
                    window.localStorage.removeItem('emailForSignIn');
                    window.history.replaceState({}, document.title, window.location.pathname);
                })
                .catch((error) => {
                    console.error('Error signing in with email link:', error);
                });
        }

        // Password input enter key
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                signInBtn.click();
            }
        });

        // Initialize app on authentication
        function initializeApp() {
            loadTemplates();
            checkActiveTrip();
            loadLastTrip();
            loadTrips();
        }

        function loadLastTrip() {
            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .where('endStop', '!=', null)
                .orderBy('endTime', 'desc')
                .limit(1)
                .get()
                .then((snapshot) => {
                    if (!snapshot.empty) {
                        const lastTrip = snapshot.docs[0].data();
                        repeatLastTripSection.style.display = 'block';
                        repeatLastTripBtn.onclick = () => {
                            stopInput.value = lastTrip.startStop;
                            routeInput.value = lastTrip.route;
                            updateStartButton();

                            stopInput.style.background = '#e8f5e8';
                            routeInput.style.background = '#e8f5e8';

                            setTimeout(() => {
                                stopInput.style.background = '';
                                routeInput.style.background = '';
                            }, 500);

                            startBtn.focus();
                            showNotification(`Ready to board ${lastTrip.route} from ${lastTrip.startStop}`);
                        };
                    } else {
                        repeatLastTripSection.style.display = 'none';
                    }
                })
                .catch((error) => {
                    console.error('Error loading last trip:', error);
                    repeatLastTripSection.style.display = 'none';
                });
        }

        function loadTrips() {
            const recentTripsSection = document.getElementById('recentTripsSection');
            const recentTripsList = document.getElementById('recentTripsList');

            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .where('endStop', '!=', null)
                .orderBy('endTime', 'desc')
                .limit(5)
                .get()
                .then((snapshot) => {
                    if (!snapshot.empty) {
                        recentTripsSection.style.display = 'block';
                        recentTripsList.innerHTML = '';

                        snapshot.forEach((doc) => {
                            const trip = doc.data();
                            const endTime = trip.endTime ? trip.endTime.toDate() : new Date();
                            const dateStr = endTime.toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric'
                            });
                            const duration = trip.duration || 0;

                            const tripDiv = document.createElement('div');
                            tripDiv.className = 'trip-item';
                            tripDiv.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${trip.route}</div>
                                        <div style="font-size: 0.9em; color: var(--text-secondary);">${trip.startStop} ‚Üí ${trip.endStop}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.85em; color: var(--text-muted);">${dateStr}</div>
                                        <div style="font-size: 0.85em; color: var(--text-secondary);">${duration} min</div>
                                    </div>
                                </div>
                            `;
                            recentTripsList.appendChild(tripDiv);
                        });
                    } else {
                        recentTripsSection.style.display = 'none';
                    }
                })
                .catch((error) => {
                    console.error('Error loading trips:', error);
                    recentTripsSection.style.display = 'none';
                });
        }

        function checkActiveTrip() {
            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .where('endStop', '==', null)
                .limit(1)
                .get()
                .then((snapshot) => {
                    if (!snapshot.empty) {
                        const doc = snapshot.docs[0];
                        activeTrip = { id: doc.id, ...doc.data() };
                        showActiveSection();
                        updateActiveTripBanner();
                    } else {
                        activeTrip = null;
                        showStartSection();
                        updateActiveTripBanner();
                    }
                })
                .catch((error) => {
                    console.error('Error checking active trip:', error);
                    showStartSection();
                });
        }

        function showStartSection() {
            startSection.style.display = 'block';
            activeSection.style.display = 'none';
        }

        function showActiveSection() {
            startSection.style.display = 'none';
            activeSection.style.display = 'block';

            if (activeTrip) {
                const startTime = activeTrip.startTime.toDate();
                const now = new Date();
                const elapsed = Math.floor((now - startTime) / 1000 / 60);

                currentTripDiv.innerHTML = `
                    <div class="current-trip-info">
                        <div style="font-size: 1.2em; margin-bottom: 5px;">${activeTrip.route}</div>
                        <div style="color: var(--text-secondary);">From ${activeTrip.startStop}</div>
                        <div style="color: var(--text-secondary); font-size: 0.9em; margin-top: 5px;">
                            ${elapsed} minute${elapsed !== 1 ? 's' : ''} ago
                        </div>
                    </div>
                `;
            }
        }

        function updateActiveTripBanner() {
            if (activeTrip) {
                activeTripBanner.style.display = 'block';
                activeTripBanner.onclick = goToActiveTrip;
            } else {
                activeTripBanner.style.display = 'none';
            }
        }

        function updateStartButton() {
            const stop = stopInput.value.trim();
            const route = routeInput.value.trim();
            startBtn.disabled = !stop || !route;
        }

        // Navigation button handlers
        profileBtn.addEventListener('click', showProfile);
        statsBtn.addEventListener('click', showStats);
        mapsBtn.addEventListener('click', showMaps);

        // Input validation for start trip
        stopInput.addEventListener('input', updateStartButton);
        routeInput.addEventListener('input', updateStartButton);

        // Start trip handler
        startBtn.addEventListener('click', () => {
            const stop = stopInput.value.trim();
            const route = routeInput.value.trim();

            if (!stop || !route) {
                alert('Please enter both stop and route');
                return;
            }

            // Check if user is authenticated
            if (!currentUser) {
                alert('You must be signed in to start a trip. Please refresh the page and try again.');
                return;
            }

            startBtn.disabled = true;
            startBtn.textContent = 'Starting...';

            getCurrentLocation((location) => {
                const tripData = {
                    userId: currentUser.uid,
                    route: route,
                    startStop: stop,
                    endStop: null,
                    startTime: firebase.firestore.Timestamp.now(),
                    boardingLocation: location
                };

                db.collection('trips').add(tripData)
                    .then((docRef) => {
                        activeTrip = { id: docRef.id, ...tripData };
                        stopInput.value = '';
                        routeInput.value = '';
                        startBtn.disabled = false;
                        startBtn.textContent = 'Board Vehicle';
                        showActiveSection();
                        updateActiveTripBanner();
                        trackRouteStopUsage(route, stop);
                    })
                    .catch((error) => {
                        console.error('Error starting trip:', error);

                        // Provide specific error messages
                        let errorMessage = 'Error starting trip. ';

                        if (error.code === 'permission-denied') {
                            errorMessage += 'You do not have permission to save trips. Please check your account settings.';
                        } else if (error.code === 'unavailable') {
                            errorMessage += 'Cannot connect to the server. Please check your internet connection and try again.';
                        } else if (error.code === 'unauthenticated') {
                            errorMessage += 'You must be signed in. Please refresh the page and try again.';
                        } else if (error.message && error.message.includes('quota')) {
                            errorMessage += 'Storage quota exceeded. Please contact support.';
                        } else if (error.message) {
                            errorMessage += error.message;
                        } else {
                            errorMessage += 'Please try again.';
                        }

                        alert(errorMessage);
                        startBtn.disabled = false;
                        startBtn.textContent = 'Board Vehicle';
                    });
            });
        });

        // End trip button
        endBtn.addEventListener('click', () => {
            endModal.style.display = 'block';
            exitInput.focus();
        });

        // Cancel end trip
        cancelBtn.addEventListener('click', () => {
            endModal.style.display = 'none';
            exitInput.value = '';
            document.getElementById('saveAsTemplate').checked = false;
        });

        // Save trip (end trip)
        saveBtn.addEventListener('click', () => {
            const exitStop = exitInput.value.trim();

            if (!exitStop) {
                alert('Please enter exit stop');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            getCurrentLocation((location) => {
                const startTime = activeTrip.startTime.toDate();
                const endTime = new Date();
                const duration = Math.floor((endTime - startTime) / 1000 / 60);

                const updateData = {
                    endStop: exitStop,
                    endTime: firebase.firestore.Timestamp.now(),
                    exitLocation: location,
                    duration: duration
                };

                db.collection('trips').doc(activeTrip.id).update(updateData)
                    .then(() => {
                        const shouldSaveTemplate = document.getElementById('saveAsTemplate').checked;

                        if (shouldSaveTemplate) {
                            saveAsTemplate(activeTrip.route, activeTrip.startStop);
                        }

                        activeTrip = null;
                        exitInput.value = '';
                        document.getElementById('saveAsTemplate').checked = false;
                        endModal.style.display = 'none';
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Save';
                        showStartSection();
                        updateActiveTripBanner();
                        loadTemplates();
                        updateStreakStatus();
                        loadTrips();
                        loadLastTrip();
                    })
                    .catch((error) => {
                        console.error('Error ending trip:', error);
                        alert('Error ending trip. Please try again.');
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Save';
                    });
            });
        });

        // Cancel active trip
        document.getElementById('cancelTrip').addEventListener('click', () => {
            if (confirm('Are you sure you want to cancel this trip?')) {
                db.collection('trips').doc(activeTrip.id).delete()
                    .then(() => {
                        activeTrip = null;
                        showStartSection();
                        updateActiveTripBanner();
                    })
                    .catch((error) => {
                        console.error('Error canceling trip:', error);
                        alert('Error canceling trip');
                    });
            }
        });

        function saveAsTemplate(route, startStop) {
            db.collection('templates').add({
                userId: currentUser.uid,
                route: route,
                startStop: startStop,
                createdAt: firebase.firestore.Timestamp.now()
            }).catch((error) => {
                console.error('Error saving template:', error);
            });
        }

        function trackRouteStopUsage(route, startStop) {
            // Track usage for auto-save templates
            const key = `${route}|${startStop}`;
            const usageKey = 'routeStopUsage_' + currentUser.uid;

            let usage = JSON.parse(localStorage.getItem(usageKey) || '{}');
            usage[key] = (usage[key] || 0) + 1;
            localStorage.setItem(usageKey, JSON.stringify(usage));

            // Auto-save after 3+ uses
            if (usage[key] === 3) {
                checkAndAutoSaveTemplate(route, startStop);
            }
        }

        function checkAndAutoSaveTemplate(route, startStop) {
            // Check if template already exists
            db.collection('templates')
                .where('userId', '==', currentUser.uid)
                .where('route', '==', route)
                .where('startStop', '==', startStop)
                .get()
                .then((snapshot) => {
                    if (snapshot.empty) {
                        saveAsTemplate(route, startStop);
                        showNotification(`Template saved: ${route} from ${startStop}`);
                        loadTemplates();
                    }
                })
                .catch((error) => {
                    console.error('Error checking template:', error);
                });
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 70px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--success);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideDown 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function getCurrentLocation(callback) {
            if ('geolocation' in navigator) {
                locationStatus.textContent = 'üìç Getting location...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        locationStatus.textContent = 'üìç Location enabled';
                        callback({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        });
                    },
                    (error) => {
                        console.log('Location error:', error.message);
                        locationStatus.textContent = 'üìç Location unavailable';
                        callback(null);
                    },
                    { timeout: 10000, maximumAge: 60000 }
                );
            } else {
                locationStatus.textContent = 'üìç Location not supported';
                callback(null);
            }
        }

        function updateConnectionStatus(isConnected) {
            if (isConnected) {
                authStatus.textContent = currentUser ? currentUser.email : '';
                connectionStatus.textContent = 'üü¢ Connected';
                connectionStatus.style.cursor = 'pointer';
                connectionStatus.onclick = toggleLogoutMode;
            } else {
                authStatus.textContent = '';
                connectionStatus.textContent = 'üî¥ Sign in required';
                connectionStatus.style.cursor = 'default';
                connectionStatus.onclick = null;
            }
        }

        function toggleLogoutMode() {
            logoutModeActive = !logoutModeActive;

            if (logoutModeActive) {
                connectionStatus.textContent = '‚ö†Ô∏è Tap again to logout';
                connectionStatus.style.background = 'var(--error)';
                connectionStatus.style.color = 'white';

                setTimeout(() => {
                    if (logoutModeActive) {
                        logoutModeActive = false;
                        connectionStatus.textContent = 'üü¢ Connected';
                        connectionStatus.style.background = '';
                        connectionStatus.style.color = '';
                    }
                }, 3000);
            } else {
                auth.signOut();
            }
        }

        function updateStreakStatus() {
            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .where('endStop', '!=', null)
                .orderBy('endStop')
                .orderBy('endTime', 'desc')
                .get()
                .then((snapshot) => {
                    const trips = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    const streaks = calculateStreaks(trips);

                    if (streaks.current > 0) {
                        streakStatus.style.display = 'block';
                        streakStatus.textContent = `üî• ${streaks.current} day streak!`;
                    } else {
                        streakStatus.style.display = 'none';
                    }
                })
                .catch((error) => {
                    console.error('Error updating streak:', error);
                });
        }

        function addSwipeToDelete(element, isTemplate, id) {
            let startX = 0;
            let currentX = 0;
            let isSwiping = false;

            element.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                isSwiping = true;
            });

            element.addEventListener('touchmove', (e) => {
                if (!isSwiping) return;
                currentX = e.touches[0].clientX;
                const diff = startX - currentX;

                if (diff > 0) {
                    element.style.transform = `translateX(-${Math.min(diff, 80)}px)`;
                }
            });

            element.addEventListener('touchend', () => {
                const diff = startX - currentX;

                if (diff > 80) {
                    element.style.transform = 'translateX(-80px)';
                    showDeleteButton(element, isTemplate, id);
                } else {
                    element.style.transform = 'translateX(0)';
                }

                isSwiping = false;
            });
        }

        function showDeleteButton(element, isTemplate, id) {
            const existing = element.querySelector('.delete-btn');
            if (existing) return;

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'Delete';
            deleteBtn.style.cssText = `
                position: absolute;
                right: 0;
                top: 0;
                height: 100%;
                width: 80px;
                background: var(--error);
                color: white;
                border: none;
                cursor: pointer;
            `;

            deleteBtn.onclick = () => {
                if (isTemplate) {
                    deleteTemplate(id);
                } else {
                    deleteTrip(id);
                }
            };

            element.style.position = 'relative';
            element.appendChild(deleteBtn);
        }

        // Load saved theme on startup
        loadSavedTheme();

        console.log('‚úÖ TransitStats Ready!');
    </script>
</body>
</html>
