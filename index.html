<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransitStats</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
</head>

<body>
    <div class="main-content">
        <div class="header">
            <div class="header-row">
                <h1 class="header-title" onclick="goHome()">TransitStats</h1>
                <div id="userInfo" class="user-info" style="display: none;">
                    <button id="profileBtn" class="header-btn" onclick="showProfile()">üë§<span>Profile</span></button>
                    <button id="statsBtn" class="header-btn" onclick="showStats()">üìä<span>Trips</span></button>
                    <button id="mapsBtn" class="header-btn" onclick="showMaps()">üó∫Ô∏è<span>Map</span></button>
                    <button id="settingsBtn" class="header-btn"
                        onclick="openSettings()">‚öôÔ∏è<span>Settings</span></button>
                    <button id="adminBtn" class="header-btn"
                        onclick="window.location.href='admin.html'">üõ†Ô∏è<span>Admin</span></button>
                    <button id="logTripBtn" class="header-btn primary-action" onclick="openLogTripModal()">‚ûï<span>Log
                            Trip</span></button>
                </div>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="container">
                <div id="authSection" class="section auth-section">
                    <h2>Welcome to TransitStats</h2>
                    <p style="font-size: 0.85em; color: var(--text-muted);">Invite-only. Contact hey@ryanisnota.pro for
                        access.</p>
                    <p>Sign in to sync your trips across all devices</p>

                    <div id="emailStep">
                        <div class="form-group">
                            <input type="email" id="emailInput" placeholder="Enter your email address">
                        </div>
                        <button id="continueBtn" class="btn btn-primary" disabled>Continue</button>
                    </div>

                    <div id="authMethodStep" style="display: none;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 1.1em; color: var(--text-primary); margin-bottom: 5px;"
                                id="emailDisplay"></div>
                            <button
                                style="background: none; border: none; color: var(--accent-primary); font-size: 0.9em; cursor: pointer; text-decoration: underline;"
                                onclick="goBackToEmail()">Change email</button>
                        </div>

                        <div class="form-group" id="passwordGroup" style="display: none;">
                            <input type="password" id="passwordInput" placeholder="Enter password">
                            <div style="text-align: center; margin-top: 10px;">
                                <button
                                    style="background: none; border: none; color: var(--accent-primary); font-size: 0.9em; cursor: pointer; text-decoration: underline;"
                                    onclick="sendPasswordReset()">Forgot Password?</button>
                            </div>
                        </div>

                        <div id="authButtons" style="display: flex; gap: 10px;">
                            <button id="magicLinkBtn" class="btn btn-primary" style="flex: 1;">‚ú® Magic Link</button>
                            <button id="passwordBtn" class="btn btn-outline" style="flex: 1;">üîë Password</button>
                        </div>

                        <button id="signInBtn" class="btn btn-primary" style="display: none; margin-top: 10px;">Sign
                            In</button>
                    </div>

                    <div id="authStatus" class="auth-status" style="display: none;"></div>
                </div>

                <div id="appContent" style="display: none;">
                    <div class="dashboard-grid">

                        <!-- LEFT COLUMN: Profile & Context -->
                        <div class="col-left">
                            <div id="profileSection" class="section">
                                <h2 style="white-space: nowrap; margin-bottom: 20px;">üë§ Profile</h2>

                                <div class="profile-dashboard-grid">
                                    <!-- Identity Card -->
                                    <div class="profile-card identity-card"
                                        style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; text-align: center; border: 1px solid var(--border-light);">
                                        <div style="font-size: 3em; margin-bottom: 8px;" id="displayAvatar">üöå</div>
                                        <h2 id="displayName" style="margin-bottom: 0; font-size: 1.5em;">User</h2>
                                        <div id="displayAgency" style="display: none;">TTC</div>
                                    </div>

                                    <!-- Streak Stats -->
                                    <div class="profile-card"
                                        style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e6b 100%); border-radius: 10px; padding: 12px 16px; color: white; text-align: center;">
                                        <div style="display: flex; justify-content: space-around; align-items: center;">
                                            <div>
                                                <div style="font-size: 1.4em; font-weight: bold;"
                                                    id="profileCurrentStreak">0</div>
                                                <div style="font-size: 0.75em; opacity: 0.85;">Current</div>
                                            </div>
                                            <div style="font-size: 1em; opacity: 0.9;">üî•</div>
                                            <div>
                                                <div style="font-size: 1.4em; font-weight: bold;"
                                                    id="profileBestStreak">0</div>
                                                <div style="font-size: 0.75em; opacity: 0.85;">Best</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="profile-content-grid" style="margin-top: 20px;">
                                    <!-- Templates -->
                                    <div id="templatesManagement"
                                        style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color);">
                                        <h3 style="margin-bottom: 15px; color: var(--text-primary);">‚≠ê Trip Templates
                                        </h3>
                                        <div id="profileTemplatesList">
                                            <div class="loading">Loading templates...</div>
                                        </div>
                                    </div>

                                    <!-- Hidden Trips List (Logic wrapper, not visible) -->
                                    <div id="profileTripsListWrapper" style="display: none;">
                                        <div id="profileTripsList"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CENTER COLUMN: Visual & Action -->
                        <div class="col-center">

                            <!-- Banners Container -->
                            <div id="bannersContainer" class="banner-container full-width">
                                <div id="streakStatus" class="streak-status">‚ö° Take your first trip to start tracking!
                                </div>
                                <div id="activeTripBanner" class="active-trip-banner" style="display: none;"
                                    onclick="goToActiveTrip()">
                                    üöå Currently riding ‚Ä¢ Tap to view
                                </div>
                            </div>

                            <!-- Repeat Last Trip Section -->
                            <div id="repeatLastTripSection" style="display: none; margin-bottom: 15px;">
                                <button id="repeatLastTripBtn" class="btn btn-primary"
                                    style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);">
                                    üîÑ Repeat Last Trip
                                </button>
                            </div>


                            <!-- Recent Trips Feed -->
                            <div class="section">
                                <h3 style="margin-bottom: 15px;">üìú Recent Trips</h3>
                                <div id="recentTripsList" class="news-feed">
                                    <div class="loading">Loading trips...</div>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT COLUMN: Stats & Leaderboards -->
                        <div class="col-right">
                            <div id="statsSection" class="section">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h2>üìä Stats</h2>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <div
                                            style="background: var(--bg-tertiary); border-radius: 20px; padding: 4px; display: flex;">
                                            <button id="statsToggle30" class="btn"
                                                style="background: var(--accent-primary); color: white; padding: 6px 12px; margin: 0; border-radius: 16px; font-size: 0.8em;">30d</button>
                                            <button id="statsToggleAll" class="btn btn-outline"
                                                style="padding: 6px 12px; margin: 0; border: none; font-size: 0.8em;">All</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- General Stats Grid -->
                                <div class="stats-grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div class="stat-card" style="padding: 12px;">
                                        <div class="stat-number" id="statsTotalTrips" style="font-size: 1.4em;">0</div>
                                        <div class="stat-label">Trips</div>
                                    </div>
                                    <div class="stat-card" style="padding: 12px;">
                                        <div class="stat-number" id="statsUniqueRoutes" style="font-size: 1.4em;">0
                                        </div>
                                        <div class="stat-label">Routes</div>
                                    </div>
                                    <div class="stat-card" style="padding: 12px;">
                                        <div class="stat-number" id="statsTotalTime" style="font-size: 1.4em;">0</div>
                                        <div class="stat-label">Hours</div>
                                    </div>
                                    <div class="stat-card" style="padding: 12px;">
                                        <div class="stat-number" id="statsUniqueStops" style="font-size: 1.4em;">0</div>
                                        <div class="stat-label">Stops</div>
                                    </div>
                                </div>
                                <button id="exportCsvBtn" onclick="exportTripsToCSV()" class="btn btn-outline"
                                    style="width: 100%; margin-top: 10px; font-size: 0.9em;">
                                    üì• Export Data
                                </button>
                            </div>

                            <!-- Top Routes -->
                            <div class="section">
                                <h3>üöå Top Routes</h3>
                                <div id="topRoutesList">
                                    <div class="loading">Loading...</div>
                                </div>
                            </div>

                            <!-- Top Stops -->
                            <div class="section">
                                <h3>üöè Top Stops</h3>
                                <div id="topStopsList">
                                    <div class="loading">Loading...</div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Dedicated Map Page -->
                    <div id="mapPage" class="map-page" style="display: none;">
                        <!-- Filter Bar -->
                        <div class="map-filter-bar">
                            <div class="map-filters">
                                <button id="filterBoarding" class="filter-btn active" onclick="setMapFilter('boarding')">Boarding</button>
                                <button id="filterExiting" class="filter-btn" onclick="setMapFilter('exiting')">Exiting</button>
                                <button id="filterBoth" class="filter-btn" onclick="setMapFilter('both')">Both</button>
                            </div>
                            <button id="locateBtn" class="locate-btn" onclick="locateUser()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M12 2v4m0 12v4m10-10h-4M6 12H2"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Full Width Map Container -->
                        <div id="fullMapContainer"></div>

                        <!-- Stats Footer -->
                        <div class="map-stats-footer">
                            <span id="mapTripCount">0 trips</span>
                            <span class="map-stat-divider">‚Ä¢</span>
                            <span id="mapLocationCount">0 locations</span>
                            <span class="map-stat-divider">‚Ä¢</span>
                            <span id="mapCoverage">0% GPS coverage</span>
                        </div>
                    </div>

                    <div id="endModal"
                        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%; -50%); background: var(--bg-secondary); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; border: 1px solid var(--border-color);">
                            <h3>End Trip</h3>
                            <div class="form-group">
                                <label>Exit Stop</label>
                                <input type="text" id="exitInput" placeholder="e.g., 1234 or King Station">
                            </div>
                            <div class="save-template-checkbox">
                                <input type="checkbox" id="saveAsTemplate">
                                <label for="saveAsTemplate">‚≠ê Save route + start stop as template</label>
                            </div>
                            <button id="saveBtn" class="btn btn-primary">Save Trip</button>
                            <button id="cancelBtn" class="btn" style="background: var(--border-color);">Cancel</button>
                        </div>
                    </div>


                </div>
            </div>

            <!-- Log Trip Modal -->
            <div id="logTripModal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-secondary); padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">üöå Start New Trip</h3>
                        <button onclick="closeLogTripModal()"
                            style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary);">√ó</button>
                    </div>

                    <div class="form-group">
                        <label>Route/Line</label>
                        <input type="text" id="routeInput" placeholder="e.g., 65, Line 1, 504 King"
                            style="font-size: 1.1em; padding: 12px;">
                    </div>

                    <div class="form-group">
                        <label>Boarding Stop</label>
                        <input type="text" id="stopInput" placeholder="e.g., 6638 or King St"
                            style="font-size: 1.1em; padding: 12px;">
                        <div id="stopPreview" class="preview-box" style="display: none;"></div>
                    </div>

                    <!-- Quick Templates -->
                    <div id="quickTemplates"
                        style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px;">
                        <!-- Templates injected here -->
                    </div>

                    <button id="startBtn" class="btn btn-primary"
                        style="width: 100%; padding: 14px; font-size: 1.1em;">Board Vehicle üöå</button>
                </div>
            </div>

            <!-- Settings Modal -->
            <div id="settingsModal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-secondary); padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; border: 1px solid var(--border-color); max-height: 90vh; overflow-y: auto;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">‚öôÔ∏è Settings</h3>
                        <button onclick="closeSettings()"
                            style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary);">√ó</button>
                    </div>

                    <h4
                        style="margin-bottom: 15px; color: var(--text-secondary); text-transform: uppercase; font-size: 0.85em; letter-spacing: 0.5px;">
                        Profile</h4>

                    <div style="text-align: center; margin-bottom: 20px;">
                        <div
                            style="font-size: 3em; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span id="settingsAvatar">üöå</span>
                            <button id="shuffleEmojiBtn" onclick="shuffleEmoji()"
                                style="background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 50%; padding: 8px; font-size: 0.5em; cursor: pointer; width: 30px; height: 30px; display: none;">üé≤</button>
                        </div>
                        <div id="emojiSelector">
                            <label
                                style="display: block; margin-bottom: 10px; font-size: 0.9em; color: var(--text-secondary);">Choose
                                Avatar</label>
                            <div
                                style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                                <button class="emoji-btn" onclick="selectEmoji('üöå')">üöå</button>
                                <button class="emoji-btn" onclick="selectEmoji('üöá')">üöá</button>
                                <button class="emoji-btn" onclick="selectEmoji('üöä')">üöä</button>
                                <button class="emoji-btn" onclick="selectEmoji('üöã')">üöã</button>
                                <button class="emoji-btn" onclick="selectEmoji('üöû')">üöû</button>
                                <button class="emoji-btn" onclick="selectEmoji('üöù')">üöù</button>
                                <button class="emoji-btn" onclick="selectEmoji('üöÑ')">üöÑ</button>
                                <button class="emoji-btn" onclick="selectEmoji('‚úàÔ∏è')">‚úàÔ∏è</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" id="nameInput" placeholder="Your name (e.g., Ryan)">
                    </div>

                    <div class="form-group">
                        <label>Default Agency</label>
                        <select id="defaultAgencySelect"
                            style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); font-size: 1em;">
                            <option value="TTC">TTC (Toronto)</option>
                            <option value="OC Transpo">OC Transpo (Ottawa)</option>
                            <option value="GO Transit">GO Transit</option>
                            <option value="MiWay">MiWay (Mississauga)</option>
                            <option value="YRT">YRT (York Region)</option>
                            <option value="Brampton Transit">Brampton Transit</option>
                            <option value="Durham Transit">Durham Transit</option>
                            <option value="HSR">HSR (Hamilton)</option>
                            <option value="GRT">GRT (Waterloo Region)</option>
                            <option value="STM">STM (Montreal)</option>
                            <option value="TransLink">TransLink (Vancouver)</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <hr style="border: none; border-top: 1px solid var(--border-light); margin: 25px 0;">

                    <h4
                        style="margin-bottom: 15px; color: var(--text-secondary); text-transform: uppercase; font-size: 0.85em; letter-spacing: 0.5px;">
                        Appearance</h4>

                    <div class="form-group">
                        <label>Theme</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button id="themeLightBtn" class="btn btn-outline" onclick="setTheme('light')"
                                style="margin: 0; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                ‚òÄÔ∏è Light
                            </button>
                            <button id="themeDarkBtn" class="btn btn-outline" onclick="setTheme('dark')"
                                style="margin: 0; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                üåô Dark
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="saveSettings()" style="flex: 1;">Save Changes</button>
                        <button class="btn" onclick="closeSettings()"
                            style="flex: 1; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color);">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Status Footer -->
            <div class="status-footer">
                <div id="locationStatus" class="status-indicator loading">
                    üìç Getting location...
                </div>
                <div id="connectionStatus" class="status-indicator" onclick="toggleLogout()">
                    Checking...
                </div>
            </div>

            <script src="visuals.js"></script>
            <script src="app.js"></script>
</body>

</html>