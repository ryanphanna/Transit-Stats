<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransitStats</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; line-height: 1.4; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 1.3em; font-weight: 600; cursor: pointer; }
        .user-info { display: flex; gap: 10px; }
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
            min-width: 70px;
        }
        .header-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        .container { max-width: 100%; padding: 15px; }
        .section { background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .auth-section { text-align: center; padding: 40px 20px; }
        .auth-section h2 { margin-bottom: 20px; color: #333; }
        .auth-section p { margin-bottom: 20px; color: #666; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 1em; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .location-box { background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin-bottom: 15px; font-size: 0.9em; text-align: center; transition: all 0.3s ease; }
        .location-box.excellent { background: #d4edda; border-color: #2ed573; color: #155724; }
        .location-box.good { background: #fff3cd; border-color: #ffc107; color: #856404; }
        .location-box.poor { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .location-box.loading { background: #e3f2fd; border-color: #2196f3; color: #1976d2; }
        .preview-box { margin-top: 8px; padding: 10px; border-radius: 6px; font-size: 0.9em; border: 1px solid transparent; }
        .preview-box.new { background: #e8f5e8; border-color: #2ed573; color: #2d7738; }
        .preview-box.existing { background: #fff3cd; border-color: #ffc107; color: #856404; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 6px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.2s ease; margin: 10px 0; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-danger { background: #ff4757; color: white; }
        .btn-outline { background: transparent; color: #666; border: 2px solid #ddd; }
        .button-group { display: flex; gap: 10px; flex-direction: column; }
        .trip-status { background: #e8f5e8; border: 2px solid #2ed573; border-radius: 8px; padding: 20px; margin-bottom: 15px; text-align: center; }
        .trip-item { background: #f9f9f9; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #667eea; }
        .empty-state { text-align: center; color: #999; padding: 20px; font-style: italic; }
        .auth-status { background: #e3f2fd; border: 1px solid #2196f3; border-radius: 6px; padding: 10px; margin-bottom: 15px; font-size: 0.9em; color: #1976d2; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .emoji-btn { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 12px; font-size: 1.5em; cursor: pointer; transition: all 0.2s ease; }
        .emoji-btn:hover { background: #e9ecef; transform: scale(1.1); }
        .emoji-btn.selected { background: #667eea; border-color: #667eea; transform: scale(1.1); }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; border-radius: 8px; padding: 20px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; color: #667eea; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; color: #666; font-weight: 500; }
        .streak-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
            text-align: center;
            display: none;
        }
        .streak-status.hot-streak {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e6b 100%);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-row">
            <h1 class="header-title" onclick="goHome()">TransitStats</h1>
            <div id="userInfo" class="user-info" style="display: none;">
                <button id="profileBtn" class="header-btn">üë§ Profile</button>
                <button id="statsBtn" class="header-btn">üìä Stats</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="authSection" class="section auth-section">
            <h2>Welcome to TransitStats</h2>
            <p>Sign in to sync your trips across all devices</p>
            <div class="form-group">
                <input type="email" id="emailInput" placeholder="Enter your email address">
            </div>
            <div class="form-group">
                <input type="password" id="passwordInput" placeholder="Password (leave blank for magic link)">
            </div>
            <button id="signInBtn" class="btn btn-primary">Sign In</button>
            <div id="authStatus" class="auth-status" style="display: none;"></div>
        </div>

        <div id="appContent" style="display: none;">
            <div id="streakStatus" class="streak-status"></div>
            
            <div id="profileSection" class="section" style="display: none;">
                <h2>üë§ Profile</h2>
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3em; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span id="profileAvatar">üöå</span>
                        <button id="shuffleEmojiBtn" style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 50%; padding: 8px; font-size: 0.5em; cursor: pointer; width: 30px; height: 30px; display: none;">üé≤</button>
                    </div>
                    <input type="text" id="nameInput" placeholder="Your name (e.g., Ryan)" style="text-align: center; font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">
                </div>
                <div id="emojiSelector" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 500;">Choose your transit emoji:</label>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                        <button class="emoji-btn" onclick="selectEmoji('üöå')">üöå</button>
                        <button class="emoji-btn" onclick="selectEmoji('üöá')">üöá</button>
                        <button class="emoji-btn" onclick="selectEmoji('üöä')">üöä</button>
                        <button class="emoji-btn" onclick="selectEmoji('üöã')">üöã</button>
                        <button class="emoji-btn" onclick="selectEmoji('üöû')">üöû</button>
                        <button class="emoji-btn" onclick="selectEmoji('üöù')">üöù</button>
                        <button class="emoji-btn" onclick="selectEmoji('üöÑ')">üöÑ</button>
                        <button class="emoji-btn" onclick="selectEmoji('‚úàÔ∏è')">‚úàÔ∏è</button>
                    </div>
                </div>
                
                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
                    <button class="btn btn-outline" onclick="hideProfile()">Back</button>
                    <button class="btn" style="background: #ff4757; color: white;" onclick="signOut()">Sign Out</button>
                </div>
            </div>

            <div id="statsSection" class="section" style="display: none;">
                <h2>üìä Your Stats</h2>
                
                <!-- Streak Stats Section -->
                <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e6b 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; color: white; text-align: center;">
                    <h3 style="margin-bottom: 15px; font-size: 1.2em;">üî• Streak Stats</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;" id="statsCurrentStreak">0</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Current Streak</div>
                        </div>
                        <div>
                            <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;" id="statsBestStreak">0</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">üèÜ Best Streak</div>
                        </div>
                    </div>
                </div>
                
                <!-- General Stats Section -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="statsTotalTrips">0</div>
                        <div class="stat-label">Total Trips</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statsUniqueRoutes">0</div>
                        <div class="stat-label">Routes Used</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statsTotalTime">0</div>
                        <div class="stat-label">Hours Traveled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statsUniqueStops">0</div>
                        <div class="stat-label">Stops Visited</div>
                    </div>
                </div>

                <!-- Community Comparison -->
                <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: #333;">üåç Community Comparison</h3>
                    <div id="communityStats">
                        <div class="loading">Loading community data...</div>
                    </div>
                </div>

                <!-- Top Routes & Stops -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                    <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">üöå Top Routes</h4>
                        <div id="topRoutes">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">üöè Top Stops</h4>
                        <div id="topStops">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                </div>

                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn btn-outline" onclick="hideStats()">Back</button>
                </div>
            </div>

            <div id="startSection" class="section">
                <h2>Start New Trip</h2>
                <div id="locationBox" class="location-box" style="display: none;">
                    <span id="locationText">Getting location...</span>
                </div>
                <div class="form-group">
                    <label>Boarding Stop</label>
                    <input type="text" id="stopInput" placeholder="e.g., 6638 or Union Station">
                    <div id="stopPreview" class="preview-box" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <label>Route/Line</label>
                    <input type="text" id="routeInput" placeholder="e.g., 65, Line 1, 504 King">
                    <div id="routePreview" class="preview-box" style="display: none;"></div>
                </div>
                <button id="startBtn" class="btn btn-primary" disabled>üöå Board Vehicle</button>
            </div>

            <div id="activeSection" class="section" style="display: none;">
                <div class="trip-status">
                    <h2>üöå Currently Riding</h2>
                    <div id="currentTrip"></div>
                </div>
                
                <!-- Progressive Questions -->
                <div id="progressiveQuestion" class="section" style="display: none; background: #f8f9fa; border: 2px solid #667eea;">
                    <div id="questionText" style="font-weight: 500; margin-bottom: 15px; color: #333;"></div>
                    <div class="form-group">
                        <input type="text" id="questionInput" placeholder="" style="margin-bottom: 10px;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button id="answerBtn" class="btn" style="background: #667eea; color: white; flex: 1;">Answer</button>
                        <button id="skipBtn" class="btn btn-outline" style="flex: 1;">Skip</button>
                    </div>
                </div>

                <button id="endBtn" class="btn btn-danger">üõë End Trip</button>
                <button id="abandonBtn" class="btn btn-outline" style="background: #ffc107; color: #856404; border-color: #ffc107;">‚ö†Ô∏è Cancel/Abandon Trip</button>
            </div>

            <div id="recentTripsSection" class="section">
                <h2>Recent Trips (<span id="tripCount">0</span>)</h2>
                <div id="tripsList">
                    <div class="loading">Loading trips...</div>
                </div>
            </div>
        </div>

        <div id="endModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px;">
                <h3>End Trip</h3>
                <div class="form-group">
                    <label>Exit Stop</label>
                    <input type="text" id="exitInput" placeholder="e.g., 1234 or King Station">
                </div>
                <button id="saveBtn" class="btn btn-primary">Save Trip</button>
                <button id="cancelBtn" class="btn" style="background: #ddd;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ TransitStats Loading...');
        
        const firebaseConfig = {
            apiKey: "AIzaSyBgY37b_aUorxdEW6DnocFoo8ekbTTFpao",
            authDomain: "transitstats-21ba4.firebaseapp.com",
            projectId: "transitstats-21ba4",
            storageBucket: "transitstats-21ba4.firebasestorage.app",
            messagingSenderId: "756203797723",
            appId: "1:756203797723:web:2e5aab94a6de20cf06a0fe"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        console.log('‚úÖ Firebase initialized successfully!');

        let currentUser = null;
        let activeTrip = null;

        const authSection = document.getElementById('authSection');
        const appContent = document.getElementById('appContent');
        const profileSection = document.getElementById('profileSection');
        const statsSection = document.getElementById('statsSection');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const signInBtn = document.getElementById('signInBtn');
        const authStatus = document.getElementById('authStatus');
        const userInfo = document.getElementById('userInfo');
        const profileBtn = document.getElementById('profileBtn');
        const statsBtn = document.getElementById('statsBtn');
        const stopInput = document.getElementById('stopInput');
        const routeInput = document.getElementById('routeInput');
        const startBtn = document.getElementById('startBtn');
        const startSection = document.getElementById('startSection');
        const activeSection = document.getElementById('activeSection');
        const currentTripDiv = document.getElementById('currentTrip');
        const endBtn = document.getElementById('endBtn');
        const endModal = document.getElementById('endModal');
        const exitInput = document.getElementById('exitInput');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const tripsList = document.getElementById('tripsList');
        const tripCount = document.getElementById('tripCount');
        const locationBox = document.getElementById('locationBox');
        const locationText = document.getElementById('locationText');
        const progressiveQuestion = document.getElementById('progressiveQuestion');
        const questionText = document.getElementById('questionText');
        const questionInput = document.getElementById('questionInput');
        const answerBtn = document.getElementById('answerBtn');
        const skipBtn = document.getElementById('skipBtn');
        const streakStatus = document.getElementById('streakStatus');

        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                console.log('‚úÖ User authenticated:', user.email);
                showApp();
            } else {
                console.log('‚ùå No user authenticated');
                showAuth();
            }
        });

        function showAuth() {
            authSection.style.display = 'block';
            appContent.style.display = 'none';
            userInfo.style.display = 'none';
        }

        function showApp() {
            authSection.style.display = 'none';
            appContent.style.display = 'block';
            userInfo.style.display = 'block';
            loadUserProfile();
            initializeApp();
        }

        function loadUserProfile() {
            db.collection('profiles').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const profile = doc.data();
                        const emoji = profile.emoji || 'üöå';
                        document.getElementById('profileAvatar').textContent = emoji;
                        document.getElementById('nameInput').value = profile.name || '';
                        
                        // Hide emoji selector and show shuffle button if user has chosen an emoji
                        if (profile.emoji) {
                            document.getElementById('emojiSelector').style.display = 'none';
                            document.getElementById('shuffleEmojiBtn').style.display = 'block';
                        }
                    }
                })
                .catch((error) => {
                    console.log('Profile load error (using defaults):', error.message);
                });
        }

        function showProfile() {
            hideAllSections();
            profileSection.style.display = 'block';
        }

        function hideProfile() {
            profileSection.style.display = 'none';
            goHome();
        }

        function showStats() {
            hideAllSections();
            statsSection.style.display = 'block';
            updateStatsSection();
            loadCommunityData();
        }

        function hideStats() {
            statsSection.style.display = 'none';
            goHome();
        }

        function hideAllSections() {
            profileSection.style.display = 'none';
            statsSection.style.display = 'none';
        }

        function selectEmoji(emoji) {
            document.querySelectorAll('.emoji-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('profileAvatar').textContent = emoji;
        }

        function saveProfile() {
            const name = document.getElementById('nameInput').value.trim();
            const emoji = document.getElementById('profileAvatar').textContent;
            
            if (!name) {
                alert('Please enter your name');
                return;
            }

            const profileData = {
                name: name,
                emoji: emoji,
                userId: currentUser.uid,
                updatedAt: firebase.firestore.Timestamp.now()
            };

            db.collection('profiles').doc(currentUser.uid).set(profileData)
                .then(() => {
                    alert('Profile saved!');
                    hideProfile();
                })
                .catch((error) => {
                    console.error('Error saving profile:', error);
                    alert('Error saving profile. Please try again.');
                });
        }

        function updateStatsSection() {
            if (!currentUser) return;

            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((snapshot) => {
                    const trips = [];
                    snapshot.forEach((doc) => {
                        trips.push(doc.data());
                    });

                    const totalTrips = trips.length;
                    const uniqueRoutes = new Set(trips.map(t => t.route)).size;
                    const totalMinutes = trips.reduce((sum, t) => sum + (t.duration || 0), 0);
                    const totalHours = Math.round(totalMinutes / 60 * 10) / 10;
                    
                    const stops = new Set();
                    trips.forEach(t => {
                        stops.add(t.startStop);
                        stops.add(t.endStop);
                    });
                    const uniqueStops = stops.size;

                    const streakData = calculateStreaks(trips);

                    document.getElementById('statsTotalTrips').textContent = totalTrips;
                    document.getElementById('statsUniqueRoutes').textContent = uniqueRoutes;
                    document.getElementById('statsTotalTime').textContent = totalHours;
                    document.getElementById('statsUniqueStops').textContent = uniqueStops;
                    document.getElementById('statsCurrentStreak').textContent = streakData.current;
                    document.getElementById('statsBestStreak').textContent = streakData.best;

                    // Generate top routes and stops
                    generateTopRoutes(trips);
                    generateTopStops(trips);
                });
        }

        function generateTopRoutes(trips) {
            const routeCounts = {};
            trips.forEach(trip => {
                const route = trip.route || 'Unknown';
                routeCounts[route] = (routeCounts[route] || 0) + 1;
            });

            const sortedRoutes = Object.entries(routeCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const topRoutesHtml = sortedRoutes.length > 0 ? 
                sortedRoutes.map(([route, count], index) => 
                    `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                        <span>${index + 1}. ${route}</span>
                        <span style="color: #667eea; font-weight: 600;">${count} trips</span>
                    </div>`
                ).join('') : 
                '<div style="color: #999; font-style: italic;">No trips yet</div>';

            document.getElementById('topRoutes').innerHTML = topRoutesHtml;
        }

        function generateTopStops(trips) {
            const stopCounts = {};
            trips.forEach(trip => {
                const startStop = trip.startStop || 'Unknown';
                const endStop = trip.endStop || 'Unknown';
                stopCounts[startStop] = (stopCounts[startStop] || 0) + 1;
                stopCounts[endStop] = (stopCounts[endStop] || 0) + 1;
            });

            const sortedStops = Object.entries(stopCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const topStopsHtml = sortedStops.length > 0 ? 
                sortedStops.map(([stop, count], index) => 
                    `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                        <span>${index + 1}. ${stop}</span>
                        <span style="color: #667eea; font-weight: 600;">${count} uses</span>
                    </div>`
                ).join('') : 
                '<div style="color: #999; font-style: italic;">No trips yet</div>';

            document.getElementById('topStops').innerHTML = topStopsHtml;
        }

        function loadCommunityData() {
            // Get aggregated community stats for last 30 days
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            db.collection('trips')
                .where('startTime', '>=', firebase.firestore.Timestamp.fromDate(thirtyDaysAgo))
                .get()
                .then((snapshot) => {
                    const allTrips = [];
                    const userTrips = [];
                    
                    snapshot.forEach((doc) => {
                        const trip = doc.data();
                        allTrips.push(trip);
                        if (trip.userId === currentUser.uid) {
                            userTrips.push(trip);
                        }
                    });

                    const totalUsers = new Set(allTrips.map(t => t.userId)).size;
                    const userRank = calculateUserRank(userTrips.length, allTrips);
                    const avgTripsPerUser = totalUsers > 0 ? Math.round(allTrips.length / totalUsers * 10) / 10 : 0;

                    const communityHtml = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #667eea;">${userTrips.length}</div>
                                <div style="font-size: 0.9em; color: #666;">Your trips (30 days)</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #667eea;">#${userRank}</div>
                                <div style="font-size: 0.9em; color: #666;">Your rank</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #667eea;">${totalUsers}</div>
                                <div style="font-size: 0.9em; color: #666;">Active riders</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #667eea;">${avgTripsPerUser}</div>
                                <div style="font-size: 0.9em; color: #666;">Avg trips/rider</div>
                            </div>
                        </div>
                    `;

                    document.getElementById('communityStats').innerHTML = communityHtml;
                })
                .catch((error) => {
                    console.error('Error loading community data:', error);
                    document.getElementById('communityStats').innerHTML = '<div style="color: #999; font-style: italic;">Unable to load community data</div>';
                });
        }

        function calculateUserRank(userTripCount, allTrips) {
            const userCounts = {};
            allTrips.forEach(trip => {
                userCounts[trip.userId] = (userCounts[trip.userId] || 0) + 1;
            });

            const sortedCounts = Object.values(userCounts).sort((a, b) => b - a);
            const rank = sortedCounts.findIndex(count => count <= userTripCount) + 1;
            return rank || sortedCounts.length + 1;
        }

        function calculateStreaks(trips) {
            if (trips.length === 0) return { current: 0, best: 0 };

            const sortedTrips = trips.sort((a, b) => {
                const dateA = a.startTime?.toDate ? a.startTime.toDate() : new Date(a.startTime);
                const dateB = b.startTime?.toDate ? b.startTime.toDate() : new Date(b.startTime);
                return dateB - dateA;
            });

            const tripDays = new Set();
            sortedTrips.forEach(trip => {
                const date = trip.startTime?.toDate ? trip.startTime.toDate() : new Date(trip.startTime);
                const dayString = date.toDateString();
                tripDays.add(dayString);
            });

            const uniqueDays = Array.from(tripDays).sort((a, b) => new Date(b) - new Date(a));

            let currentStreak = 0;
            let bestStreak = 0;
            let tempStreak = 0;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < uniqueDays.length; i++) {
                const currentDay = new Date(uniqueDays[i]);
                currentDay.setHours(0, 0, 0, 0);

                if (i === 0) {
                    const diffDays = Math.floor((today - currentDay) / (1000 * 60 * 60 * 24));
                    if (diffDays <= 1) {
                        currentStreak = 1;
                        tempStreak = 1;
                    }
                } else {
                    const prevDay = new Date(uniqueDays[i - 1]);
                    prevDay.setHours(0, 0, 0, 0);
                    const diffDays = Math.floor((prevDay - currentDay) / (1000 * 60 * 60 * 24));

                    if (diffDays === 1) {
                        tempStreak++;
                        if (i < currentStreak || currentStreak === 0) {
                            currentStreak = tempStreak;
                        }
                    } else {
                        bestStreak = Math.max(bestStreak, tempStreak);
                        tempStreak = 1;
                        if (currentStreak === tempStreak - 1) {
                            currentStreak = 0;
                        }
                    }
                }
            }

            bestStreak = Math.max(bestStreak, tempStreak, currentStreak);
            return { current: currentStreak, best: bestStreak };
        }

        function signOut() {
            auth.signOut();
        }

        signInBtn.addEventListener('click', () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!email) {
                alert('Please enter your email');
                return;
            }

            if (password) {
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        showAuthStatus('Signed in successfully!', 'success');
                    })
                    .catch((error) => {
                        if (error.code === 'auth/user-not-found') {
                            auth.createUserWithEmailAndPassword(email, password)
                                .then(() => {
                                    showAuthStatus('Account created and signed in!', 'success');
                                })
                                .catch((error) => {
                                    console.error('Error creating account:', error);
                                    showAuthStatus('Error creating account. Please try again.', 'error');
                                });
                        } else {
                            console.error('Error signing in:', error);
                            showAuthStatus('Invalid email or password.', 'error');
                        }
                    });
            } else {
                const actionCodeSettings = {
                    url: window.location.href,
                    handleCodeInApp: true,
                };

                auth.sendSignInLinkToEmail(email, actionCodeSettings)
                    .then(() => {
                        localStorage.setItem('emailForSignIn', email);
                        showAuthStatus('Check your email for a magic link!', 'success');
                    })
                    .catch((error) => {
                        console.error('Error sending email:', error);
                        showAuthStatus('Magic link failed. Try with a password instead.', 'error');
                    });
            }
        });

        if (auth.isSignInWithEmailLink(window.location.href)) {
            let email = localStorage.getItem('emailForSignIn');
            if (!email) {
                email = window.prompt('Please provide your email for confirmation');
            }

            auth.signInWithEmailLink(email, window.location.href)
                .then(() => {
                    localStorage.removeItem('emailForSignIn');
                })
                .catch((error) => {
                    console.error('Error signing in:', error);
                });
        }

        function showAuthStatus(message, type) {
            authStatus.textContent = message;
            authStatus.className = type === 'success' ? 'auth-status' : 'auth-status error';
            authStatus.style.display = 'block';
        }

        function initializeApp() {
            stopInput.addEventListener('input', updateStartButton);
            routeInput.addEventListener('input', updateStartButton);
            startBtn.addEventListener('click', startTrip);
            endBtn.addEventListener('click', showEndModal);
            document.getElementById('abandonBtn').addEventListener('click', abandonTrip);
            saveBtn.addEventListener('click', saveTrip);
            cancelBtn.addEventListener('click', hideEndModal);
            profileBtn.addEventListener('click', showProfile);
            statsBtn.addEventListener('click', showStats);
            document.getElementById('shuffleEmojiBtn').addEventListener('click', shuffleEmoji);
            answerBtn.addEventListener('click', submitAnswer);
            skipBtn.addEventListener('click', skipQuestion);
            loadTrips();
            getCurrentLocation(() => {});
        }

        function abandonTrip() {
            if (confirm('Are you sure you want to abandon this trip? This cannot be undone.')) {
                db.collection('activeTrips').doc(currentUser.uid).delete()
                    .then(() => {
                        activeTrip = null;
                        progressiveQuestion.style.display = 'none';
                        showStartSection();
                        alert('Trip abandoned');
                    })
                    .catch((error) => {
                        console.error('Error abandoning trip:', error);
                        alert('Error abandoning trip. Please try again.');
                    });
            }
        }

        function updateStartButton() {
            const hasStop = stopInput.value.trim().length > 0;
            const hasRoute = routeInput.value.trim().length > 0;
            startBtn.disabled = !(hasStop && hasRoute);
            updateStopPreview();
            updateRoutePreview();
        }

        function updateStopPreview() {
            const stopValue = stopInput.value.trim();
            const preview = document.getElementById('stopPreview');
            
            if (!stopValue) {
                preview.style.display = 'none';
                return;
            }

            const isNumber = /^\d+$/.test(stopValue);
            const stopName = isNumber ? `Stop #${stopValue}` : stopValue;
            
            preview.innerHTML = `üéâ You're the first person to board at ${stopName}! (with GPS)`;
            preview.className = 'preview-box new';
            preview.style.display = 'block';
        }

        function updateRoutePreview() {
            const routeValue = routeInput.value.trim();
            const preview = document.getElementById('routePreview');
            
            if (!routeValue) {
                preview.style.display = 'none';
                return;
            }

            preview.innerHTML = `‚úÖ Found existing route: ${routeValue}`;
            preview.className = 'preview-box existing';
            preview.style.display = 'block';
        }

        function startTrip() {
            const stop = stopInput.value.trim();
            const route = routeInput.value.trim();
            
            if (!stop || !route) {
                alert('Please enter both stop and route');
                return;
            }

            getCurrentLocation((boardingLocation) => {
                const tripData = {
                    startStop: stop,
                    route: route,
                    startTime: firebase.firestore.Timestamp.now(),
                    boardingLocation: boardingLocation,
                    userId: currentUser.uid
                };

                db.collection('activeTrips').doc(currentUser.uid).set(tripData)
                    .then(() => {
                        activeTrip = { id: currentUser.uid, ...tripData };
                        
                        const locationText = boardingLocation ? 
                            `üìç GPS: ${boardingLocation.lat.toFixed(4)}, ${boardingLocation.lon.toFixed(4)}` : 
                            'üìç No GPS data';
                        
                        currentTripDiv.innerHTML = `
                            <div><strong>${route}</strong></div>
                            <div>From: ${stop}</div>
                            <div>Started: ${new Date().toLocaleTimeString()}</div>
                            <div style="font-size: 0.8em; color: #666;">${locationText}</div>
                        `;
                        
                        showActiveSection();
                        
                        stopInput.value = '';
                        routeInput.value = '';
                        document.getElementById('stopPreview').style.display = 'none';
                        document.getElementById('routePreview').style.display = 'none';
                        updateStartButton();
                        
                        startProgressiveQuestions();
                    })
                    .catch((error) => {
                        console.error('Error starting trip:', error);
                        alert('Error starting trip. Please try again.');
                    });
            });
        }

        function showEndModal() {
            endModal.style.display = 'block';
        }

        function hideEndModal() {
            endModal.style.display = 'none';
            exitInput.value = '';
        }

        function saveTrip() {
            const exitStop = exitInput.value.trim();
            
            if (!exitStop) {
                alert('Please enter exit stop');
                return;
            }

            if (!activeTrip) {
                alert('No active trip');
                return;
            }

            getCurrentLocation((exitLocation) => {
                const completedTrip = {
                    startStop: activeTrip.startStop,
                    endStop: exitStop,
                    route: activeTrip.route,
                    startTime: activeTrip.startTime,
                    endTime: firebase.firestore.Timestamp.now(),
                    boardingLocation: activeTrip.boardingLocation,
                    exitLocation: exitLocation,
                    userId: currentUser.uid
                };

                const startMs = activeTrip.startTime.toDate().getTime();
                const endMs = completedTrip.endTime.toDate().getTime();
                completedTrip.duration = Math.round((endMs - startMs) / 1000 / 60);

                db.collection('trips').add(completedTrip)
                    .then(() => {
                        return db.collection('activeTrips').doc(currentUser.uid).delete();
                    })
                    .then(() => {
                        activeTrip = null;
                        progressiveQuestion.style.display = 'none';
                        hideEndModal();
                        showStartSection();
                        loadTrips();
                        const locationMsg = exitLocation ? 'üìç GPS captured' : 'üìç No GPS';
                        alert(`Trip saved! ${locationMsg}`);
                    })
                    .catch((error) => {
                        console.error('Error saving trip:', error);
                        alert('Error saving trip. Please try again.');
                    });
            });
        }

        function loadTrips() {
            if (!currentUser) {
                console.log('No user logged in');
                return;
            }

            console.log('Loading trips for user:', currentUser.uid);

            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .limit(50)
                .get()
                .then((snapshot) => {
                    console.log('‚úÖ Trips loaded:', snapshot.size);
                    
                    const trips = [];
                    snapshot.forEach((doc) => {
                        trips.push({ id: doc.id, ...doc.data() });
                    });
                    
                    trips.sort((a, b) => {
                        const timeA = a.startTime?.toDate ? a.startTime.toDate() : new Date(a.startTime);
                        const timeB = b.startTime?.toDate ? b.startTime.toDate() : new Date(b.startTime);
                        return timeB - timeA;
                    });
                    
                    displayTrips(trips);
                })
                .catch((error) => {
                    console.error('Error loading trips:', error);
                    tripsList.innerHTML = '<div class="empty-state">Error loading trips. Please try again.</div>';
                });

            db.collection('activeTrips').doc(currentUser.uid)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        activeTrip = { id: doc.id, ...doc.data() };
                        showActiveTrip();
                    } else {
                        activeTrip = null;
                        showStartSection();
                    }
                });
        }

        function showActiveTrip() {
            if (!activeTrip) return;

            const startTime = activeTrip.startTime.toDate();
            const locationText = activeTrip.boardingLocation ? 
                `üìç GPS: ${activeTrip.boardingLocation.lat.toFixed(4)}, ${activeTrip.boardingLocation.lon.toFixed(4)}` : 
                'üìç No GPS data';
            
            currentTripDiv.innerHTML = `
                <div><strong>${activeTrip.route}</strong></div>
                <div>From: ${activeTrip.startStop}</div>
                <div>Started: ${startTime.toLocaleTimeString()}</div>
                <div style="font-size: 0.8em; color: #666;">${locationText}</div>
            `;
            
            showActiveSection();
        }

        function showStartSection() {
            startSection.style.display = 'block';
            activeSection.style.display = 'none';
            document.getElementById('recentTripsSection').style.display = 'block';
        }

        function showActiveSection() {
            startSection.style.display = 'none';
            activeSection.style.display = 'block';
            document.getElementById('recentTripsSection').style.display = 'none';
        }

        function goHome() {
            hideAllSections();
            if (activeTrip) {
                showActiveSection();
            } else {
                showStartSection();
            }
        }

        function shuffleEmoji() {
            const emojis = ['üöå', 'üöá', 'üöä', 'üöã', 'üöû', 'üöù', 'üöÑ', '‚úàÔ∏è'];
            const currentEmoji = document.getElementById('profileAvatar').textContent;
            let newEmoji;
            do {
                newEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            } while (newEmoji === currentEmoji);
            
            document.getElementById('profileAvatar').textContent = newEmoji;
        }

        function displayTrips(trips) {
            tripCount.textContent = trips.length;
            
            if (trips.length > 0) {
                const streakData = calculateStreaks(trips);
                updateStreakStatus(streakData);
            }
            
            if (trips.length === 0) {
                tripsList.innerHTML = '<div class="empty-state">No trips yet. Start your first trip above!</div>';
                return;
            }

            tripsList.innerHTML = trips.slice(0, 20).map(trip => {
                let startTime;
                if (trip.startTime?.toDate) {
                    startTime = trip.startTime.toDate();
                } else if (trip.startTime) {
                    startTime = new Date(trip.startTime);
                } else {
                    startTime = new Date();
                }
                
                return `
                    <div class="trip-item">
                        <div><strong>${trip.route || 'Unknown Route'}</strong></div>
                        <div>${trip.startStop || 'Unknown'} ‚Üí ${trip.endStop || 'Unknown'}</div>
                        <div>${trip.duration || 0} min ‚Ä¢ ${startTime.toLocaleDateString()}</div>
                    </div>
                `;
            }).join('');
        }

        function updateStreakStatus(streakData) {
            if (streakData.current === 0) {
                streakStatus.style.display = 'none';
                return;
            }

            streakStatus.style.display = 'block';
            
            if (streakData.current >= 7) {
                streakStatus.innerHTML = `üî• AMAZING! ${streakData.current} day streak! You're a transit champion!`;
                streakStatus.className = 'streak-status hot-streak';
            } else if (streakData.current >= 3) {
                streakStatus.innerHTML = `üî• Hot streak! ${streakData.current} days in a row!`;
                streakStatus.className = 'streak-status hot-streak';
            } else {
                streakStatus.innerHTML = `‚ö° ${streakData.current} day streak! Keep it going!`;
                streakStatus.className = 'streak-status';
            }
        }

        function getCurrentLocation(callback) {
            if (!navigator.geolocation) {
                updateLocationBox('üìç Location not supported', 'poor');
                callback(null);
                return;
            }

            updateLocationBox('üìç Getting location...', 'loading');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const accuracy = Math.round(position.coords.accuracy);
                    let className, useLocation = false;
                    
                    if (accuracy <= 10) {
                        className = 'excellent';
                        useLocation = true;
                    } else if (accuracy <= 20) {
                        className = 'good';
                        useLocation = true;
                    } else {
                        className = 'poor';
                        useLocation = false;
                    }
                    
                    const statusMessage = useLocation ? 
                        `üìç Location ready (¬±${accuracy}m)` : 
                        `üìç Location too inaccurate (¬±${accuracy}m) - not saving GPS`;
                    
                    updateLocationBox(statusMessage, className);
                    
                    if (useLocation) {
                        const location = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString()
                        };
                        console.log(`GPS logged: ¬±${accuracy}m accuracy`);
                        callback(location);
                    } else {
                        console.log(`GPS too inaccurate (¬±${accuracy}m), not logging location`);
                        callback(null);
                    }
                },
                (error) => {
                    console.log('Location error:', error);
                    updateLocationBox('üìç Location unavailable', 'poor');
                    callback(null);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 60000
                }
            );
        }

        function updateLocationBox(message, type) {
            locationText.textContent = message;
            locationBox.className = `location-box ${type}`;
            locationBox.style.display = 'block';
        }

        // Progressive question system
        let currentQuestionIndex = 0;
        let tripEnrichmentData = {};
        
        const questions = [
            {
                text: "üì± See the vehicle number?",
                placeholder: "e.g., 8234, 1156",
                field: "vehicleNumber"
            },
            {
                text: "üß≠ Which direction is this vehicle headed?",
                placeholder: "e.g., Northbound, Downtown, Union Station",
                field: "direction"
            },
            {
                text: "üë• How crowded is it right now?",
                placeholder: "e.g., Empty, Half full, Packed",
                field: "crowdLevel"
            }
        ];

        function startProgressiveQuestions() {
            currentQuestionIndex = 0;
            tripEnrichmentData = {};
            
            setTimeout(() => {
                showNextQuestion();
            }, 10000);
        }

        function showNextQuestion() {
            if (currentQuestionIndex >= questions.length || !activeTrip) {
                progressiveQuestion.style.display = 'none';
                return;
            }

            const question = questions[currentQuestionIndex];
            questionText.textContent = question.text;
            questionInput.placeholder = question.placeholder;
            questionInput.value = '';
            progressiveQuestion.style.display = 'block';
            
            questionInput.focus();
        }

        function submitAnswer() {
            const answer = questionInput.value.trim();
            if (answer) {
                const question = questions[currentQuestionIndex];
                tripEnrichmentData[question.field] = answer;
                
                if (activeTrip) {
                    const updateData = {};
                    updateData[question.field] = answer;
                    
                    db.collection('activeTrips').doc(currentUser.uid).update(updateData)
                        .then(() => {
                            console.log(`Saved ${question.field}: ${answer}`);
                        })
                        .catch((error) => {
                            console.error('Error updating trip:', error);
                        });
                }
            }
            
            progressiveQuestion.style.display = 'none';
            currentQuestionIndex++;
            
            setTimeout(() => {
                showNextQuestion();
            }, 30000);
        }

        function skipQuestion() {
            progressiveQuestion.style.display = 'none';
            currentQuestionIndex++;
            
            setTimeout(() => {
                showNextQuestion();
            }, 30000);
        }

        console.log('üéâ TransitStats fully loaded and ready!');
    </script>
</body>
</html>
