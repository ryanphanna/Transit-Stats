<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transit Stats</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.4;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .sign-out-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .container {
            max-width: 100%;
            padding: 15px;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .auth-section {
            text-align: center;
            padding: 40px 20px;
        }

        .auth-section h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .auth-section p {
            margin-bottom: 20px;
            color: #666;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .preview-box {
            margin-top: 8px;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            border: 1px solid transparent;
        }

        .preview-box.new {
            background: #e8f5e8;
            border-color: #2ed573;
            color: #2d7738;
        }

        .preview-box.existing {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 10px 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .trip-status {
            background: #e8f5e8;
            border: 2px solid #2ed573;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
        }

        .trip-item {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .location-box {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9em;
            text-align: center;
            transition: all 0.3s ease;
        }

        .location-box.excellent {
            background: #d4edda;
            border-color: #2ed573;
            color: #155724;
        }

        .location-box.good {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .location-box.poor {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .location-box.loading {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1976d2;
        }

        .auth-status {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #1976d2;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-row">
            <h1>🚇 Transit Stats</h1>
            <div id="userInfo" class="user-info" style="display: none;">
                <span id="userEmail"></span>
                <button id="signOutBtn" class="sign-out-btn">Sign Out</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Authentication Section -->
        <div id="authSection" class="section auth-section">
            <h2>Welcome to Transit Stats</h2>
            <p>Sign in to sync your trips across all devices</p>
            
            <div class="form-group">
                <input type="email" id="emailInput" placeholder="Enter your email address">
            </div>
            
            <button id="signInBtn" class="btn btn-primary">Send Magic Link</button>
            
            <div id="authStatus" class="auth-status" style="display: none;"></div>
        </div>

        <!-- App Content (hidden until signed in) -->
        <div id="appContent" style="display: none;">
            <!-- Start Trip Section -->
            <div id="startSection" class="section">
                <h2>Start New Trip</h2>
                
                <div id="locationBox" class="location-box" style="display: none;">
                    <span id="locationText">Getting location...</span>
                </div>
                
                <div class="form-group">
                    <label>Boarding Stop</label>
                    <input type="text" id="stopInput" placeholder="e.g., 6638 or Union Station">
                    <div id="stopPreview" class="preview-box" style="display: none;"></div>
                </div>

                <div class="form-group">
                    <label>Route/Line</label>
                    <input type="text" id="routeInput" placeholder="e.g., 65, Line 1, 504 King">
                    <div id="routePreview" class="preview-box" style="display: none;"></div>
                </div>

                <button id="startBtn" class="btn btn-primary" disabled>🚌 Board Vehicle</button>
            </div>

            <!-- Active Trip Section -->
            <div id="activeSection" class="section" style="display: none;">
                <div class="trip-status">
                    <h2>🚌 Currently Riding</h2>
                    <div id="currentTrip"></div>
                </div>
                <button id="endBtn" class="btn btn-danger">🛑 End Trip</button>
            </div>

            <!-- Recent Trips -->
            <div class="section">
                <h2>Recent Trips (<span id="tripCount">0</span>)</h2>
                <div id="tripsList">
                    <div class="loading">Loading trips...</div>
                </div>
            </div>
        </div>

        <!-- End Trip Modal -->
        <div id="endModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px;">
                <h3>End Trip</h3>
                <div class="form-group">
                    <label>Exit Stop</label>
                    <input type="text" id="exitInput" placeholder="e.g., 1234 or King Station">
                </div>
                <button id="saveBtn" class="btn btn-primary">Save Trip</button>
                <button id="cancelBtn" class="btn" style="background: #ddd;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBgY37b_aUorxdEW6DnocFoo8ekbTTFpao",
            authDomain: "transitstats-21ba4.firebaseapp.com",
            projectId: "transitstats-21ba4",
            storageBucket: "transitstats-21ba4.firebasestorage.app",
            messagingSenderId: "756203797723",
            appId: "1:756203797723:web:2e5aab94a6de20cf06a0fe"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // App state
        let currentUser = null;
        let activeTrip = null;
        let currentLocation = null;

        // Elements
        const authSection = document.getElementById('authSection');
        const appContent = document.getElementById('appContent');
        const emailInput = document.getElementById('emailInput');
        const signInBtn = document.getElementById('signInBtn');
        const authStatus = document.getElementById('authStatus');
        const userInfo = document.getElementById('userInfo');
        const userEmail = document.getElementById('userEmail');
        const signOutBtn = document.getElementById('signOutBtn');
        const stopInput = document.getElementById('stopInput');
        const routeInput = document.getElementById('routeInput');
        const startBtn = document.getElementById('startBtn');
        const startSection = document.getElementById('startSection');
        const activeSection = document.getElementById('activeSection');
        const currentTripDiv = document.getElementById('currentTrip');
        const endBtn = document.getElementById('endBtn');
        const endModal = document.getElementById('endModal');
        const exitInput = document.getElementById('exitInput');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const tripsList = document.getElementById('tripsList');
        const tripCount = document.getElementById('tripCount');
        const locationBox = document.getElementById('locationBox');
        const locationText = document.getElementById('locationText');

        // Authentication
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                showApp();
            } else {
                showAuth();
            }
        });

        function showAuth() {
            authSection.style.display = 'block';
            appContent.style.display = 'none';
            userInfo.style.display = 'none';
        }

        function showApp() {
            authSection.style.display = 'none';
            appContent.style.display = 'block';
            userInfo.style.display = 'block';
            userEmail.textContent = currentUser.email;
            
            initializeApp();
        }

        // Sign in with email link
        signInBtn.addEventListener('click', () => {
            const email = emailInput.value.trim();
            if (!email) {
                alert('Please enter your email');
                return;
            }

            const actionCodeSettings = {
                url: window.location.href,
                handleCodeInApp: true,
            };

            auth.sendSignInLinkToEmail(email, actionCodeSettings)
                .then(() => {
                    localStorage.setItem('emailForSignIn', email);
                    showAuthStatus('Check your email for a magic link!', 'success');
                })
                .catch((error) => {
                    console.error('Error sending email:', error);
                    showAuthStatus('Error sending email. Please try again.', 'error');
                });
        });

        // Check if returning from email link
        if (auth.isSignInWithEmailLink(window.location.href)) {
            let email = localStorage.getItem('emailForSignIn');
            if (!email) {
                email = window.prompt('Please provide your email for confirmation');
            }

            auth.signInWithEmailLink(email, window.location.href)
                .then(() => {
                    localStorage.removeItem('emailForSignIn');
                })
                .catch((error) => {
                    console.error('Error signing in:', error);
                });
        }

        function showAuthStatus(message, type) {
            authStatus.textContent = message;
            authStatus.className = type === 'success' ? 'auth-status' : 'auth-status error';
            authStatus.style.display = 'block';
        }

        signOutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // App initialization
        function initializeApp() {
            // Event listeners
            stopInput.addEventListener('input', updateStartButton);
            routeInput.addEventListener('input', updateStartButton);
            startBtn.addEventListener('click', startTrip);
            endBtn.addEventListener('click', showEndModal);
            saveBtn.addEventListener('click', saveTrip);
            cancelBtn.addEventListener('click', hideEndModal);

            // Load data
            loadTrips();
            getCurrentLocation(() => {});
        }

        function updateStartButton() {
            const hasStop = stopInput.value.trim().length > 0;
            const hasRoute = routeInput.value.trim().length > 0;
            startBtn.disabled = !(hasStop && hasRoute);
            
            // Update previews
            updateStopPreview();
            updateRoutePreview();
        }

        function updateStopPreview() {
            const stopValue = stopInput.value.trim();
            const preview = document.getElementById('stopPreview');
            
            if (!stopValue) {
                preview.style.display = 'none';
                return;
            }

            const isNumber = /^\d+$/.test(stopValue);
            const stopName = isNumber ? `Stop #${stopValue}` : stopValue;
            
            preview.innerHTML = `🎉 You're the first person to board at ${stopName}! (with GPS)`;
            preview.className = 'preview-box new';
            preview.style.display = 'block';
        }

        function updateRoutePreview() {
            const routeValue = routeInput.value.trim();
            const preview = document.getElementById('routePreview');
            
            if (!routeValue) {
                preview.style.display = 'none';
                return;
            }

            preview.innerHTML = `✅ Found existing route: ${routeValue}`;
            preview.className = 'preview-box existing';
            preview.style.display = 'block';
        }

        function startTrip() {
            console.log('Starting trip...');
            
            const stop = stopInput.value.trim();
            const route = routeInput.value.trim();
            
            if (!stop || !route) {
                alert('Please enter both stop and route');
                return;
            }

            getCurrentLocation((boardingLocation) => {
                const tripData = {
                    startStop: stop,
                    route: route,
                    startTime: firebase.firestore.Timestamp.now(),
                    boardingLocation: boardingLocation,
                    userId: currentUser.uid
                };

                // Save to Firestore
                db.collection('activeTrips').doc(currentUser.uid).set(tripData)
                    .then(() => {
                        activeTrip = { id: currentUser.uid, ...tripData };
                        
                        // Update UI
                        const locationText = boardingLocation ? 
                            `📍 GPS: ${boardingLocation.lat.toFixed(4)}, ${boardingLocation.lon.toFixed(4)}` : 
                            '📍 No GPS data';
                        
                        currentTripDiv.innerHTML = `
                            <div><strong>${route}</strong></div>
                            <div>From: ${stop}</div>
                            <div>Started: ${new Date().toLocaleTimeString()}</div>
                            <div style="font-size: 0.8em; color: #666;">${locationText}</div>
                        `;
                        
                        startSection.style.display = 'none';
                        activeSection.style.display = 'block';
                        
                        // Clear form
                        stopInput.value = '';
                        routeInput.value = '';
                        document.getElementById('stopPreview').style.display = 'none';
                        document.getElementById('routePreview').style.display = 'none';
                        updateStartButton();
                        
                        console.log('Trip started and saved to cloud');
                    })
                    .catch((error) => {
                        console.error('Error saving trip:', error);
                        alert('Error starting trip. Please try again.');
                    });
            });
        }

        function showEndModal() {
            endModal.style.display = 'block';
        }

        function hideEndModal() {
            endModal.style.display = 'none';
            exitInput.value = '';
        }

        function saveTrip() {
            const exitStop = exitInput.value.trim();
            
            if (!exitStop) {
                alert('Please enter exit stop');
                return;
            }

            if (!activeTrip) {
                alert('No active trip');
                return;
            }

            getCurrentLocation((exitLocation) => {
                const completedTrip = {
                    startStop: activeTrip.startStop,
                    endStop: exitStop,
                    route: activeTrip.route,
                    startTime: activeTrip.startTime,
                    endTime: firebase.firestore.Timestamp.now(),
                    boardingLocation: activeTrip.boardingLocation,
                    exitLocation: exitLocation,
                    userId: currentUser.uid
                };

                // Calculate duration
                const startMs = activeTrip.startTime.toDate().getTime();
                const endMs = completedTrip.endTime.toDate().getTime();
                completedTrip.duration = Math.round((endMs - startMs) / 1000 / 60);

                // Save completed trip
                db.collection('trips').add(completedTrip)
                    .then(() => {
                        // Remove active trip
                        return db.collection('activeTrips').doc(currentUser.uid).delete();
                    })
                    .then(() => {
                        // Reset UI
                        activeTrip = null;
                        startSection.style.display = 'block';
                        activeSection.style.display = 'none';
                        hideEndModal();
                        
                        loadTrips(); // Refresh trip list
                        
                        const locationMsg = exitLocation ? '📍 GPS captured' : '📍 No GPS';
                        alert(`Trip saved! ${locationMsg}`);
                        
                        console.log('Trip completed and saved to cloud');
                    })
                    .catch((error) => {
                        console.error('Error saving completed trip:', error);
                        alert('Error saving trip. Please try again.');
                    });
            });
        }

        function loadTrips() {
            if (!currentUser) return;

            // Load recent trips
            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .orderBy('startTime', 'desc')
                .limit(20)
                .onSnapshot((snapshot) => {
                    const trips = [];
                    snapshot.forEach((doc) => {
                        trips.push({ id: doc.id, ...doc.data() });
                    });
                    
                    displayTrips(trips);
                });

            // Check for active trip
            db.collection('activeTrips').doc(currentUser.uid)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        activeTrip = { id: doc.id, ...doc.data() };
                        showActiveTrip();
                    } else {
                        activeTrip = null;
                        startSection.style.display = 'block';
                        activeSection.style.display = 'none';
                    }
                });
        }

        function showActiveTrip() {
            if (!activeTrip) return;

            const startTime = activeTrip.startTime.toDate();
            const locationText = activeTrip.boardingLocation ? 
                `📍 GPS: ${activeTrip.boardingLocation.lat.toFixed(4)}, ${activeTrip.boardingLocation.lon.toFixed(4)}` : 
                '📍 No GPS data';
            
            currentTripDiv.innerHTML = `
                <div><strong>${activeTrip.route}</strong></div>
                <div>From: ${activeTrip.startStop}</div>
                <div>Started: ${startTime.toLocaleTimeString()}</div>
                <div style="font-size: 0.8em; color: #666;">${locationText}</div>
            `;
            
            startSection.style.display = 'none';
            activeSection.style.display = 'block';
        }

        function displayTrips(trips) {
            tripCount.textContent = trips.length;
            
            if (trips.length === 0) {
                tripsList.innerHTML = '<div class="empty-state">No trips yet. Start your first trip above!</div>';
                return;
            }

            tripsList.innerHTML = trips.map(trip => {
                const startTime = trip.startTime.toDate();
                return `
                    <div class="trip-item">
                        <div><strong>${trip.route}</strong></div>
                        <div>${trip.startStop} → ${trip.endStop}</div>
                        <div>${trip.duration} min • ${startTime.toLocaleDateString()}</div>
                    </div>
                `;
            }).join('');
        }

        // Location functions
        function getCurrentLocation(callback) {
            if (!navigator.geolocation) {
                console.log('Geolocation not supported');
                updateLocationBox('📍 Location not supported', 'poor');
                callback(null);
                return;
            }

            updateLocationBox('📍 Getting location...', 'loading');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const location = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    console.log('Location captured:', location);
                    
                    const accuracy = Math.round(location.accuracy);
                    let status, className;
                    
                    if (accuracy <= 10) {
                        status = 'excellent';
                        className = 'excellent';
                    } else if (accuracy <= 25) {
                        status = 'good';
                        className = 'good';
                    } else {
                        status = 'poor';
                        className = 'poor';
                    }
                    
                    updateLocationBox(`📍 Location ready (±${accuracy}m)`, className);
                    callback(location);
                },
                (error) => {
                    console.log('Location error:', error);
                    updateLocationBox('📍 Location unavailable', 'poor');
                    callback(null);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 60000
                }
            );
        }

        function updateLocationBox(message, type) {
            locationText.textContent = message;
            locationBox.className = `location-box ${type}`;
            locationBox.style.display = 'block';
        }

        console.log('App initialized with Firebase!');
    </script>
</body>
</html>
