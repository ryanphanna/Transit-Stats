<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransitStats</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f5f5f5; 
            color: #333; 
            line-height: 1.4; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .content-wrapper {
            flex: 1;
        }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 1.2em; font-weight: 600; cursor: pointer; }
        .user-info { display: flex; gap: 8px; }
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s ease;
            min-width: 60px;
        }
        .header-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        .container { max-width: 100%; padding: 15px; }
        .section { background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* Maps specific styles */
        #mapContainer {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            background: #f0f0f0;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        
        .map-controls {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        .map-toggle {
            display: flex;
            background: white;
            border-radius: 20px;
            padding: 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .toggle-btn {
            background: transparent;
            border: none;
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .toggle-btn.active {
            background: #667eea;
            color: white;
        }
        
        .map-legend {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        /* Footer status bar - bottom justified */
        .status-footer {
            background: white;
            border-top: 1px solid #ddd;
            padding: 10px 15px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 20px;
            font-size: 0.9em;
        }
        
        /* Active trip banner */
        .active-trip-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .active-trip-banner:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        
        /* When there's an active trip, streak and trip banners are side by side */
        .banner-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        /* When no active trip, streak banner is full width */
        .banner-container.full-width {
            grid-template-columns: 1fr;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
        }
        .status-indicator.excellent { background: #d4edda; color: #155724; }
        .status-indicator.good { background: #fff3cd; color: #856404; }
        .status-indicator.poor { background: #f8d7da; color: #721c24; }
        .status-indicator.loading { background: #e3f2fd; color: #1976d2; }
        .status-indicator.connected { 
            background: #d4edda; 
            color: #155724; 
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .status-indicator.connected:hover {
            background: #ff4757;
            color: white;
        }
        .status-indicator.connected.logout-mode {
            background: #ff4757;
            color: white;
        }
        .status-indicator.disconnected { background: #f8d7da; color: #721c24; }
        
        .auth-section { text-align: center; padding: 40px 20px; }
        .auth-section h2 { margin-bottom: 20px; color: #333; }
        .auth-section p { margin-bottom: 20px; color: #666; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 1em; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .preview-box { margin-top: 8px; padding: 10px; border-radius: 6px; font-size: 0.9em; border: 1px solid transparent; }
        .preview-box.new { background: #e8f5e8; border-color: #2ed573; color: #2d7738; }
        .preview-box.existing { background: #fff3cd; border-color: #ffc107; color: #856404; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 6px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.2s ease; margin: 10px 0; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-danger { background: #ff4757; color: white; }
        .btn-outline { background: transparent; color: #666; border: 2px solid #ddd; }
        .btn-sm { padding: 8px 12px; font-size: 0.9em; width: auto; }
        .trip-status { background: #e8f5e8; border: 2px solid #2ed573; border-radius: 8px; padding: 20px; margin-bottom: 15px; text-align: center; }
        .trip-item { 
            background: #f9f9f9; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-left: 4px solid #667eea; 
            position: relative;
        }
        .trip-item:hover .delete-trip {
            opacity: 1;
        }
        .delete-trip {
            position: absolute;
            right: 10px;
            top: 10px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 0.8em;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .empty-state { text-align: center; color: #999; padding: 20px; font-style: italic; }
        .auth-status { background: #e3f2fd; border: 1px solid #2196f3; border-radius: 6px; padding: 10px; margin-bottom: 15px; font-size: 0.9em; color: #1976d2; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .emoji-btn { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 12px; font-size: 1.5em; cursor: pointer; transition: all 0.2s ease; }
        .emoji-btn:hover { background: #e9ecef; transform: scale(1.1); }
        .emoji-btn.selected { background: #667eea; border-color: #667eea; transform: scale(1.1); }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; border-radius: 8px; padding: 20px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; color: #667eea; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; color: #666; font-weight: 500; }
        .streak-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 500;
            text-align: center;
            display: none;
        }
        .streak-status.hot-streak {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e6b 100%);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .question-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .question-options.main-options {
            grid-template-columns: repeat(2, 1fr);
        }
        .more-btn {
            grid-column: span 2;
            background: #f8f9fa !important;
            color: #666 !important;
            border: 2px solid #dee2e6 !important;
        }
        .template-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .template-card:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateY(-2px);
        }
        .template-card .template-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.2em;
        }
        .template-card .route-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        .template-card .stop-name {
            color: #666;
            font-size: 0.9em;
        }
        .templates-section {
            margin-bottom: 20px;
        }
        .templates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .templates-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.1em;
        }
        .manage-templates-btn {
            background: transparent;
            border: 1px solid #ddd;
            color: #666;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
        }
        .save-template-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .save-template-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .save-template-checkbox label {
            cursor: pointer;
            font-size: 0.95em;
            color: #333;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
</head>
<body>
    <div class="main-content">
        <div class="header">
            <div class="header-row">
                <h1 class="header-title" onclick="goHome()">TransitStats</h1>
                <div id="userInfo" class="user-info" style="display: none;">
                    <button id="profileBtn" class="header-btn">üë§</button>
                    <button id="statsBtn" class="header-btn">üìä</button>
                    <button id="mapsBtn" class="header-btn">üó∫Ô∏è</button>
                </div>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="container">
                <div id="authSection" class="section auth-section">
                    <h2>Welcome to TransitStats</h2>
                    <p>Sign in to sync your trips across all devices</p>
                    
                    <div id="emailStep">
                        <div class="form-group">
                            <input type="email" id="emailInput" placeholder="Enter your email address">
                        </div>
                        <button id="continueBtn" class="btn btn-primary" disabled>Continue</button>
                    </div>
                    
                    <div id="authMethodStep" style="display: none;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 1.1em; color: #333; margin-bottom: 5px;" id="emailDisplay"></div>
                            <button style="background: none; border: none; color: #667eea; font-size: 0.9em; cursor: pointer; text-decoration: underline;" onclick="goBackToEmail()">Change email</button>
                        </div>
                        
                        <div class="form-group" id="passwordGroup" style="display: none;">
                            <input type="password" id="passwordInput" placeholder="Enter your password">
                        </div>
                        
                        <div id="authButtons" style="display: flex; gap: 10px;">
                            <button id="magicLinkBtn" class="btn btn-primary" style="flex: 1;">‚ú® Magic Link</button>
                            <button id="passwordBtn" class="btn btn-outline" style="flex: 1;">üîë Password</button>
                        </div>
                        
                        <button id="signInBtn" class="btn btn-primary" style="display: none; margin-top: 10px;">Sign In</button>
                    </div>
                    
                    <div id="authStatus" class="auth-status" style="display: none;"></div>
                </div>

                <div id="appContent" style="display: none;">
                    <!-- Banners Container -->
                    <div id="bannersContainer" class="banner-container full-width">
                        <div id="streakStatus" class="streak-status"></div>
                        <div id="activeTripBanner" class="active-trip-banner" style="display: none;" onclick="goToActiveTrip()">
                            üöå Currently riding ‚Ä¢ Tap to view
                        </div>
                    </div>
                
                <div id="profileSection" class="section" style="display: none;">
                    <h2>üë§ Profile</h2>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3em; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span id="profileAvatar">üöå</span>
                            <button id="shuffleEmojiBtn" style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 50%; padding: 8px; font-size: 0.5em; cursor: pointer; width: 30px; height: 30px; display: none;">üé≤</button>
                        </div>
                        <input type="text" id="nameInput" placeholder="Your name (e.g., Ryan)" style="text-align: center; font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">
                    </div>
                    <div id="emojiSelector" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 500;">Choose your transit emoji:</label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                            <button class="emoji-btn" onclick="selectEmoji('üöå')">üöå</button>
                            <button class="emoji-btn" onclick="selectEmoji('üöá')">üöá</button>
                            <button class="emoji-btn" onclick="selectEmoji('üöä')">üöä</button>
                            <button class="emoji-btn" onclick="selectEmoji('üöã')">üöã</button>
                            <button class="emoji-btn" onclick="selectEmoji('üöû')">üöû</button>
                            <button class="emoji-btn" onclick="selectEmoji('üöù')">üöù</button>
                            <button class="emoji-btn" onclick="selectEmoji('üöÑ')">üöÑ</button>
                            <button class="emoji-btn" onclick="selectEmoji('‚úàÔ∏è')">‚úàÔ∏è</button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="saveProfile()" style="flex: 1;">Save Profile</button>
                    </div>

                    <!-- Streak Stats Section -->
                    <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e6b 100%); border-radius: 12px; padding: 20px; margin-bottom: 15px; color: white; text-align: center;">
                        <h3 style="margin-bottom: 15px; font-size: 1.2em;">üî• Streak Stats</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;" id="profileCurrentStreak">0</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Current Streak</div>
                            </div>
                            <div>
                                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;" id="profileBestStreak">0</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">üèÜ Best Streak</div>
                            </div>
                        </div>
                    </div>

                    <!-- Founder Stats Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; margin-bottom: 15px; color: white; text-align: center;">
                        <h3 style="margin-bottom: 15px; font-size: 1.2em;">üöÄ Founder Stats</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;" id="profileFounderRoutes">0</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Routes</div>
                            </div>
                            <div>
                                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;" id="profileFounderStops">0</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Stops</div>
                            </div>
                        </div>
                    </div>

                    <!-- Trip Templates Management -->
                    <div style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;" id="templatesManagement">
                        <h3 style="margin-bottom: 15px; color: #333;">‚≠ê Trip Templates</h3>
                        <div id="profileTemplatesList">
                            <div class="loading">Loading templates...</div>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.9em; color: #666; font-style: italic;">
                            Save templates when ending a trip for quick access on the home page
                        </div>
                    </div>

                    <!-- Recent Trips on Profile Page -->
                    <div style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                        <h3 style="margin-bottom: 15px; color: #333;">Recent Trips</h3>
                        <div id="profileTripsList">
                            <div class="loading">Loading trips...</div>
                        </div>
                    </div>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                        <button class="btn" style="background: #ff4757; color: white;" onclick="signOut()">Sign Out</button>
                    </div>
                </div>

                <div id="statsSection" class="section" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>üìä Your Stats</h2>
                        <div style="background: #f8f9fa; border-radius: 20px; padding: 4px; display: flex;">
                            <button id="statsToggle30" class="btn" style="background: #667eea; color: white; padding: 8px 16px; margin: 0; border-radius: 16px; font-size: 0.9em;">30 Days</button>
                            <button id="statsToggleAll" class="btn btn-outline" style="padding: 8px 16px; margin: 0; border: none; font-size: 0.9em;">All Time</button>
                        </div>
                    </div>
                    
                    <!-- General Stats Section -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="statsTotalTrips">0</div>
                            <div class="stat-label">Trips</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="statsUniqueRoutes">0</div>
                            <div class="stat-label">Routes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="statsTotalTime">0</div>
                            <div class="stat-label">Hours Traveled</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="statsUniqueStops">0</div>
                            <div class="stat-label">Stops Visited</div>
                        </div>
                    </div>

                    <!-- Community Comparison -->
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-top: 20px;">
                        <h3 style="margin-bottom: 15px; color: #333;">üåç Community Comparison</h3>
                        <div id="communityStats">
                            <div class="loading">Loading community data...</div>
                        </div>
                    </div>

                    <!-- Top Routes & Stops -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                        <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
                            <h4 style="margin-bottom: 10px; color: #667eea;">üöå Top Routes</h4>
                            <div id="topRoutes">
                                <div class="loading">Loading...</div>
                            </div>
                        </div>
                        <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
                            <h4 style="margin-bottom: 10px; color: #667eea;">üöè Top Stops</h4>
                            <div id="topStops">
                                <div class="loading">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Maps Section -->
                <div id="mapsSection" class="section" style="display: none;">
                    <h2>üó∫Ô∏è Transit Heatmap</h2>
                    
                    <div class="map-controls">
                        <div class="map-toggle">
                            <button class="toggle-btn active" id="boardingToggle" onclick="setMapMode('boarding')">Boarding</button>
                            <button class="toggle-btn" id="alightingToggle" onclick="setMapMode('alighting')">Alighting</button>
                            <button class="toggle-btn" id="markersToggle" onclick="setMapMode('markers')">All Trips</button>
                        </div>
                        
                        <div class="map-legend" id="mapLegend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #dc2626;"></div>
                                <span>Home Base (50%+)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ea580c;"></div>
                                <span>Regular (25-49%)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ca8a04;"></div>
                                <span>Occasional (10-24%)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #16a34a;"></div>
                                <span>Rare (5-9%)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="mapContainer">
                        <div style="text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 10px;">üó∫Ô∏è</div>
                            <div>Map will appear here when you have location data</div>
                            <div style="font-size: 0.9em; color: #999; margin-top: 10px;">Take some trips with GPS enabled to see your transit patterns</div>
                        </div>
                    </div>
                    
                    <div id="mapStats" style="display: none; background: #f8f9fa; border-radius: 8px; padding: 15px; margin-top: 15px;">
                        <h4 style="margin-bottom: 10px; color: #333;">Map Statistics</h4>
                        <div id="mapStatsContent"></div>
                    </div>
                </div>

                <div id="startSection" class="section">
                    <!-- Trip Templates -->
                    <div id="templatesSection" class="templates-section" style="display: none;">
                        <div class="templates-header">
                            <h3>‚≠ê Quick Start</h3>
                            <button class="manage-templates-btn" onclick="showProfile(); scrollToTemplates();">Manage</button>
                        </div>
                        <div id="templatesList">
                            <!-- Templates will be populated here -->
                        </div>
                    </div>

                    <h2>Start New Trip</h2>
                    <div class="form-group">
                        <label>Boarding Stop</label>
                        <input type="text" id="stopInput" placeholder="e.g., 6638 or Union Station">
                        <div id="stopPreview" class="preview-box" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label>Route/Line</label>
                        <input type="text" id="routeInput" placeholder="e.g., 65, Line 1, 504 King">
                        <div id="routePreview" class="preview-box" style="display: none;"></div>
                    </div>
                    <button id="startBtn" class="btn btn-primary" disabled>üöå Board Vehicle</button>
                </div>

                <div id="activeSection" class="section" style="display: none;">
                    <div class="trip-status">
                        <h2>üöå Currently Riding</h2>
                        <div id="currentTrip"></div>
                    </div>
                    
                    <!-- Progressive Questions -->
                    <div id="progressiveQuestion" class="section" style="display: none; background: #f8f9fa; border: 2px solid #667eea;">
                        <div id="questionText" style="font-weight: 500; margin-bottom: 15px; color: #333;"></div>
                        <div id="questionOptions" class="question-options" style="display: none;">
                            <!-- Options will be populated by JavaScript -->
                        </div>
                        <div class="form-group" id="questionInputGroup">
                            <input type="text" id="questionInput" placeholder="" style="margin-bottom: 10px;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="answerBtn" class="btn" style="background: #667eea; color: white; flex: 1;">Answer</button>
                            <button id="skipBtn" class="btn btn-outline" style="flex: 1;">Skip</button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button id="endBtn" class="btn btn-danger" style="flex: 1;">üõë End Trip</button>
                        <button id="abandonBtn" class="btn btn-outline" style="background: #ffc107; color: #856404; border-color: #ffc107; flex: 1;">‚ö†Ô∏è Cancel Trip</button>
                    </div>
                </div>


            </div>
            </div>

            <div id="endModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px;">
                    <h3>End Trip</h3>
                    <div class="form-group">
                        <label>Exit Stop</label>
                        <input type="text" id="exitInput" placeholder="e.g., 1234 or King Station">
                    </div>
                    <div class="save-template-checkbox">
                        <input type="checkbox" id="saveAsTemplate">
                        <label for="saveAsTemplate">‚≠ê Save as template for quick start</label>
                    </div>
                    <button id="saveBtn" class="btn btn-primary">Save Trip</button>
                    <button id="cancelBtn" class="btn" style="background: #ddd;">Cancel</button>
                </div>
            </div>
                </div>
        </div>

        <!-- Status Footer -->
        <div class="status-footer">
            <div id="locationStatus" class="status-indicator loading">
                üìç Getting location...
            </div>
            <div id="connectionStatus" class="status-indicator connected" onclick="toggleLogout()">
                Logged In
            </div>
        </div>

    <script>
        console.log('üöÄ TransitStats Loading...');
        
        const firebaseConfig = {
            apiKey: "AIzaSyBgY37b_aUorxdEW6DnocFoo8ekbTTFpao",
            authDomain: "transitstats-21ba4.firebaseapp.com",
            projectId: "transitstats-21ba4",
            storageBucket: "transitstats-21ba4.firebasestorage.app",
            messagingSenderId: "756203797723",
            appId: "1:756203797723:web:2e5aab94a6de20cf06a0fe"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        console.log('‚úÖ Firebase initialized successfully!');

        let currentUser = null;
        let activeTrip = null;
        let currentStatsView = '30days';
        let logoutModeActive = false;
        let statsInitialized = false;
        let map = null;
        let mapMode = 'boarding';
        let mapInitialized = false;

        // DOM Elements
        const authSection = document.getElementById('authSection');
        const appContent = document.getElementById('appContent');
        const profileSection = document.getElementById('profileSection');
        const statsSection = document.getElementById('statsSection');
        const mapsSection = document.getElementById('mapsSection');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const continueBtn = document.getElementById('continueBtn');
        const magicLinkBtn = document.getElementById('magicLinkBtn');
        const passwordBtn = document.getElementById('passwordBtn');
        const signInBtn = document.getElementById('signInBtn');
        const authStatus = document.getElementById('authStatus');
        const userInfo = document.getElementById('userInfo');
        const profileBtn = document.getElementById('profileBtn');
        const statsBtn = document.getElementById('statsBtn');
        const mapsBtn = document.getElementById('mapsBtn');
        const stopInput = document.getElementById('stopInput');
        const routeInput = document.getElementById('routeInput');
        const startBtn = document.getElementById('startBtn');
        const startSection = document.getElementById('startSection');
        const activeSection = document.getElementById('activeSection');
        const currentTripDiv = document.getElementById('currentTrip');
        const endBtn = document.getElementById('endBtn');
        const endModal = document.getElementById('endModal');
        const exitInput = document.getElementById('exitInput');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const tripsList = document.getElementById('tripsList');
        const tripCount = document.getElementById('tripCount');
        const progressiveQuestion = document.getElementById('progressiveQuestion');
        const questionText = document.getElementById('questionText');
        const questionInput = document.getElementById('questionInput');
        const answerBtn = document.getElementById('answerBtn');
        const skipBtn = document.getElementById('skipBtn');
        const streakStatus = document.getElementById('streakStatus');
        const locationStatus = document.getElementById('locationStatus');
        const connectionStatus = document.getElementById('connectionStatus');
        const activeTripBanner = document.getElementById('activeTripBanner');
        const bannersContainer = document.getElementById('bannersContainer');

        // Authentication State Management
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                console.log('‚úÖ User authenticated:', user.email);
                showApp();
            } else {
                console.log('‚ùå No user authenticated');
                showAuth();
            }
        });

        function showAuth() {
            authSection.style.display = 'block';
            appContent.style.display = 'none';
            userInfo.style.display = 'none';
        }

        function showApp() {
            authSection.style.display = 'none';
            appContent.style.display = 'block';
            userInfo.style.display = 'block';
            loadUserProfile();
            initializeApp();
        }

        // Profile Management
        function loadUserProfile() {
            db.collection('profiles').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const profile = doc.data();
                        const emoji = profile.emoji || 'üöå';
                        document.getElementById('profileAvatar').textContent = emoji;
                        document.getElementById('nameInput').value = profile.name || '';
                        
                        if (profile.emoji) {
                            document.getElementById('emojiSelector').style.display = 'none';
                            document.getElementById('shuffleEmojiBtn').style.display = 'block';
                        }
                    }
                })
                .catch((error) => {
                    console.log('Profile load error (using defaults):', error.message);
                });
        }

        function showProfile() {
            hideAllSections();
            profileSection.style.display = 'block';
            document.getElementById('startSection').style.display = 'none';
            document.getElementById('recentTripsSection').style.display = 'none';
            updateTripIndicator();
            updateProfileStats();
            // Load profile trips separately to avoid caching issues
            loadProfileTrips();
        }

        function showStats() {
            hideAllSections();
            statsSection.style.display = 'block';
            document.getElementById('startSection').style.display = 'none';
            document.getElementById('recentTripsSection').style.display = 'none';
            updateTripIndicator();
            
            // Initialize stats toggle only once
            if (!statsInitialized) {
                initializeStatsToggle();
                statsInitialized = true;
            }
            
            // Force refresh stats on page load
            updateStatsSection();
            loadCommunityData();
        }

        function showMaps() {
            hideAllSections();
            mapsSection.style.display = 'block';
            updateTripIndicator();
            
            // Initialize map if not already done
            if (!mapInitialized) {
                initializeMap();
            } else {
                // Just reload the data
                loadMapData();
            }
        }

        function hideAllSections() {
            profileSection.style.display = 'none';
            statsSection.style.display = 'none';
            mapsSection.style.display = 'none';
        }

        function goHome() {
            hideAllSections();
            if (activeTrip) {
                showActiveSection();
            } else {
                showStartSection();
            }
        }

        // Maps functionality
        function initializeMap() {
            if (!currentUser) return;
            
            loadMapData();
            mapInitialized = true;
        }

        function loadMapData() {
            if (!currentUser) return;

            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((snapshot) => {
                    const trips = [];
                    snapshot.forEach((doc) => {
                        const trip = doc.data();
                        // Only include trips with location data
                        if (trip.boardingLocation || trip.exitLocation) {
                            trips.push(trip);
                        }
                    });

                    if (trips.length === 0) {
                        document.getElementById('mapContainer').innerHTML = `
                            <div style="text-align: center;">
                                <div style="font-size: 2em; margin-bottom: 10px;">üó∫Ô∏è</div>
                                <div>No location data available yet</div>
                                <div style="font-size: 0.9em; color: #999; margin-top: 10px;">Take some trips with GPS enabled to see your transit patterns</div>
                            </div>
                        `;
                        return;
                    }

                    // Check if we have enough trips for meaningful heatmap (50+ recommended)
                    if (trips.length >= 50) {
                        createMap(trips);
                        updateMapStats(trips);
                    } else {
                        document.getElementById('mapContainer').innerHTML = `
                            <div style="text-align: center;">
                                <div style="font-size: 2em; margin-bottom: 10px;">üó∫Ô∏è</div>
                                <div>Need more trips for heatmap (${trips.length}/50)</div>
                                <div style="font-size: 0.9em; color: #999; margin-top: 10px;">Keep taking trips with GPS to unlock your transit heatmap!</div>
                                <div style="margin-top: 15px;">
                                    <button class="btn" style="background: #667eea; color: white; padding: 10px 20px; font-size: 0.9em;" onclick="setMapMode('markers'); loadMapData();">
                                        View individual trips (${trips.length} available)
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                })
                .catch((error) => {
                    console.error('Error loading map data:', error);
                    document.getElementById('mapContainer').innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 10px;">‚ùå</div>
                            <div>Error loading map data</div>
                        </div>
                    `;
                });
        }

        function createMap(trips) {
            // Clear existing map
            document.getElementById('mapContainer').innerHTML = '';
            
            // Calculate map center from all locations
            const locations = [];
            trips.forEach(trip => {
                if (trip.boardingLocation) {
                    locations.push([trip.boardingLocation.lat, trip.boardingLocation.lon]);
                }
                if (trip.exitLocation) {
                    locations.push([trip.exitLocation.lat, trip.exitLocation.lon]);
                }
            });

            if (locations.length === 0) return;

            // Calculate center
            const avgLat = locations.reduce((sum, loc) => sum + loc[0], 0) / locations.length;
            const avgLon = locations.reduce((sum, loc) => sum + loc[1], 0) / locations.length;

            // Initialize map
            map = L.map('mapContainer').setView([avgLat, avgLon], 12);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            if (mapMode === 'boarding' || mapMode === 'alighting') {
                createHeatmap(trips, mapMode);
            } else {
                createMarkers(trips);
            }
        }

        function createHeatmap(trips, mode) {
            // Count stop usage based on mode
            const stopCounts = {};
            
            trips.forEach(trip => {
                if (mode === 'boarding' && trip.boardingLocation && trip.startStop) {
                    const key = trip.startStop;
                    if (!stopCounts[key]) {
                        stopCounts[key] = {
                            name: trip.startStop,
                            lat: trip.boardingLocation.lat,
                            lon: trip.boardingLocation.lon,
                            count: 0
                        };
                    }
                    stopCounts[key].count++;
                } else if (mode === 'alighting' && trip.exitLocation && trip.endStop) {
                    const key = trip.endStop;
                    if (!stopCounts[key]) {
                        stopCounts[key] = {
                            name: trip.endStop,
                            lat: trip.exitLocation.lat,
                            lon: trip.exitLocation.lon,
                            count: 0
                        };
                    }
                    stopCounts[key].count++;
                }
            });

            // Filter to only show stops with 5+ uses
            const significantStops = Object.values(stopCounts)
                .filter(stop => stop.count >= 5)
                .sort((a, b) => b.count - a.count);

            if (significantStops.length === 0) {
                // Clear map and show message
                if (map) {
                    map.eachLayer((layer) => {
                        if (layer !== map._layers[Object.keys(map._layers)[0]]) { // Don't remove tile layer
                            map.removeLayer(layer);
                        }
                    });
                }
                
                const modeText = mode === 'boarding' ? 'boarding locations' : 'alighting locations';
                document.getElementById('mapContainer').innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üó∫Ô∏è</div>
                        <div>No repeated ${modeText} found</div>
                        <div style="font-size: 0.9em; color: #999; margin-top: 10px;">Use the same stop 5+ times to see it on the heatmap</div>
                    </div>
                `;
                return;
            }

            // Find max usage for percentage calculation
            const maxUsage = significantStops[0].count;

            // Create circles for each stop with dynamic color scaling
            significantStops.forEach((stop, index) => {
                const percentage = (stop.count / maxUsage) * 100;
                let color, description;
                
                if (percentage >= 50) {
                    color = '#dc2626'; // Dark red - Home base
                    description = 'Home Base';
                } else if (percentage >= 25) {
                    color = '#ea580c'; // Orange - Regular  
                    description = 'Regular';
                } else if (percentage >= 10) {
                    color = '#ca8a04'; // Yellow - Occasional
                    description = 'Occasional';
                } else {
                    color = '#16a34a'; // Green - Rare
                    description = 'Rare';
                }

                // Scale radius: 15-40px based on relative usage
                const radius = 15 + (percentage / 100) * 25;

                const circle = L.circle([stop.lat, stop.lon], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.7,
                    radius: radius * 15 // Multiply for visibility on map
                }).addTo(map);

                // Add popup with stop info
                const modeText = mode === 'boarding' ? 'boardings' : 'alightings';
                circle.bindPopup(`
                    <strong>${stop.name}</strong><br>
                    ${description} (${Math.round(percentage)}% of max)<br>
                    ${stop.count} ${modeText}<br>
                    Rank: #${index + 1}
                `);
            });
        }

        function createMarkers(trips) {
            // Create separate markers for each trip
            trips.forEach((trip, index) => {
                // Boarding marker
                if (trip.boardingLocation) {
                    const boardingMarker = L.marker([trip.boardingLocation.lat, trip.boardingLocation.lon])
                        .addTo(map);
                    
                    boardingMarker.bindPopup(`
                        <strong>üöå Boarding</strong><br>
                        Stop: ${trip.startStop}<br>
                        Route: ${trip.route}<br>
                        Time: ${trip.startTime?.toDate ? trip.startTime.toDate().toLocaleString() : 'Unknown'}
                    `);
                }

                // Alighting marker
                if (trip.exitLocation) {
                    const alightingMarker = L.marker([trip.exitLocation.lat, trip.exitLocation.lon])
                        .addTo(map);
                    
                    alightingMarker.bindPopup(`
                        <strong>üöè Alighting</strong><br>
                        Stop: ${trip.endStop}<br>
                        Route: ${trip.route}<br>
                        Duration: ${trip.duration || 0} minutes
                    `);
                }
            });
        }

        function setMapMode(mode) {
            mapMode = mode;
            
            // Update toggle buttons
            document.getElementById('boardingToggle').className = mode === 'boarding' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('alightingToggle').className = mode === 'alighting' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('markersToggle').className = mode === 'markers' ? 'toggle-btn active' : 'toggle-btn';
            
            // Update legend visibility
            document.getElementById('mapLegend').style.display = (mode === 'boarding' || mode === 'alighting') ? 'flex' : 'none';
            
            // Reload map data
            if (mapInitialized) {
                loadMapData();
            }
        }

        function updateMapStats(trips) {
            const locatedTrips = trips.filter(t => t.boardingLocation || t.exitLocation);
            const bothLocations = trips.filter(t => t.boardingLocation && t.exitLocation);
            
            const statsHtml = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">${locatedTrips.length}</div>
                        <div style="font-size: 0.9em; color: #666;">Trips with GPS</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">${bothLocations.length}</div>
                        <div style="font-size: 0.9em; color: #666;">Complete journeys</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">${Math.round((locatedTrips.length / trips.length) * 100)}%</div>
                        <div style="font-size: 0.9em; color: #666;">GPS coverage</div>
                    </div>
                </div>
            `;
            
            document.getElementById('mapStatsContent').innerHTML = statsHtml;
            document.getElementById('mapStats').style.display = 'block';
        }

        function updateTripIndicator() {
            const streakVisible = streakStatus.style.display === 'block';
            
            if (activeTrip) {
                activeTripBanner.innerHTML = `üöå Currently riding ${activeTrip.route} ‚Ä¢ Tap to view`;
                activeTripBanner.style.display = 'block';
                
                // Only use side-by-side layout if BOTH banners are visible
                if (streakVisible) {
                    bannersContainer.className = 'banner-container'; // Side by side
                    // Make streak banner text shorter when sharing space
                    const currentText = streakStatus.textContent;
                    if (currentText && currentText.includes('Keep it going!')) {
                        streakStatus.textContent = currentText.replace(' Keep it going!', '').replace(' You\'re a transit champion!', '');
                    }
                } else {
                    bannersContainer.className = 'banner-container full-width'; // Full width for single banner
                }
            } else {
                activeTripBanner.style.display = 'none';
                bannersContainer.className = 'banner-container full-width'; // Full width
                
                // Restore full streak text when banner is full width
                if (streakVisible) {
                    // Re-calculate to get proper text
                    loadTrips();
                }
            }
        }

        function toggleLogout() {
            if (!logoutModeActive) {
                connectionStatus.textContent = 'Log Out';
                connectionStatus.classList.add('logout-mode');
                logoutModeActive = true;
                
                // Reset after 3 seconds if not clicked
                setTimeout(() => {
                    if (logoutModeActive) {
                        connectionStatus.textContent = 'Logged In';
                        connectionStatus.classList.remove('logout-mode');
                        logoutModeActive = false;
                    }
                }, 3000);
            } else {
                // Actually log out
                signOut();
            }
        }

        function selectEmoji(emoji) {
            document.querySelectorAll('.emoji-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('profileAvatar').textContent = emoji;
        }

        function shuffleEmoji() {
            const emojis = ['üöå', 'üöá', 'üöä', 'üöã', 'üöû', 'üöù', 'üöÑ', '‚úàÔ∏è'];
            const currentEmoji = document.getElementById('profileAvatar').textContent;
            let newEmoji;
            do {
                newEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            } while (newEmoji === currentEmoji);
            
            document.getElementById('profileAvatar').textContent = newEmoji;
        }

        function saveProfile() {
            const name = document.getElementById('nameInput').value.trim();
            const emoji = document.getElementById('profileAvatar').textContent;
            
            if (!name) {
                alert('Please enter your name');
                return;
            }

            const profileData = {
                name: name,
                emoji: emoji,
                userId: currentUser.uid,
                updatedAt: firebase.firestore.Timestamp.now()
            };

            db.collection('profiles').doc(currentUser.uid).set(profileData)
                .then(() => {
                    alert('Profile saved!');
                    goHome();
                })
                .catch((error) => {
                    console.error('Error saving profile:', error);
                    alert('Error saving profile. Please try again.');
                });
        }

        function signOut() {
            auth.signOut();
        }

        // Stats Management
        function initializeStatsToggle() {
            const toggle30 = document.getElementById('statsToggle30');
            const toggleAll = document.getElementById('statsToggleAll');
            
            toggle30.addEventListener('click', () => {
                if (currentStatsView !== '30days') {
                    currentStatsView = '30days';
                    toggle30.style.background = '#667eea';
                    toggle30.style.color = 'white';
                    toggleAll.style.background = 'transparent';
                    toggleAll.style.color = '#666';
                    updateStatsSection();
                    loadCommunityData();
                }
            });
            
            toggleAll.addEventListener('click', () => {
                if (currentStatsView !== 'alltime') {
                    currentStatsView = 'alltime';
                    toggleAll.style.background = '#667eea';
                    toggleAll.style.color = 'white';
                    toggle30.style.background = 'transparent';
                    toggle30.style.color = '#666';
                    updateStatsSection();
                    loadCommunityData();
                }
            });
        }

        function updateStatsSection() {
            if (!currentUser) return;

            const now = new Date();
            let query = db.collection('trips').where('userId', '==', currentUser.uid);
            
            if (currentStatsView === '30days') {
                const dateFilter = new Date();
                dateFilter.setDate(dateFilter.getDate() - 30);
                console.log('Filtering trips after:', dateFilter);
                query = query.where('startTime', '>=', firebase.firestore.Timestamp.fromDate(dateFilter));
            }

            query.orderBy('startTime', 'desc').get()
                .then((snapshot) => {
                    console.log(`Found ${snapshot.size} trips for ${currentStatsView}`);
                    
                    const trips = [];
                    snapshot.forEach((doc) => {
                        const trip = doc.data();
                        trips.push(trip);
                        
                        // Debug log for first few trips
                        if (trips.length <= 3) {
                            const tripDate = trip.startTime?.toDate ? trip.startTime.toDate() : new Date(trip.startTime);
                            console.log(`Trip on ${tripDate.toLocaleDateString()}: ${trip.route}`);
                        }
                    });

                    const totalTrips = trips.length;
                    const uniqueRoutes = new Set(trips.map(t => t.route)).size;
                    const totalMinutes = trips.reduce((sum, t) => sum + (t.duration || 0), 0);
                    const totalHours = Math.round(totalMinutes / 60 * 10) / 10;
                    
                    const stops = new Set();
                    trips.forEach(t => {
                        if (t.startStop) stops.add(t.startStop);
                        if (t.endStop) stops.add(t.endStop);
                    });
                    const uniqueStops = stops.size;

                    document.getElementById('statsTotalTrips').textContent = totalTrips;
                    document.getElementById('statsUniqueRoutes').textContent = uniqueRoutes;
                    document.getElementById('statsTotalTime').textContent = totalHours;
                    document.getElementById('statsUniqueStops').textContent = uniqueStops;

                    generateTopRoutes(trips);
                    generateTopStops(trips);
                })
                .catch((error) => {
                    console.error('Error updating stats:', error);
                    // Try without orderBy if it fails
                    const fallbackQuery = currentStatsView === '30days' ? 
                        db.collection('trips').where('userId', '==', currentUser.uid) : 
                        db.collection('trips').where('userId', '==', currentUser.uid);
                        
                    fallbackQuery.get().then((snapshot) => {
                        const trips = [];
                        snapshot.forEach((doc) => {
                            const trip = doc.data();
                            if (currentStatsView === '30days') {
                                const tripDate = trip.startTime?.toDate ? trip.startTime.toDate() : new Date(trip.startTime);
                                const thirtyDaysAgo = new Date();
                                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                                if (tripDate >= thirtyDaysAgo) {
                                    trips.push(trip);
                                }
                            } else {
                                trips.push(trip);
                            }
                        });
                        
                        // Update stats with filtered trips
                        const totalTrips = trips.length;
                        const uniqueRoutes = new Set(trips.map(t => t.route)).size;
                        const totalMinutes = trips.reduce((sum, t) => sum + (t.duration || 0), 0);
                        const totalHours = Math.round(totalMinutes / 60 * 10) / 10;
                        
                        const stops = new Set();
                        trips.forEach(t => {
                            if (t.startStop) stops.add(t.startStop);
                            if (t.endStop) stops.add(t.endStop);
                        });
                        const uniqueStops = stops.size;

                        document.getElementById('statsTotalTrips').textContent = totalTrips;
                        document.getElementById('statsUniqueRoutes').textContent = uniqueRoutes;
                        document.getElementById('statsTotalTime').textContent = totalHours;
                        document.getElementById('statsUniqueStops').textContent = uniqueStops;

                        generateTopRoutes(trips);
                        generateTopStops(trips);
                    });
                });
        }

        function updateProfileStats() {
            if (!currentUser) return;

            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((snapshot) => {
                    const trips = [];
                    snapshot.forEach((doc) => {
                        trips.push(doc.data());
                    });

                    // Calculate streaks for profile
                    const streakData = calculateStreaks(trips);
                    document.getElementById('profileCurrentStreak').textContent = streakData.current;
                    document.getElementById('profileBestStreak').textContent = streakData.best;

                    // Calculate founder stats
                    calculateFounderStats(trips);
                });
        }

        function loadProfileTrips() {
            if (!currentUser) return;

            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .orderBy('startTime', 'desc')
                .limit(20)
                .get()
                .then((snapshot) => {
                    const trips = [];
                    snapshot.forEach((doc) => {
                        trips.push({ id: doc.id, ...doc.data() });
                    });
                    
                    displayProfileTrips(trips);
                })
                .catch((error) => {
                    console.error('Error loading profile trips:', error);
                });
        }

        function displayProfileTrips(trips) {
            const profileTripsList = document.getElementById('profileTripsList');
            
            if (trips.length === 0) {
                profileTripsList.innerHTML = '<div class="empty-state">No trips yet. Start your first trip!</div>';
                return;
            }

            const tripsHtml = trips.map(trip => {
                let startTime;
                if (trip.startTime?.toDate) {
                    startTime = trip.startTime.toDate();
                } else if (trip.startTime) {
                    startTime = new Date(trip.startTime);
                } else {
                    startTime = new Date();
                }
                
                return `
                    <div class="trip-item">
                        <button class="delete-trip" onclick="deleteTrip('${trip.id}')">Delete</button>
                        <div><strong>${trip.route || 'Unknown Route'}</strong></div>
                        <div>${trip.startStop || 'Unknown'} ‚Üí ${trip.endStop || 'Unknown'}</div>
                        <div>${trip.duration || 0} min ‚Ä¢ ${startTime.toLocaleDateString()}</div>
                    </div>
                `;
            }).join('');

            profileTripsList.innerHTML = tripsHtml;
        }

        function calculateFounderStats(trips) {
            // For now, show 0s until we implement route/stop founding
            // This will be updated when trips start tracking new routes/stops
            document.getElementById('profileFounderRoutes').textContent = '0';
            document.getElementById('profileFounderStops').textContent = '0';
        }

        function generateTopRoutes(trips) {
            const routeCounts = {};
            trips.forEach(trip => {
                const route = trip.route || 'Unknown';
                routeCounts[route] = (routeCounts[route] || 0) + 1;
            });

            const sortedRoutes = Object.entries(routeCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const topRoutesHtml = sortedRoutes.length > 0 ? 
                sortedRoutes.map(([route, count], index) => 
                    `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                        <span>${index + 1}. ${route}</span>
                        <span style="color: #667eea; font-weight: 600;">${count} trips</span>
                    </div>`
                ).join('') : 
                '<div style="color: #999; font-style: italic;">No trips yet</div>';

            document.getElementById('topRoutes').innerHTML = topRoutesHtml;
        }

        function generateTopStops(trips) {
            const stopCounts = {};
            trips.forEach(trip => {
                const startStop = trip.startStop || 'Unknown';
                const endStop = trip.endStop || 'Unknown';
                stopCounts[startStop] = (stopCounts[startStop] || 0) + 1;
                stopCounts[endStop] = (stopCounts[endStop] || 0) + 1;
            });

            const sortedStops = Object.entries(stopCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const topStopsHtml = sortedStops.length > 0 ? 
                sortedStops.map(([stop, count], index) => 
                    `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                        <span>${index + 1}. ${stop}</span>
                        <span style="color: #667eea; font-weight: 600;">${count} uses</span>
                    </div>`
                ).join('') : 
                '<div style="color: #999; font-style: italic;">No trips yet</div>';

            document.getElementById('topStops').innerHTML = topStopsHtml;
        }

        function loadCommunityData() {
            const dateFilter = new Date();
            if (currentStatsView === '30days') {
                dateFilter.setDate(dateFilter.getDate() - 30);
            } else {
                dateFilter.setFullYear(dateFilter.getFullYear() - 10);
            }

            db.collection('trips')
                .where('startTime', '>=', firebase.firestore.Timestamp.fromDate(dateFilter))
                .get()
                .then((snapshot) => {
                    const allTrips = [];
                    const userTrips = [];
                    
                    snapshot.forEach((doc) => {
                        const trip = doc.data();
                        allTrips.push(trip);
                        if (trip.userId === currentUser.uid) {
                            userTrips.push(trip);
                        }
                    });

                    const totalUsers = new Set(allTrips.map(t => t.userId)).size;
                    const userRank = calculateUserRank(userTrips.length, allTrips);
                    const avgTripsPerUser = totalUsers > 0 ? Math.round(allTrips.length / totalUsers * 10) / 10 : 0;
                    
                    const timeLabel = currentStatsView === '30days' ? '30 days' : 'all time';

                    const communityHtml = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #667eea;">${userTrips.length}</div>
                                <div style="font-size: 0.9em; color: #666;">Your trips (${timeLabel})</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #667eea;">#${userRank}</div>
                                <div style="font-size: 0.9em; color: #666;">Your rank</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #667eea;">${totalUsers}</div>
                                <div style="font-size: 0.9em; color: #666;">Total users</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #667eea;">${avgTripsPerUser}</div>
                                <div style="font-size: 0.9em; color: #666;">Avg trips/user</div>
                            </div>
                        </div>
                    `;

                    document.getElementById('communityStats').innerHTML = communityHtml;
                })
                .catch((error) => {
                    console.error('Error loading community data:', error);
                    document.getElementById('communityStats').innerHTML = '<div style="color: #999; font-style: italic;">Unable to load community data</div>';
                });
        }

        function calculateUserRank(userTripCount, allTrips) {
            const userCounts = {};
            allTrips.forEach(trip => {
                userCounts[trip.userId] = (userCounts[trip.userId] || 0) + 1;
            });

            const sortedCounts = Object.values(userCounts).sort((a, b) => b - a);
            const rank = sortedCounts.findIndex(count => count <= userTripCount) + 1;
            return rank || sortedCounts.length + 1;
        }

        function calculateStreaks(trips) {
            if (trips.length === 0) return { current: 0, best: 0 };

            const sortedTrips = trips.sort((a, b) => {
                const dateA = a.startTime?.toDate ? a.startTime.toDate() : new Date(a.startTime);
                const dateB = b.startTime?.toDate ? b.startTime.toDate() : new Date(b.startTime);
                return dateB - dateA;
            });

            const tripDays = new Set();
            sortedTrips.forEach(trip => {
                const date = trip.startTime?.toDate ? trip.startTime.toDate() : new Date(trip.startTime);
                const dayString = date.toDateString();
                tripDays.add(dayString);
            });

            const uniqueDays = Array.from(tripDays).sort((a, b) => new Date(b) - new Date(a));

            // Check if today is the only day with trips
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayString = today.toDateString();
            
            if (uniqueDays.length === 1 && uniqueDays[0] === todayString) {
                // First day of usage - no streak yet
                return { current: 0, best: 0 };
            }

            let currentStreak = 0;
            let bestStreak = 0;
            let tempStreak = 0;

            for (let i = 0; i < uniqueDays.length; i++) {
                const currentDay = new Date(uniqueDays[i]);
                currentDay.setHours(0, 0, 0, 0);

                if (i === 0) {
                    const diffDays = Math.floor((today - currentDay) / (1000 * 60 * 60 * 24));
                    if (diffDays <= 1) {
                        currentStreak = 1;
                        tempStreak = 1;
                    }
                } else {
                    const prevDay = new Date(uniqueDays[i - 1]);
                    prevDay.setHours(0, 0, 0, 0);
                    const diffDays = Math.floor((prevDay - currentDay) / (1000 * 60 * 60 * 24));

                    if (diffDays === 1) {
                        tempStreak++;
                        if (i === 0 || currentStreak > 0) {
                            currentStreak = tempStreak;
                        }
                    } else {
                        bestStreak = Math.max(bestStreak, tempStreak);
                        tempStreak = 1;
                        if (currentStreak > 0 && i > 0) {
                            currentStreak = 0;
                        }
                    }
                }
            }

            bestStreak = Math.max(bestStreak, tempStreak, currentStreak);
            return { current: currentStreak, best: bestStreak };
        }

        // Template Management
        function loadTemplates() {
            if (!currentUser) return;

            db.collection('templates')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .limit(3)
                .get()
                .then((snapshot) => {
                    const templates = [];
                    snapshot.forEach((doc) => {
                        templates.push({ id: doc.id, ...doc.data() });
                    });
                    
                    displayTemplates(templates);
                    displayProfileTemplates(templates);
                })
                .catch((error) => {
                    console.error('Error loading templates:', error);
                });
        }

        function displayTemplates(templates) {
            const templatesSection = document.getElementById('templatesSection');
            const templatesList = document.getElementById('templatesList');
            
            if (templates.length === 0) {
                templatesSection.style.display = 'none';
                return;
            }
            
            templatesSection.style.display = 'block';
            
            const templatesHtml = templates.slice(0, 3).map(template => `
                <div class="template-card" onclick="startFromTemplate('${template.route}', '${template.startStop}')">
                    <span class="template-icon">‚≠ê</span>
                    <div class="route-name">${template.route}</div>
                    <div class="stop-name">From ${template.startStop}</div>
                </div>
            `).join('');
            
            templatesList.innerHTML = templatesHtml;
        }

        function displayProfileTemplates(templates) {
            const profileTemplatesList = document.getElementById('profileTemplatesList');
            
            if (templates.length === 0) {
                profileTemplatesList.innerHTML = '<div class="empty-state">No saved templates yet</div>';
                return;
            }
            
            const templatesHtml = templates.map(template => `
                <div class="trip-item">
                    <button class="delete-trip" onclick="deleteTemplate('${template.id}')">Delete</button>
                    <div><strong>${template.route}</strong></div>
                    <div>From ${template.startStop}</div>
                    <div style="font-size: 0.9em; color: #666;">‚≠ê Quick start template</div>
                </div>
            `).join('');
            
            profileTemplatesList.innerHTML = templatesHtml;
        }

        function startFromTemplate(route, startStop) {
            // Fill in the form
            stopInput.value = startStop;
            routeInput.value = route;
            updateStartButton();
            
            // Flash the fields to show they were filled
            stopInput.style.background = '#e8f5e8';
            routeInput.style.background = '#e8f5e8';
            
            setTimeout(() => {
                stopInput.style.background = '';
                routeInput.style.background = '';
            }, 500);
            
            // Focus on the start button
            startBtn.focus();
        }

        function deleteTemplate(templateId) {
            if (confirm('Delete this template?')) {
                db.collection('templates').doc(templateId).delete()
                    .then(() => {
                        loadTemplates();
                    })
                    .catch((error) => {
                        console.error('Error deleting template:', error);
                        alert('Error deleting template');
                    });
            }
        }

        function scrollToTemplates() {
            setTimeout(() => {
                const templatesSection = document.getElementById('templatesManagement');
                if (templatesSection) {
                    templatesSection.scrollIntoView({ behavior: 'smooth' });
                }
            }, 100);
        }

        // Delete Trip Function
        function deleteTrip(tripId) {
            if (confirm('Are you sure you want to delete this trip?')) {
                db.collection('trips').doc(tripId).delete()
                    .then(() => {
                        alert('Trip deleted');
                        loadTrips();
                        loadProfileTrips();
                        updateProfileStats();
                    })
                    .catch((error) => {
                        console.error('Error deleting trip:', error);
                        alert('Error deleting trip');
                    });
            }
        }

        // Authentication Event Handlers
        continueBtn.addEventListener('click', () => {
            const email = emailInput.value.trim();
            if (!email) {
                alert('Please enter your email');
                return;
            }
            
            // Show email and method selection
            document.getElementById('emailDisplay').textContent = email;
            document.getElementById('emailStep').style.display = 'none';
            document.getElementById('authMethodStep').style.display = 'block';
        });

        emailInput.addEventListener('input', () => {
            const email = emailInput.value.trim();
            continueBtn.disabled = !email || !email.includes('@');
        });

        emailInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !continueBtn.disabled) {
                continueBtn.click();
            }
        });

        function goBackToEmail() {
            document.getElementById('emailStep').style.display = 'block';
            document.getElementById('authMethodStep').style.display = 'none';
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('authButtons').style.display = 'flex';
            document.getElementById('signInBtn').style.display = 'none';
            authStatus.style.display = 'none';
        }

        magicLinkBtn.addEventListener('click', () => {
            const email = emailInput.value.trim();
            const actionCodeSettings = {
                url: window.location.href,
                handleCodeInApp: true,
            };

            magicLinkBtn.disabled = true;
            magicLinkBtn.textContent = 'Sending...';

            auth.sendSignInLinkToEmail(email, actionCodeSettings)
                .then(() => {
                    localStorage.setItem('emailForSignIn', email);
                    showAuthStatus('Check your email for a magic link!', 'success');
                    magicLinkBtn.textContent = '‚ú® Magic Link Sent';
                })
                .catch((error) => {
                    console.error('Error sending email:', error);
                    showAuthStatus('Magic link failed. Please try again.', 'error');
                    magicLinkBtn.disabled = false;
                    magicLinkBtn.textContent = '‚ú® Magic Link';
                });
        });

        passwordBtn.addEventListener('click', () => {
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('authButtons').style.display = 'none';
            document.getElementById('signInBtn').style.display = 'block';
            passwordInput.focus();
        });

        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                signInBtn.click();
            }
        });

        signInBtn.addEventListener('click', () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            signInBtn.disabled = true;
            signInBtn.textContent = 'Signing in...';

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    showAuthStatus('Signed in successfully!', 'success');
                })
                .catch((error) => {
                    if (error.code === 'auth/user-not-found') {
                        auth.createUserWithEmailAndPassword(email, password)
                            .then(() => {
                                showAuthStatus('Account created and signed in!', 'success');
                            })
                            .catch((error) => {
                                console.error('Error creating account:', error);
                                showAuthStatus('Error creating account. Please try again.', 'error');
                                signInBtn.disabled = false;
                                signInBtn.textContent = 'Sign In';
                            });
                    } else {
                        console.error('Error signing in:', error);
                        showAuthStatus('Invalid email or password.', 'error');
                        signInBtn.disabled = false;
                        signInBtn.textContent = 'Sign In';
                    }
                });
        });

        if (auth.isSignInWithEmailLink(window.location.href)) {
            let email = localStorage.getItem('emailForSignIn');
            if (!email) {
                email = window.prompt('Please provide your email for confirmation');
            }

            auth.signInWithEmailLink(email, window.location.href)
                .then(() => {
                    localStorage.removeItem('emailForSignIn');
                })
                .catch((error) => {
                    console.error('Error signing in:', error);
                });
        }

        function showAuthStatus(message, type) {
            authStatus.textContent = message;
            authStatus.className = type === 'success' ? 'auth-status' : 'auth-status error';
            authStatus.style.display = 'block';
        }

        // Trip Management
        function updateStartButton() {
            const hasStop = stopInput.value.trim().length > 0;
            const hasRoute = routeInput.value.trim().length > 0;
            startBtn.disabled = !(hasStop && hasRoute);
            updateStopPreview();
            updateRoutePreview();
        }

        function updateStopPreview() {
            const stopValue = stopInput.value.trim();
            const preview = document.getElementById('stopPreview');
            
            if (!stopValue) {
                preview.style.display = 'none';
                return;
            }

            const isNumber = /^\d+$/.test(stopValue);
            const stopName = isNumber ? `Stop #${stopValue}` : stopValue;
            
            preview.innerHTML = `üéâ You're the first person to board at ${stopName}! (with GPS)`;
            preview.className = 'preview-box new';
            preview.style.display = 'block';
        }

        function updateRoutePreview() {
            const routeValue = routeInput.value.trim();
            const preview = document.getElementById('routePreview');
            
            if (!routeValue) {
                preview.style.display = 'none';
                return;
            }

            preview.innerHTML = `‚úÖ Found existing route: ${routeValue}`;
            preview.className = 'preview-box existing';
            preview.style.display = 'block';
        }

        function startTrip() {
            const stop = stopInput.value.trim();
            const route = routeInput.value.trim();
            
            if (!stop || !route) {
                alert('Please enter both stop and route');
                return;
            }

            getCurrentLocation((boardingLocation) => {
                const tripData = {
                    startStop: stop,
                    route: route,
                    startTime: firebase.firestore.Timestamp.now(),
                    boardingLocation: boardingLocation,
                    userId: currentUser.uid
                };

                db.collection('activeTrips').doc(currentUser.uid).set(tripData)
                    .then(() => {
                        activeTrip = { id: currentUser.uid, ...tripData };
                        
                        const locationText = boardingLocation ? 
                            `üìç GPS: ${boardingLocation.lat.toFixed(4)}, ${boardingLocation.lon.toFixed(4)}` : 
                            'üìç No GPS data';
                        
                        currentTripDiv.innerHTML = `
                            <div><strong>${route}</strong></div>
                            <div>From: ${stop}</div>
                            <div>Started: ${new Date().toLocaleTimeString()}</div>
                            <div style="font-size: 0.8em; color: #666;">${locationText}</div>
                        `;
                        
                        showActiveSection();
                        updateTripIndicator();
                        
                        stopInput.value = '';
                        routeInput.value = '';
                        document.getElementById('stopPreview').style.display = 'none';
                        document.getElementById('routePreview').style.display = 'none';
                        updateStartButton();
                        
                        startProgressiveQuestions();
                    })
                    .catch((error) => {
                        console.error('Error starting trip:', error);
                        alert('Error starting trip. Please try again.');
                    });
            });
        }

        function showEndModal() {
            endModal.style.display = 'block';
        }

        function hideEndModal() {
            endModal.style.display = 'none';
            exitInput.value = '';
        }

        function saveTrip() {
            const exitStop = exitInput.value.trim();
            
            if (!exitStop) {
                alert('Please enter exit stop');
                return;
            }

            if (!activeTrip) {
                alert('No active trip');
                return;
            }

            // Check if saving as template
            const saveAsTemplate = document.getElementById('saveAsTemplate').checked;

            // Disable the save button to prevent double-clicks
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            getCurrentLocation((exitLocation) => {
                // Handle the startTime whether it's a Firestore Timestamp or already a Date
                let startTime;
                if (activeTrip.startTime && activeTrip.startTime.toDate) {
                    startTime = activeTrip.startTime.toDate();
                } else if (activeTrip.startTime) {
                    startTime = new Date(activeTrip.startTime);
                } else {
                    startTime = new Date();
                }

                const endTime = new Date();
                const duration = Math.round((endTime - startTime) / 1000 / 60);

                const completedTrip = {
                    startStop: activeTrip.startStop,
                    endStop: exitStop,
                    route: activeTrip.route,
                    startTime: activeTrip.startTime || firebase.firestore.Timestamp.fromDate(startTime),
                    endTime: firebase.firestore.Timestamp.fromDate(endTime),
                    boardingLocation: activeTrip.boardingLocation || null,
                    exitLocation: exitLocation,
                    userId: currentUser.uid,
                    duration: duration,
                    // Include any additional data collected during the trip
                    vehicleNumber: activeTrip.vehicleNumber || null,
                    routeType: activeTrip.routeType || null,
                    direction: activeTrip.direction || null,
                    crowdLevel: activeTrip.crowdLevel || null,
                    vehicleType: activeTrip.vehicleType || null
                };

                console.log('Saving trip:', completedTrip);

                // Save the trip
                db.collection('trips').add(completedTrip)
                    .then(() => {
                        console.log('Trip saved to database');
                        
                        // Save as template if requested
                        if (saveAsTemplate) {
                            const templateData = {
                                route: activeTrip.route,
                                startStop: activeTrip.startStop,
                                userId: currentUser.uid,
                                createdAt: firebase.firestore.Timestamp.now(),
                                nickname: `${activeTrip.route} from ${activeTrip.startStop}`
                            };
                            
                            return db.collection('templates').add(templateData);
                        }
                        return Promise.resolve();
                    })
                    .then(() => {
                        return db.collection('activeTrips').doc(currentUser.uid).delete();
                    })
                    .then(() => {
                        console.log('Active trip deleted');
                        activeTrip = null;
                        progressiveQuestion.style.display = 'none';
                        hideEndModal();
                        showStartSection();
                        updateTripIndicator();
                        loadTrips();
                        loadTemplates(); // Reload templates if one was saved
                        
                        // Re-enable the save button
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Save Trip';
                        
                        // Reset template checkbox
                        document.getElementById('saveAsTemplate').checked = false;
                        
                        const locationMsg = exitLocation ? 'üìç GPS captured' : 'üìç No GPS';
                        const templateMsg = saveAsTemplate ? ' Template saved!' : '';
                        alert(`Trip saved! ${locationMsg}${templateMsg}`);
                    })
                    .catch((error) => {
                        console.error('Error saving trip:', error);
                        // Re-enable the save button on error
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Save Trip';
                        alert('Error saving trip. Please try again.');
                    });
            });
        }

        function abandonTrip() {
            if (confirm('Are you sure you want to cancel this trip? This cannot be undone.')) {
                db.collection('activeTrips').doc(currentUser.uid).delete()
                    .then(() => {
                        activeTrip = null;
                        progressiveQuestion.style.display = 'none';
                        showStartSection();
                        updateTripIndicator();
                        alert('Trip cancelled');
                    })
                    .catch((error) => {
                        console.error('Error cancelling trip:', error);
                        alert('Error cancelling trip. Please try again.');
                    });
            }
        }

        function loadTrips() {
            if (!currentUser) {
                console.log('No user logged in');
                return;
            }

            console.log('Loading trips for user:', currentUser.uid);

            db.collection('trips')
                .where('userId', '==', currentUser.uid)
                .orderBy('startTime', 'desc')
                .limit(50)
                .get()
                .then((snapshot) => {
                    console.log('‚úÖ Trips loaded:', snapshot.size);
                    
                    const trips = [];
                    snapshot.forEach((doc) => {
                        trips.push({ id: doc.id, ...doc.data() });
                    });
                    
                    displayTrips(trips);
                })
                .catch((error) => {
                    console.error('Error loading trips:', error);
                    if (tripsList) {
                        tripsList.innerHTML = '<div class="empty-state">Error loading trips. Please try again.</div>';
                    }
                });

            db.collection('activeTrips').doc(currentUser.uid)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        activeTrip = { id: doc.id, ...doc.data() };
                        showActiveTrip();
                        updateTripIndicator();
                    } else {
                        activeTrip = null;
                        showStartSection();
                        updateTripIndicator();
                    }
                });
        }

        function showActiveTrip() {
            if (!activeTrip) return;

            const startTime = activeTrip.startTime.toDate();
            const locationText = activeTrip.boardingLocation ? 
                `üìç GPS: ${activeTrip.boardingLocation.lat.toFixed(4)}, ${activeTrip.boardingLocation.lon.toFixed(4)}` : 
                'üìç No GPS data';
            
            currentTripDiv.innerHTML = `
                <div><strong>${activeTrip.route}</strong></div>
                <div>From: ${activeTrip.startStop}</div>
                <div>Started: ${startTime.toLocaleTimeString()}</div>
                <div style="font-size: 0.8em; color: #666;">${locationText}</div>
            `;
            
            showActiveSection();
        }

        function showStartSection() {
            startSection.style.display = 'block';
            activeSection.style.display = 'none';
        }

        function showActiveSection() {
            startSection.style.display = 'none';
            activeSection.style.display = 'block';
        }

        function displayTrips(trips) {
            if (trips.length > 0) {
                const streakData = calculateStreaks(trips);
                updateStreakStatus(streakData);
            } else {
                streakStatus.style.display = 'none';
            }
        }

        function updateStreakStatus(streakData) {
            if (streakData.current === 0) {
                streakStatus.style.display = 'none';
                // Update banner layout since streak is hidden
                updateTripIndicator();
                return;
            }

            streakStatus.style.display = 'block';
            
            let text = '';
            const isNarrow = activeTripBanner.style.display === 'block';
            
            if (streakData.current >= 7) {
                text = isNarrow ? `üî• ${streakData.current} day streak!` : `üî• AMAZING! ${streakData.current} day streak! You're a transit champion!`;
                streakStatus.className = 'streak-status hot-streak';
            } else if (streakData.current >= 3) {
                text = isNarrow ? `üî• ${streakData.current} days!` : `üî• Hot streak! ${streakData.current} days in a row!`;
                streakStatus.className = 'streak-status hot-streak';
            } else {
                text = isNarrow ? `‚ö° ${streakData.current} day streak` : `‚ö° ${streakData.current} day streak! Keep it going!`;
                streakStatus.className = 'streak-status';
            }
            
            streakStatus.innerHTML = `<span class="current-streak-text">${text}</span>`;
            
            // Update banner layout after showing streak
            updateTripIndicator();
        }

        // Location and Status Management
        function getCurrentLocation(callback) {
            if (!navigator.geolocation) {
                updateLocationStatus('Location not supported', 'poor');
                callback(null);
                return;
            }

            updateLocationStatus('Getting location...', 'loading');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const accuracy = Math.round(position.coords.accuracy);
                    let className, useLocation = false;
                    
                    if (accuracy <= 7.5) {
                        className = 'excellent';
                        useLocation = true;
                    } else if (accuracy <= 15) {
                        className = 'good';
                        useLocation = true;
                    } else {
                        className = 'poor';
                        useLocation = false;
                    }
                    
                    const statusMessage = useLocation ? 
                        `Location ${accuracy}m` : 
                        `Location inaccurate ${accuracy}m`;
                    
                    updateLocationStatus(statusMessage, className);
                    
                    if (useLocation) {
                        const location = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString()
                        };
                        console.log(`GPS logged: ¬±${accuracy}m accuracy`);
                        callback(location);
                    } else {
                        console.log(`GPS too inaccurate (¬±${accuracy}m), not logging location`);
                        callback(null);
                    }
                },
                (error) => {
                    console.log('Location error:', error);
                    updateLocationStatus('Location unavailable', 'poor');
                    callback(null);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 60000
                }
            );
        }

        function updateLocationStatus(message, type) {
            locationStatus.textContent = `üìç ${message}`;
            locationStatus.className = `status-indicator ${type}`;
        }

        function updateConnectionStatus(connected) {
            if (!logoutModeActive) {
                if (connected) {
                    connectionStatus.textContent = 'Logged In';
                    connectionStatus.className = 'status-indicator connected';
                } else {
                    connectionStatus.textContent = '‚ö†Ô∏è Offline';
                    connectionStatus.className = 'status-indicator disconnected';
                }
            }
        }

        // Progressive Question System
        let currentQuestionIndex = 0;
        let tripEnrichmentData = {};
        let showingMoreOptions = false;
        
        const questions = [
            {
                text: "üì± See the vehicle number?",
                type: "input",
                placeholder: "e.g., 8234, 1156",
                field: "vehicleNumber"
            },
            {
                text: "üöå What type of transit is this?",
                type: "options",
                options: ["Bus", "Subway", "Streetcar", "Light Rail", "Train", "Ferry"],
                field: "routeType"
            },
            {
                text: "üß≠ Which direction is this vehicle headed?",
                type: "options",
                mainOptions: ["Northbound", "Southbound", "Eastbound", "Westbound"],
                moreOptions: ["Downtown", "Uptown", "Inbound", "Outbound", "Clockwise", "Counterclockwise", "Uphill", "Downhill"],
                field: "direction"
            },
            {
                text: "üë• How crowded is it right now?",
                type: "options", 
                options: ["Empty", "Few passengers", "Half full", "Mostly full", "Packed", "Standing room only"],
                field: "crowdLevel"
            }
        ];

        // Conditional vehicle type questions based on route type
        const vehicleTypeQuestions = {
            "Bus": {
                text: "üöå What type of bus is this?",
                options: ["Regular bus", "Articulated bus", "Double decker", "Express bus", "Shuttle bus", "School bus"]
            },
            "Subway": {
                text: "üöá What type of subway car?",
                options: ["Single car", "2-car train", "4-car train", "6-car train", "8+ car train", "Older model", "Newer model"]
            },
            "Train": {
                text: "üöÑ What type of train?",
                options: ["Commuter train", "High-speed rail", "Regional train", "Intercity train", "Freight train"]
            },
            "Light Rail": {
                text: "üöù What type of light rail vehicle?",
                options: ["Single car", "2-car train", "3-car train", "Low-floor", "High-floor"]
            },
            "Ferry": {
                text: "‚õ¥Ô∏è What type of ferry?",
                options: ["Passenger ferry", "Car ferry", "High-speed ferry", "Catamaran", "Traditional ferry"]
            }
            // Streetcar doesn't get vehicle type question since they're pretty standard
        };

        function startProgressiveQuestions() {
            currentQuestionIndex = 0;
            tripEnrichmentData = {};
            showingMoreOptions = false;
            
            setTimeout(() => {
                showNextQuestion();
            }, 10000);
        }

        function showNextQuestion() {
            if (currentQuestionIndex >= questions.length || !activeTrip) {
                // Check if we need to ask conditional vehicle type question
                if (currentQuestionIndex === questions.length && tripEnrichmentData.routeType) {
                    const routeType = tripEnrichmentData.routeType;
                    if (vehicleTypeQuestions[routeType]) {
                        showVehicleTypeQuestion(routeType);
                        return;
                    }
                }
                progressiveQuestion.style.display = 'none';
                return;
            }

            const question = questions[currentQuestionIndex];
            questionText.textContent = question.text;
            showingMoreOptions = false;
            
            if (question.type === "options") {
                // Show option buttons
                document.getElementById('questionInputGroup').style.display = 'none';
                const questionOptionsDiv = document.getElementById('questionOptions');
                questionOptionsDiv.style.display = 'grid';
                
                let optionsHtml = '';
                
                if (question.mainOptions) {
                    // Show main options with "More" button
                    questionOptionsDiv.className = 'question-options main-options';
                    optionsHtml = question.mainOptions.map(option => 
                        `<button class="btn btn-outline btn-sm" onclick="selectQuestionOption('${option}')">${option}</button>`
                    ).join('');
                    optionsHtml += `<button class="btn btn-outline btn-sm more-btn" onclick="showMoreOptions()">More Options...</button>`;
                } else {
                    // Show all options
                    questionOptionsDiv.className = 'question-options';
                    optionsHtml = question.options.map(option => 
                        `<button class="btn btn-outline btn-sm" onclick="selectQuestionOption('${option}')">${option}</button>`
                    ).join('');
                }
                
                questionOptionsDiv.innerHTML = optionsHtml;
            } else {
                // Show input field
                document.getElementById('questionOptions').style.display = 'none';
                document.getElementById('questionInputGroup').style.display = 'block';
                questionInput.placeholder = question.placeholder;
                questionInput.value = '';
                questionInput.focus();
            }
            
            progressiveQuestion.style.display = 'block';
        }

        function showMoreOptions() {
            const question = questions[currentQuestionIndex];
            if (!question.moreOptions) return;
            
            showingMoreOptions = true;
            const questionOptionsDiv = document.getElementById('questionOptions');
            questionOptionsDiv.className = 'question-options';
            
            const allOptions = [...question.mainOptions, ...question.moreOptions];
            const optionsHtml = allOptions.map(option => 
                `<button class="btn btn-outline btn-sm" onclick="selectQuestionOption('${option}')">${option}</button>`
            ).join('');
            
            questionOptionsDiv.innerHTML = optionsHtml;
        }

        function showVehicleTypeQuestion(routeType) {
            const vehicleQuestion = vehicleTypeQuestions[routeType];
            questionText.textContent = vehicleQuestion.text;
            
            document.getElementById('questionInputGroup').style.display = 'none';
            const questionOptionsDiv = document.getElementById('questionOptions');
            questionOptionsDiv.style.display = 'grid';
            questionOptionsDiv.className = 'question-options';
            
            const optionsHtml = vehicleQuestion.options.map(option => 
                `<button class="btn btn-outline btn-sm" onclick="selectVehicleType('${option}')">${option}</button>`
            ).join('');
            
            questionOptionsDiv.innerHTML = optionsHtml;
            progressiveQuestion.style.display = 'block';
        }

        function selectVehicleType(vehicleType) {
            // Highlight selected option
            document.querySelectorAll('#questionOptions button').forEach(btn => {
                btn.style.background = btn.textContent === vehicleType ? '#667eea' : 'transparent';
                btn.style.color = btn.textContent === vehicleType ? 'white' : '#666';
            });
            
            // Auto-submit after selection
            setTimeout(() => {
                tripEnrichmentData.vehicleType = vehicleType;
                
                if (activeTrip) {
                    db.collection('activeTrips').doc(currentUser.uid).update({vehicleType: vehicleType})
                        .then(() => {
                            console.log(`Saved vehicleType: ${vehicleType}`);
                            activeTrip.vehicleType = vehicleType;
                        })
                        .catch((error) => {
                            console.error('Error updating trip:', error);
                        });
                }
                
                progressiveQuestion.style.display = 'none';
                // End of questions
            }, 500);
        }

        function selectQuestionOption(option) {
            // Highlight selected option
            document.querySelectorAll('#questionOptions button').forEach(btn => {
                btn.style.background = btn.textContent === option ? '#667eea' : 'transparent';
                btn.style.color = btn.textContent === option ? 'white' : '#666';
            });
            
            // Auto-submit after selection
            setTimeout(() => {
                const question = questions[currentQuestionIndex];
                tripEnrichmentData[question.field] = option;
                
                if (activeTrip) {
                    const updateData = {};
                    updateData[question.field] = option;
                    
                    db.collection('activeTrips').doc(currentUser.uid).update(updateData)
                        .then(() => {
                            console.log(`Saved ${question.field}: ${option}`);
                            activeTrip[question.field] = option;
                        })
                        .catch((error) => {
                            console.error('Error updating trip:', error);
                        });
                }
                
                progressiveQuestion.style.display = 'none';
                currentQuestionIndex++;
                
                setTimeout(() => {
                    showNextQuestion();
                }, 30000);
            }, 500);
        }

        function submitAnswer() {
            const question = questions[currentQuestionIndex];
            if (question.type === "input") {
                const answer = questionInput.value.trim();
                if (answer) {
                    tripEnrichmentData[question.field] = answer;
                    
                    if (activeTrip) {
                        const updateData = {};
                        updateData[question.field] = answer;
                        
                        db.collection('activeTrips').doc(currentUser.uid).update(updateData)
                            .then(() => {
                                console.log(`Saved ${question.field}: ${answer}`);
                                activeTrip[question.field] = answer;
                            })
                            .catch((error) => {
                                console.error('Error updating trip:', error);
                            });
                    }
                    
                    progressiveQuestion.style.display = 'none';
                    currentQuestionIndex++;
                    
                    setTimeout(() => {
                        showNextQuestion();
                    }, 30000);
                }
            }
        }

        function skipQuestion() {
            progressiveQuestion.style.display = 'none';
            currentQuestionIndex++;
            
            // Check if we need to ask conditional vehicle type question after skipping
            if (currentQuestionIndex >= questions.length && tripEnrichmentData.routeType) {
                const routeType = tripEnrichmentData.routeType;
                if (vehicleTypeQuestions[routeType]) {
                    setTimeout(() => {
                        showVehicleTypeQuestion(routeType);
                    }, 30000);
                    return;
                }
            }
            
            setTimeout(() => {
                showNextQuestion();
            }, 30000);
        }

        function goToActiveTrip() {
            hideAllSections();
            showActiveSection();
        }

        // App Initialization
        function initializeApp() {
            stopInput.addEventListener('input', updateStartButton);
            routeInput.addEventListener('input', updateStartButton);
            startBtn.addEventListener('click', startTrip);
            endBtn.addEventListener('click', showEndModal);
            document.getElementById('abandonBtn').addEventListener('click', abandonTrip);
            saveBtn.addEventListener('click', saveTrip);
            cancelBtn.addEventListener('click', hideEndModal);
            profileBtn.addEventListener('click', showProfile);
            statsBtn.addEventListener('click', showStats);
            mapsBtn.addEventListener('click', showMaps);
            document.getElementById('shuffleEmojiBtn').addEventListener('click', shuffleEmoji);
            
            // Progressive question event listeners
            answerBtn.addEventListener('click', (e) => {
                e.preventDefault();
                submitAnswer();
            });
            
            skipBtn.addEventListener('click', (e) => {
                e.preventDefault();
                skipQuestion();
            });
            
            // Add enter key support for question input
            questionInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitAnswer();
                }
            });
            
            loadTrips();
            loadTemplates();
            getCurrentLocation(() => {});
            
            // Monitor connection status
            window.addEventListener('online', () => updateConnectionStatus(true));
            window.addEventListener('offline', () => updateConnectionStatus(false));
            updateConnectionStatus(navigator.onLine);
        }

        console.log('üéâ TransitStats fully loaded and ready!');
    </script>
</body>
</html>
