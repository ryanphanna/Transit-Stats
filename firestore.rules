rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Profiles - users can read/write their own profile
    match /profiles/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Trips - users can read/write their own trips
    match /trips/{tripId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // Templates - users can read/write their own templates
    match /templates/{templateId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // Phone numbers - only cloud functions can read/write (admin SDK)
    match /phoneNumbers/{phoneNumber} {
      allow read, write: if false;
    }

    // SMS state - only cloud functions can read/write (admin SDK)
    match /smsState/{phoneNumber} {
      allow read, write: if false;
    }

    // SMS verification - only cloud functions can read/write (admin SDK)
    match /smsVerification/{phoneNumber} {
      allow read, write: if false;
    }

    // Mail queue - only cloud functions can write (for sending emails)
    match /mail/{mailId} {
      allow read, write: if false;
    }

    // Stops collection - authenticated users can read and create
    match /stops/{stopId} {
      allow read: if request.auth != null;
      allow write: if false; // Only Admin SDK (cloud functions) can write
    }

    // Rate limits - only cloud functions can read/write
    match /rateLimits/{phoneNumber} {
      allow read, write: if false;
    }

    // Unknown numbers tracking - only cloud functions can read/write
    match /unknownNumbers/{phoneNumber} {
      allow read, write: if false;
    }

    // Allowed users whitelist - only cloud functions can write
    // Data model: { email: string, isAdmin: boolean }
    // Users can read to check whitelist status and admin privileges
    // Write operations must be done via Admin SDK only
    match /allowedUsers/{email} {
      allow read: if request.auth != null;
      allow write: if false;
    }
  }
}
